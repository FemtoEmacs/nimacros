\documentclass[a4paper,12pt]{book}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{menukeys}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[T1]{fontenc}
\usepackage{upquote}
\usepackage{wrapfig}
\usepackage{makeidx}
\usepackage{tikz, pgf}
\usepackage{listing}
\usepackage{fancyvrb}


\usetikzlibrary{backgrounds, positioning, %% Draw Y-chart
snakes, fit,                            %% Draw Y-chart
3d,  arrows, automata, shapes.gates.logic.US,
shapes.gates.logic.IEC, calc, 
circuits.logic.US}
\usepackage{circuitikz}

\newsavebox{\fmbox}
\newenvironment{fmpage}[1]
           {\begin{lrbox}{\fmbox}\begin{minipage}{#1}}
           {\end{minipage}\end{lrbox}\fbox{\usebox{\fmbox}}}

\addto\captionsenglish{\renewcommand{\figurename}{Listing}}

\makeindex

\title{An introduction to femtolisp\\
{\normalsize (Content not checked for spelling errors)}}
\author{Eduardo Costa \and Vernon Sipple}
\date{}

\begin{document}
\maketitle
\thispagestyle{empty}

\frontmatter

\chapter*{Preface}

Femto is a tiny Emacs clone,
originally derived from a minimalist
editor called Atto. Although built
upon the C Atto codebase, Femto can
be customized using the femtolisp Scheme dialect.

The fundamental paradigm of Emacs is that it
rests on a small core, but can be
extended and customized through
the Lisp programming language.

Istead of requiring from the programmer a compile,
build, test and fix cycle ---
Lisp offers a Read, Eval, Print Loop (REPL).
\begin{enumerate}
\item {\bf Read.} The REPL reads
a symbolic expression 
such as \verb|(+ 42 13 4)| from
a text terminal. The symbolic expression -- sexpr --
always has the form: $(\textrm{operation}\;a_1\;a_2\ldots a_n)$,
where $a_1$, $a_2$\ldots $a_n$ are the arguments of
the operation.
\item {\bf Eval.} The compiler translates the symbolic
expression to machine language, then executes the
generated code and calculates the corresponding
value.
\item {\bf Print.} The value produced in step 2 is printed.
\item {\bf Loop.} The REPL returns to step 1.
\end{enumerate}

Since Lisp is usually compiled, it is
much faster than interpreted languages.
However, to facilitate portability,
femtolisp does not generate
native code, but compiles symbolic expressions
to a virtual machine language. As a consequence of
this choice, femtolisp is not as fast as other
Lisp dialects, such as sbcl and Racket. Notwithstanding,
it is about four times faster than Python
and forty times faster than Tiny Scheme.

The REPL approach enables fast prototyping
of extensions as each idea can be tested
individually on the command line inside
the editor with an immediate result check.

For historical reasons, the reference GNU
Emacs implementation uses a specialised version of
lisp known as Emacs Lisp.  However, the Emacs Lisp
dialect is not standard lisp, being used
only by the GNU Emacs editor and its
derivatives.

Femtolisp was chosen
as the extension language
for FemtoEmacs for the following reasons:
\begin{enumerate}
\item Femtolisp is open source.
\item Femtolisp is small and written in C.
\item After loading the \verb|r5rs.scm| library
provided in the femtoemacs distribution,
the user can bridge the syntactic gap
between femtolisp and Scheme.
In the majority of situations, the \verb|r5rs.scm|
library is compatible
with the standard Scheme dialect. This means that
one can use classical Scheme tutorials to learn
how to configure and customize femtoemacs.
The Structure and Interpretation of Computer Programs
is the most popular of these tutorials.
Of course, you can use the content of the
present text to the same effect.
\item Femtolisp is fast.
\end{enumerate}    

\mainmatter


\chapter{Femtoemacs commands}
In the next chapter, you will learn how to install
femtoemacs. To give you a head start, this chapter
lists the basic commands you need to edit a file.

In the following cheat sheet, \verb|Spc| denotes
the space bar, \verb|C-| is the \keys{Ctrl} prefix, \verb|M-| represents 
the  \keys{Alt} prefix and  $\kappa$ can be any key. 

\paragraph{Basic commands.} \verb|C-|$\kappa$ -- Press and release \keys{Ctrl}
and \keys{$\kappa$} simultaneously
\begin{quote}
 \verb|C-s| then type some text, and press \verb|C-s| again 
  -- search a text.\\
 \verb|C-r| then type some text, and press \verb|C-r| again 
  -- reverse search.\\
 \verb|C-k| -- kill a line.\\
 \verb|C-h| -- backspace.\\
 \verb|C-d| -- delete char forward.\\ 
 \verb|C-Spc| then move the cursor -- select a region.\\
 \verb|M-w| -- save selected region into the kill ring. \\
 \verb|C-w| -- kill region.\\
 \verb|C-y| -- insert killed or saved region.\\
 \verb|C-g| -- cancel minibuffer reading.\\
 \verb|C-a| -- go to beginning of line.\\
 \verb|C-e| -- go to end of line.\\
 \verb|C-b| -- move backward one character.\\
 \verb|C-f| -- move forward one character.\\
 \verb|C-n| -- move cursor to the next line.\\
 \verb|C-p| -- move cursor to the previous line.\\
 \verb|C-l| -- refresh screen.\\
 \verb|C-u| -- undo. \\
 \verb|C-v| -- forward page.\\
 \keys{INS} -- toggle overwrite mode.\\
 \keys{$\leftarrow$} \keys{$\rightarrow$} \keys{$\uparrow$} \keys{$\downarrow$} -- arrows move cursor.\\
\end{quote}
\paragraph{Control-x commands.} \verb|C-x C-|$\kappa$ -- Keep \keys{Ctrl}
down and press \keys{x} and  \keys{$\kappa$}
\begin{quote}
  \verb|C-x C-f| -- open a file into a new buffer.\\
  \verb|C-x C-w| -- write file with new name.\\
\verb|C-x C-s| -- save file.\\
\verb|C-x C-c| -- exit femto.\\
\verb|C-x i| -- insert file at the cursor.\\
\verb|C-x ?| -- describes a key stroke.\\
\verb|C-x @| --  shell command. After \verb|C-x @|,
if one types \verb|ls| at the prompt, the computer
will list the current folder.
It is possible to use any other shell command
just like the \verb|ls| example.
\end{quote}



\paragraph{Window commands.} One can have more
than one window on the screen. Below, you will
find commands that cope with this situation.
\begin{itemize}
\item \verb|C-x |$\kappa$ -- Press and release \keys{Ctrl}
and \keys{x} together, then press \keys{$\kappa$} 
\begin{quote}
\verb|C-x n| -- next buffer.\\
\verb|C-x C-n| -- next buffer. Same as above.\\  
\verb|C-x C-b| -- list buffers.\\
\verb|C-x k| -- kill current buffer.\\
\verb|C-x =| -- cursor position.\\
\verb|C-x 2| -- split window into cursor window and other window.\\
\verb|C-x o| -- jump to the other window.\\
\verb|C-x 1| -- close the other window.\\
\verb|C-x 0| -- close the cursor window.
\end{quote}
\item \verb|Esc| $\kappa$ -- Press and release the \keys{Esc} key,
then press the \keys{$\kappa$} key.
\begin{quote}
\verb|Esc >| -- go to the end of buffer.\\
\verb|Esc <| -- go to the beginning of buffer.\\ 
\verb|Esc f| -- word forward.\\
\verb|Esc b| -- word backward.\\
\end{quote}
\item \verb|M|-$\kappa$ -- Keep the \keys{Alt} key
down and press the \keys{$\kappa$} key.
\begin{quote}
\verb|M-b| -- move backward one word.\\
\verb|M-f| -- move forward one word.\\
\verb|M-g| -- go to the line given in the minibuffer.\\
\verb|M-n| -- activate the next buffer.\\
\verb|M-r| -- query replace.
\end{quote}
\end{itemize}

\paragraph{Query replace.} If you press \keys{Esc}\keys{r},
the computer enters in the query replace mode.
First, femtoemacs prompts for the text snippet S
that you want to replace. Then it prompts for
the replacement R. When you type the R text and
press the \keys{Enter} key, the cursor jumps to
the first occurence of S, and femtolisp
asks whether you want to
replace it. If the answer is
\verb|y|, femtolisp will replace S
with \verb|R| and jump to the next occurence.
If the answer is \verb|n|, femtolisp will
jump to the next occurrence of S without
performing the replacement.

\paragraph{Go to line.} When you try to compile
code containing errors, the compiler
usually reports the line number where the error occurred.
If you press \keys{Esc}\keys{g}, femtoemacs
prompts for a line number. As soon as you
type the number and press the \keys{Enter}
key, the cursor jumps to the line where the
error occurred.

In order to know the position of the cursor,
press the \verb|C-x =| command,
and femtoemacs gives information concerning
the character under the
cursor, the corresponding code, the line,
and the character position in the text.

\paragraph{List bindings.} If you press
the \keys{Esc}\keys{$l$} command, the computer
lists all femtoemacs commands. Then you
can check whether I forgot a keybinding or
another in this tutorial. By the way,
the \keys{$l$} corresponds to the lowercase L
letter. This means that you must press
and release the \keys{Esc} key, then
strike the lowercase L key.

\paragraph{Nia Vardalos.}
In order to get acquainted with editing and scripting,
let us accompany the Canadian programmer Nia
Vardalos, while she explores femtoemacs.

When text is needed for carrying out a command,
it is read from the minibuffer, a one line
window at the bottom of the screen. For instance, 
if Nia presses \verb|C-s| for finding a text, 
the text is read from the minibuffer. After
typing the text that she wants to localize,
Nia presses \verb|C-s| again to start the search.
For abandoning an ongoing command, she may press \verb|C-g|.

To transport a region from one place to another,
Nia presses \verb|C-Spc| to start
 the selection process 
 and move the cursor to select the region. 
 Then she presses \verb|C-w| to
kill her selection. Finally, she moves
the cursor to the insertion place,
and presses the \verb|C-y| shortcut.

To copy a region, Nia presses \verb|C-Spc| and moves the cursor to select the region.
Then she presses \verb|M-w| to save the selection into the kill ring. Finally,
she takes the cursor to the destination where the copy is to be inserted and
issues the \verb|C-y| command.

Nia noticed that there are two equivalent ways to
issue an \verb|M-|$\kappa$ command. She can
press and release the \keys{Esc} key, then
strike the  $\kappa$ key. Alternatively, she
can keep the \keys{Alt} key down and press
the \keys{$\kappa$} key.

\paragraph{Calculations with Lisp.} Femtoemacs
offers a Lisp dialect to perform calculations
and text processing. Let us assume that you
want to find how many students graduate
from medical schools in California. You
press \keys{Esc}\keys{;} and femtoemacs
will prompt you for a Lisp expression.
\begin{quote}
\verb|> (+ 190 180 170 160 120 100 100 90)|\keys{Enter}
\end{quote}
In the above expression, the first thing after
the open parenthesis is the \verb|+| sum
operation identifier. After the name of
the operation, there is a list of
the arguments to be added together.
As soon as Nia presses the \keys{Enter} key,
femtoemacs shows the result of the addition:
\begin{quote}
\verb|1110|
\end{quote}
The rule that worked for 
the $\verb|(+ | x_1\;x_2\ldots\verb|)|$
sum operation also works for the 
other arithmetic function too.
\begin{itemize}
  \item{Multiplication} is performed
by the \verb|*| operation.
\begin{quote}
\keys{Esc}\keys{;}\\
\verb|> (* 1 2 3 4 5)|\keys{Enter}\\
120
\end{quote}
\item{Division} is obtained through the \verb|/| operation.
\begin{quote}
\keys{Esc}\keys{;}\\
\verb|> (* 1 2 4)|\keys{Enter}\\
0.125
\end{quote}
The above operation performed the chain
division \verb|1/2/3|.
\item{Subtraction} has the syntax shown below.
\begin{quote}
\keys{Esc}\keys{;}\\
\verb|> (- 1 2 4)|\keys{Enter}\\
-5
\end{quote}
\item Mixed operations. One can nest subexpressions
  within an outer expression. For instance,
  to get the average student number graduating
  from medical school in California, one can
  calculate the expression:
\begin{quote}
\keys{Esc}\keys{;}\\
\verb|> (/ (+ 190 180 170 160 120 100 100 90) 8)|\keys{Enter}
\end{quote}

\end{itemize}


\chapter{Installation}  
A text editor, like Emacs or femto, has three components:
\begin{enumerate}
\item A frontend that inserts characters into a buffer.
A buffer is a memory region with an image of a
text file. One can see the buffer as a representation
of a scratch pad. As such, the frontend provides tools to
insert keystrokes at the  point indicated by 
a movable cursor.
\item Editing operations that save buffers
as files, delete and insert text, move the
cursor around, copy items from one place to another, etc.
\item A scripting language for customizing the editor.
\end{enumerate}

There is a large choice of frontends. Some frontends 
work with a raster graphics image, which  is a dot matrix 
data structure that represents a grid of pixels. 
There are also frontends that are specialized in
showing letters and other characters via an appropriate
display media. The latter sort of frontend is called
text-based user interfaces, while the former is called
graphical user interface, or GUI for short.

Text-based user interfaces are more
confortable on the eyes, since they  provide
sharper and crisp alphabetical letters.
On the other hand, GUI allows for font 
customization. At present,
femtoemacs offers only ncurses, which
is a text-based user interface.
Therefore, download the most recent version 
from the distribution site:
\verb|https://www.gnu.org/software/ncurses/|

\includegraphics[scale=0.6]{figs-prefix/download.jpg}


\paragraph{MAC OS-X.}
Unpack and make the distribution archive as shown below:
\begin{quote}
\begin{verbatim}
~$ tar xfvz ncurses-6.0.tar.gz
~$ cd ncurses-6.0/
~/ncurses-6.0$ ./configure --enable-widec
~/ncurses-6.0$ make
~/ncurses-6.0$ sudo make install
\end{verbatim}
\end{quote}
Femto assumes that  \verb|libncursesw.a|
resides in the following folder:
\begin{quote}
\begin{verbatim}
/usr/local/lib/libncursesw.a 
\end{verbatim}
\end{quote}
Therefore, copy the \verb|libncursesw.a| file
to \verb|/usr/local/lib/| as shown below:
\begin{verbatim}
~/$ cd ncurses-6.0 
~/ncurses-6.0$ cd lib 
~/ncurses-6.0/lib$ sudo cp libncursesw.a /usr/local/lib/
\end{verbatim}

After installing libncursesw, enter the folder \verb|Femto-Emacs/|
and build the editor for Macistosh:
\begin{verbatim}
~/$ cd ~/Femto-Emacs/ 
~/Femto-Emacs$ make -f Makefile.macosx
~/Femto-Emacs$ sudo make -f Makefile.macosx install
\end{verbatim}
The sudo application will ask for the password that
permits storing \verb|femto| and \verb|femto.boot|
into the \verb|/usr/local/bin/| folder.

\paragraph{Linux.} Use apt-get to install the
latest version of \verb|libncursesw5-dev|.
Since Linux repositories are usually old,
download a recent source distribution of ncurses,
build it, and install it on top of the
apt-get version, thus:
\begin{verbatim}
~$ sudo apt-get install libncursesw5-dev
~$ wget http://ftp.gnu.org/gnu/ncurses/ncurses-6.0.tar.gz
~$ tar xfvz ncurses-6.0.tar.gz
~$ cd ncurses-6.0/
~/ncurses-6.0$ ./configure --enable-widec
~/ncurses-6.0$ make
~/ncurses-6.0$ sudo make install
\end{verbatim}
After installing ncursesw, you can make the editor:
\begin{verbatim}
~/$ cd ~/Femto-Emacs/ 
~/Femto-Emacs$ make
~/Femto-Emacs$ sudo make install 
\end{verbatim}


\section{Ready}
You are now ready for action!

\includegraphics{figs-prefix/readyforaction.jpg}

It seems that people prefer money to sex.
After all, almost everybody says no to
sex on one occasion or another.
But I have never seen a single
person refusing money. Therefore, let us
start this tutorial talking about money.

If one wants to calculate a running
total of bank deposits, she will make
a column of numbers and perform the
addition.

\index{Arithmetic!Elemetary School}  
\begin{wrapfigure}[10]{i}{5cm}
\renewcommand\figurename{Fig.}
\includegraphics[scale=0.5]{figs-prefix/firemen.png}
\caption{Running total}
\end{wrapfigure}
What I mean to say is that, if you
need to perform the addition
$8 + 26 + 85 + 3$ with pencil and paper,
you will probably stack the numbers the
same way you did before taking pre-algebra
classes in highschool:
\begin{quote}
\begin{tabular}{p{0.5cm}p{1cm}}
+ &\verb|  8|\\
&\verb| 26|\\
&\verb| 85|\\
&\verb|  3|\\
\hline
&\verb|122|
\end{tabular}
\end{quote}
Subtraction is not treated differently:
\begin{quote}
\begin{tabular}{p{0.5cm}p{1.5cm}}
\Large\bf -&   358\\
&   216\\
\hline
& 142
\end{tabular}
\end{quote}

This chapter contains an introduction to
the Cambridge prefix notation, 
which is slightly different from the one you
learned in elementary school: The operation
and its arguments are put between parentheses.
In doing so, one does not need to draw a line
under the bottom number, as you can see below:
\begin{quote}
\begin{tabular}{p{0.5cm}p{1cm}}
(+ &\verb|  8|\\
&\verb| 26|\\
&\verb| 85|\\
&\verb|  3|)\\
&\verb|122|
\end{tabular}
\end{quote}
The Cambridge prefix notation can be applied
to any operation, not only to the four arithmetic
functions. 

\section{Cambridge prefix notation}
\index{Prefix notation}
\index{Prefix notation!Cambridge}
Let us summarize what we have learned
until now. In pre-algebra, students
learn to place arithmetic operators (+, -, × and ÷)
between their operands; e.g. 347+45.
However, when doing additions and subtractions
on paper, they stack the operands.

\includegraphics{figs-prefix/stackshark.jpg}


Lisp programmers put operation and operands
between parentheses. The right parenthesis
separate the operands from the result,
instead of drawing a line under the last operand.

\includegraphics{figs-prefix/neatsum.jpg}

\section{Pictures}
Here is the story of a Texan who went on
vacation to a beach in Mexico. While he was
freely dallying with the local beauties,
unbeknowest to him a blackmailer took some
rather incriminating photos.
After a week long gallivanting, the Texan
returns to his ranch in a small town near Austin.
Arriving at his door shortly after is the blackmailer
full of bad intentions.

Unaware of any malice, the Texan allows the so
called photographer to enter and sit in front
of his desk. Without delay, the blackmailer spread
out a number of photos on the desk, along with his
demands: “For the photo in front of the hotel,
that will cost you \$~25320.00. Well, the one
on the beach that's got to be \$~56750.00.
Finally, this definitively I can't let
go for less than \$~136000.00.”

Once finished with his presentation,
the blackmailer snaps up the photos,
and looks to the Texan with a sinister
grin, awaiting his reply.

Delighted with the selection of pics,
the Texan in an ellated voice says:
“I thought I would have no recollection
of my wonderful time. I want 3 copies
of the hotel shot, half a dozen of the beach.
And the last one, I need two copies for myself,
and please, send one to my ex-wife.
Make sure you leave me your contact
details; I might need some more.

\paragraph{Mixed calculations.}
In order to calculate how much the
Texan needs to pay his supposed blackmailer,
his bookkeeper needs to perform the
following operations:
$$3\times 25320+6\times 56750 + 2\times 136000+136000$$
It should be remembered that multiplications
within an expression take priority over additions
and subtractions. The bookkeeper must therefore
calculate the first two products $3\times 25320$
and $6\times 56750$, before performing the first
addition. In the Cambridge prefix notation,
the internal parentheses pass priority over
to the multiplications.

The Texan's bookkeeper started femtoemacs
in order to visit the \verb|finance.scm|
file. The text editor creates a memory
buffer that mirrors the file contents.
By convention, the file and the buffer
have the same name.

Initially, the \verb|finance.scm| buffer
is empty, but the bookkeeper will fill it
with expressions and the corresponding
calculations. Here is how to start the
text editor:
\begin{quote}
\begin{verbatim}
~/Femto-Emacs$ femto finance.scm
\end{verbatim}
\end{quote}
Listing~\ref{texan:photos} shows what
an interaction with a femto buffer looks like.

\begin{figure}[!h]
\begin{fmpage}{0.8\textwidth}

\verb|(+  (* 3 25320)|\\
\verb|    (* 6 56750)|\\
\verb|    (* 2 136000)|\\
\verb|    136000 )|\keys{Esc}\keys{~]~}\\ 
824460
\end{fmpage}

\begin{fmpage}{0.8\textwidth}
\verb| |
\end{fmpage}
\caption{The finance.scm buffer}
\label{texan:photos}
\end{figure}

After typing an expression obeying the
Cambridge prefix notation syntax,
the bookkeeper moves the cursor to the front
of the most external right parenthesis.
To perform the calculation,
he presses and releases the
\keys{Esc} key, then presses and releases
the \keys{~]~} key. The femtolisp
interpreter inserts the result
into the buffer.
To save the buffer, the bookkeeper
keeps the \keys{Ctrl} key down,
and presses the \keys{~x~} and
\keys{~s~} keys in sequence.
To exit the
editor, he maintains the \keys{~x~}
pressed and hits the \keys{~x~}
and \keys{~c~} keys one after the other.
If there are
unsaved files, the editor warns
that modified buffers exist,
and requires confirmation before
quitting.

\section{Time value of money}
Suppose that you wanted to buy a \$ 100,000 red Ferrari,
and the forecourt salesperson in his eagerness to
close a deal gives you the following two payment options:  
\begin{itemize}
\item Pay \$ 100,000 now {\bf or}
\item pay the full \$ 100,000 after a three year grace period.
\end{itemize}

I am sure that you would choose to pay the \$ 100,000 after
three years of grace has finished, although you have the
money in a savings account waiting for a business
opportunity. But why is this? After all, you will need
to pay the debt one way or the other. However, if you
keep the money in your power during the grace period,
you can earn a few months of fuel from the interest.

You may not know for sure how much interest you
will earn in three years, but since the salesperson
is not charging you for deferring the payment,
whatever you gain is yours to keep.

Unfortunately for you, the above scenario would
more than probably not happen in real life.
The right to delay payment until some future
date is a merchandise with a price tag,
which {\em is called interest by those who
think it lawful, and usury by those who
do not} (William Blackstone's Commentaries
on the Laws of England). Therefore, unless
the salesperson is your favorite aunt,
the actual offer is like jumping into a tank
full of sharks as in the classic James Bond films.
It requires a little forethought and understanding
of how interest works, before making a decision.
Here is a more realistic real estate sales offer:

\begin{itemize}
\item \$ 100,000 now {\bf or}
\item \$ 115,000 at the end of three years.
\end{itemize}

What to do when facing an increase in price
to cover postponement of payment? The best
policy is to ask your banker how much interest
she is willing to pay you over your
granted grace period.

Since the economy performance is far
from spectacular, your banker offers you
an interest rate of 2.5\%, compound annually.
She explains that compound interest arises
when interest is paid on both the principal
and also on any interest from past years.

\section{Future value}\index{Future Value}

\includegraphics{figs-prefix/piggy.jpg}

The value of money changes with time. Therefore,
the longer you keep control of your money,
the higher its value becomes, as it can earn
interest. Time Value of Money, or TVM for short,
is a concept that conveys the idea that money
available now is worth more than the same
amount in the future.

If you have \$ 100,000.00 in a savings account
now, that amount is called {\em present value},
since it is what your investment would give you,
if you were to spend it today.

Future value of an investment is the amount
you have today plus the interest that your
investment will bring at the end of a
specified period.

The relationship between the present value
and the future value is given by the
following expression:
\begin{equation}
FV= PV\times (1+i)^n
\label{eq:future-value}
\end{equation}
where $FV$ is the future value, $PV$ is the present
value, $i$ is the interest rate divided by 100,
and $n$ is the number of periods.

\paragraph{Postponed payment.}
In the case of postponing the payment of a \$ 100,000.00 car
for 3 years, at an interest rate of 0.025, the future
value of the money would be 107,689.06; therefore,
I stongly recomend against postponing the payment.
You have learned how to calculate an expression
by pressing the \keys{Esc}\keys{~]~} command.
However, there is another way of evaluating an expression.

When you open the femtoemacs editor, there is
a one line buffer at the bottom of the screen.
If you keep the \keys{Ctrl} key pressed,
and strike the  \keys{~o~} key, the editor
will read and evaluate a Cambridge prefix
expression from the minibuffer.

\begin{figure}[!h]
\begin{fmpage}{0.8\textwidth}

\verb|(+  (* 3 25320)|\\
\verb|    (* 6 56750)|\\
\verb|    (* 2 136000)|\\
\verb|    136000 )|\keys{Esc}\keys{~]~}\\ 
824460
\end{fmpage}

\begin{fmpage}{0.8\textwidth}
\verb|> (* 100000.00 (expt (+ 1.0 0.025) 3))|\keys{Enter}\\
\verb|107689.06|
\end{fmpage}
\caption{Command from the minibuffer}
\label{future-value}
\end{figure}

\section{Compound interest}

Our Texan decides he needs a break. Thus he walks into
a New York City bank and asks for the loan officer.
He tells a story of how through his doctor's recomendation
he was taking it easy at his property in the south of
France for two whole years and for such a medical
emergency he needs a \$ 10,000.00 loan.

The loan officer said that the interest was a compound 8\%
a year, but the bank would need some collateral for the loan.

“Well, I have a 60 year old car that I like very much.
Of course, I cannot take it with me to France.
Would you accept it as collateral?”

Unsure whether or not the old car was worth the
amount of the loan, the officer summons the bank manager.
The manager inspects the vehicle that was parked on the
street in front of the bank. After a close examination,
he gives a nod of approval: “It’s a Tucker Torpedo.
Give him the loan.”

The Texan quite willingly signed his heirloom over.
An employee then drove the old car into the bank’s
underground garage and parked it. From time to time,
the employee would go, and turn over the engine, to keep
the car in good running condition, and gave it an
occasional waxing just to maintain it in pristine condition.
Two years later the Texan returned, and asked how
much he owed the bank. The loan officer started femtoemacs,
and calculated the total debt as \$ 11,664.00.

\paragraph{Interest Calculation.}
\index{Interest!Compound}
Let us follow the calculation of the value accumulated
in the first year of compound interest at a 8\% rate
over \$ 10,000.00. Press \keys{Ctrl}\keys{~o~} and
enter formula~\ref{eq:future-value} in the minibuffer:
\begin{quote}
\begin{verbatim}
> (* (expt (+ 1.0 0.08) 2) 10000)
11644.00
\end{verbatim}
\end{quote}
Observe that it was necessary to divide the
interest rate by 100, which produces 0.08.

It is possible to define an operation that
calculates formula~\ref{eq:future-value}
given the arguments \verb|fv|, \verb|i|
and \verb|n|. The definition is given
in listing~\ref{Texan:parking}.
Start the editor from a text terminal:
\begin{quote}
\begin{verbatim}
~$ mkdir financing
~$ cd financing
~/financing$ femto fvalue.scm
\end{verbatim}
\end{quote}
After typing the definition shown
in listing~\ref{Texan:parking},
you must issue the \keys{Ctrl}\keys{~x~}
\keys{Ctrl}\keys{~s~}
command to save the buffer.
In order to do this, keep the
\keys{Ctrl} key pressed down and
hit the \keys{~x~} and
\keys{~s~} keys in sequence.

In order to load the program into
femtolisp, press \keys{Ctrl}\keys{~o~}
and type \verb|(load "fvalue.scm")|
in the minibuffer, as shown in
listing~\ref{Texan:parking}.
After the loading operation,
you can press the
\keys{Ctrl}\keys{~o~} command again,
and type
\begin{quote}
\verb|(future-value 10000 8 2)|
\end{quote}
in the minibuffer.

\begin{figure}[!h]\index{define}
\begin{fmpage}{0.8\textwidth}
\begin{verbatim}
;; File: fvalue.scm

(define  (future-value pv i n)
(* (expt (+ (/ i 100.0) 1) n) 
   pv)
);;end define
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\textwidth}
\verb|(load "fvalue.scm")|\keys{Enter}\\
\verb|#<function>|\\
\verb|(future-value 10000 8 2)|\keys{Enter}\\
11644.00
\end{fmpage}
\caption{Future Value Program}
\label{Texan:parking}
\end{figure}

In listing~\ref{Texan:parking}, text
between a semicolon and the end of
a line is considered a comment.
Therefore, \verb|;; File: fvalue.scm|
is a comment. Likewise, \verb|;;end define|
is a comment. Comments are ignored by
femtolisp, and have the simple function of
helping people.

\section{Mortgage}
A man with horns, legs and tail of a goat,
thick beard, snub nose and pointed ears entered
a real estate agency, and expressed his intention
of closing a deal. People fled in all directions,
thinking that Satan himself was paying them a visit.
Deardry seemed to be the only person who remained
calm. “What a ignorant, narrow minded, prejudiced
lot! I know you are not the devil. You are the
Great God Pan! What can I do for you?”

“I would like to buy a house in London.
I know that the city is made up of 32 Boroughs
and where I buy will make an enormous difference
to price, quality of life, and chances of increase
in capital value of the property.”

“Well, Sir, with our experience you can rest
assured that you will secure your ideal property.
Firstly we must decide on what type of property
fits your needs and where you want to be. You
may consider somewhere like Fulham, Chelsea,
Knightsbridge, Kensington or Mayfair.
I have properties in all these places. ”

“Chelsea! I like the name.”

“Chelsea is arguably one of the best residential
areas in London. It has benefited from it’s close
proximity to the west end of the city and is highly
sought after by overseas buyers looking to be located
in one of the most popular areas in central London.
At the moment, I can offer you a fantastic living
space in a four bedroomed flat situated behind
King's Road. The price is £10,500,000.”

“I don't have this kind of cash with me right now,
but can get it in a few months of working in a
circus. Meanwhile, can you arrange a mortgage for me? ”

“Yes, Yes I can help arrange mortgages in all 32 Boroughs
of London. Non-residents can have mortgages up to 70\% of
the purchase price. Do you have £3,150,000 pounds for the
down payment? In mortgage agreements, down payment is
the difference between the purchase price of a property
and the mortgage loan amount.”

“I know what down payment is. And yes, I can dispose
of £3,150,000 pounds.”

“A mortgage insurance is required for borrowers with
a down payment of less than 20\% of the home's purchase
price. That is not your case. Therefore, the balance of
the purchase price after the down payment is deducted
is the amount of your mortgage. Let us write a program
in femtolisp to find out your estimated monthly payment.
The loan amount is £7,350,000 pounds. The interest rate
is 10\% a year. The length of the mortgage is 20 years.
That is the best I can do for you, I am afraid.
You are going to pay £97131.00 pounds a month for
ten years. After that, the balance of your debt
will be zero. But your visit is a surprise!”
The broker exclaimed. “ I never thought I would
ever see a true living god wanting to do property
deals in London.”

With that, Pan replied: “If property prices
were not so high, and interest rate so steep,
we would definitely be up for business more often.”

\includegraphics[scale=0.5]{figs-prefix/deuspan.jpg}

\paragraph{Loan Amortization.}
Amortization refers to the gradual reduction
of the loan principal through periodic payments.

\includegraphics{figs-prefix/agingshark.jpg}

Suppose you obtained a 20-year mortgage
for a \$ 100,000.00 principal at the interest
rate of 6\% a year. Calculate the monthly payments.

\paragraph{Amortization Formula.} Let $p$ be the
present value, $n$ the number of periods,
and $r$ be the
interest rate, i.e., the interest divided by 100.
In this case, the monthly payment for full
amortization is given by~\ref{eq:amortization}.
This formula is implemented in
listing~\ref{Pan:mortgage}.
\begin{equation}
\frac{r\times p\times(1+r)^n}{(1+r)^n - 1}
\label{eq:amortization}
\end{equation}

\begin{figure}[!h]\index{define}
\begin{fmpage}{0.9\textwidth}
\begin{verbatim}
;; File: pmt.scm

(define (pmt 
         p ;; present value
         i ;; interest 
         n ;; number of periods
         ;; optional parameters
              (r (/ i 100.0)) 
              (rn (expt (+ 1.0 r) n)) 
    );;end of parameter list
(/ (* r p rn)
 (- rn 1))
);;end of define

\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\textwidth}
\verb|(load "pmt.scm")|\keys{Enter}\\
\verb|#<function>|\\
\verb|(pmt (* 10500000.00 0.7) (/ 10.0 12) (* 20 12))|\keys{Enter}\\
70929.00
\end{fmpage}
\caption{Mortgage for a God}
\label{Pan:mortgage}
\end{figure}

You certainly noticed that the
\verb|pmt| function, defined
in listing~\ref{Pan:mortgage},
has two parameters \verb|r| and \verb|rn|,
which the user does not need
to express. Femtolisp itself
assigns \verb|(/ i 100.0)| to \verb|r|
and \verb|(expt (+ 1.0 r) n)| to \verb|rn|.

\section{Lists}
Every human and computer language
has syntax, i.e., rules for combining
components of sentences.
In general, a computer language
syntax is complex, and the programmer
must study it for years before
becomming proficient.

Lisp has the simplest syntax
of any language. All
Lisp constructions are expressed
in Cambridge prefix notation:
$\verb|(operation|\;x_1\;x_2\;x_3\ldots x_n\verb|)|$.
This means that Lisp commands,
macros, procedures and functions
can be written  as a pair of parentheses
enclosing an operation followed
by its arguments. Remember, there is no
exception to this rule.

A linked list is a representation for
a \verb|xs| sequence  in such a way
that it is easy and efficient to
push a new object to the top of \verb|xs|.
\begin{quote}
\begin{verbatim}
> (define aList '(S P Q R))
(S P Q R)
> (cons 'Rome aList)
(Rome S P Q R)
> aList
(S P Q R)
\end{verbatim}
\end{quote}
The \verb|'(S P Q R)| list of letters
is prefixed by a quotation mark because
in Lisp lists and programs have the
same syntax: The Cambridge prefix notation.
The single quotation mark
tags the list so the computer will
take it at face-value, and so not to be evaluated.

Through the repeated application of the
\verb|cons| function, one can
build lists of any length
by adding new elements to
a core.
\begin{quote}
\begin{verbatim}
> (define xs '(S P Q R))
(S P Q R)
> (cons 5 (cons 4 (cons 3 (cons 2 (cons 1 xs)) ) ))
(5 4 3 2 1 S P Q R)
> xs
(S P Q R)
\end{verbatim}
\end{quote}
In the above example, you have noted
that repeated application of nested functions
cause right parentheses accumulate
at the tail of the expression.
It is good practice in programming
to group these bunches of right parentheses
in easily distinguishable patterns.

\begin{verbatim}
> (cons 'S (cons 'P (cons 'Q '(R)) ))  ;4 right parentheses
(1 2 3)
> (+ 51 (* 9 (+ 2 (- 3 (+ 1 2 3)) ) )) ;5 right parentheses
42 
> (+ 6 (* 9 (+ 2 (- 3 (+ 4 (- 3))) ))) ;6 right parentheses
42
\end{verbatim}

Another way to create easily recognizable
patterns  is to
reorganize the expression in order
to interrupt the sequence
of right parentheses:
\begin{quote}
\begin{verbatim}
> (+ 51 (* (+ 2 (- 3 (+ 1 2 3))) 9))
42
\end{verbatim}
\end{quote}

The head of a list is its first
element. For instance, the head
of \verb|'(S P Q R)| is the
\verb|'S| element. The tail
is the sublist that comes after
the head. In the case of
\verb|'(S P Q R)|, the tail
is \verb|'(P Q R)|. Lisp has
two functions, \verb|(car xs)|
and \verb|(cdr xs)| that
selects the head and the tail
respectively.
\index{List!selector: car}
\index{List!selector: cdr}


As one can see below,
it is possible to reach any
element of a list with
a sequence of \verb|car|
and \verb|cdr|.
\begin{verbatim}
> (define xs '(2 3 4 5 6.0))
(2 3 4 5 6.0)
> xs
(2 3 4 5 6.0)
> (car xs)
2
> (cdr xs)
(3 4 5 6.0)
> (car (cdr xs))
3
> (cdr (cdr xs))
(4 5 6.0)
> (car (cdr (cdr xs)))
4
> (car (cdr (cdr (cdr xs)) ))
5
> (car (cdr (cdr (cdr (cdr xs)) ) ))
6.0
\end{verbatim}

\section{Going through a list}\label{sec:average}
In listing~\ref{going-through-a-list},
the \verb|avg| function can be used to
calculate the average of a list of numbers.
It reaches all elements of the list
through successive applications
of  \verb|(cdr s)|.
The list elements are accumulated in
\verb|acc|,
while the \verb|n| parameter counts
the number of \verb|(cdr s)| applications.
When  \verb|s| becomes empty, the \verb|acc|
accumulator contains the sum of \verb|s|, and \verb|n|
contains the number of elements. The average
is given by \verb|(/ acc n)|. 

In order to fully understand the workings
of the \verb|avg| function, we should have
waited for the introduction to the \verb|cond-form|
given on page~\pageref{page:cond-form}.
The only reason for presenting
a complex definition like \verb|avg|
so early in this tutorial is
to show a grouping pattern of five
right parentheses. As was discussed
previously, when the number of close
parentheses is greater than 3, good
programmers distribute these into small
groups, so that an individual who is
trying to understand the program
can see that the expression is
proprely closed at a glance.

\paragraph{For the impatient learner.}
However, for the sake of the impatient reader,
let us give a preview on
how the cond-form works.

\index{Predicates!null?}
\begin{figure}[!h]
\begin{fmpage}{0.9\textwidth}
\begin{verbatim}
(define (avg s (acc 0) (n 0))
(cond ( (and (null? s) (= n 0)) 0)
     ( (null? s) (/ acc n) )
     (else (avg (cdr s) 
                (+ (car s) acc) 
                (+ n 1.0)) ) ))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\textwidth}
\verb|(load "average.scm")|\keys{Enter}\\
\verb|#<function>|\\
\verb|(avg '(3 4 5 6))|\keys{Enter}\\
4.5
\end{fmpage}
\caption{Going through a list}
\label{going-through-a-list}
\end{figure}

\index{Conditional execution!cond}
The cond-form consists of a sequence
of clauses. In a function definition,
a clause has two components: A condition
and an expression. The value of the
cond-form will be given in the first
clause that has a true condition.
A concrete example will make this
statement clear. In the case of
listing~\ref{going-through-a-list},
the clauses are:
\begin{enumerate}
\item \verb| ( (and (null? s) (= n 0)) 0)| --
The condition \verb|(null? s)| will be true
when \verb|s| is the empty \verb|'()| list.
If the user types \verb|(avg '())|,
the \verb|(null? s)| expression is true, and \verb|n| is
equal to 0. The condition
\verb|(and (null? s) (= n 0))| is true, and the cond-form
returns 0.
\item \verb|( (null? s) (/ acc n) )| -- This clause
will be activated when the \verb|s| list is
\verb|'()| empty, but \verb|n| is greater than
0. If \verb|n| were 0, the first clause
would prevent the evaluator from
reaching the second clause. The only
way to reach the second clause is to go through
the list by repeatedly evaluating the third clause.
The value of the second clause is \verb|(/ acc n)|,
which is the average of the list.
\item \verb|(else (avg (cdr s) (+ (car s) acc) (+ n 1.0)) )| --
This clause will be evaluated
when none of the previous conditions are true.
If the user executes the \verb|(avg '(3 4 5 6))|
expression, the evaluator will visit this
clause with \verb|s= (3 4 5 6)|, \verb|s= (4 5 6)|,
\verb|s= (5 6)| and \verb|s= (6)|.
Every time the evaluator falls into the third
clause, \verb|(cdr s)| is executed, and \verb|s|
looses an element.
\end{enumerate}

\paragraph{The third clause.}
Let us follow the evaluation of \verb|(avg '(3 4 5 6))|
as it repeatedly  descends through the cond-form conditions
until it reaches the third clause.

\begin{itemize}
\item\verb|(avg '(3 4 5 6))|
goes to the else-clause, that will call:
\begin{quote}
\verb|(avg (cdr s) (+ (car s) acc) (+ n 1))|
\end{quote}
with
\verb|s= (3 4 5 6)|, \verb|acc= 0|
and \verb|n= 0|. Since:
\begin{quote}
\verb|(cdr s)= (4 5 6)|,
\verb|(+ (car s) acc)= 3| and
\verb|(+ n 1)= 1|,
\end{quote}
the else-clause expression reduces to
\verb|(avg '(4 5 6) 3 1)|.
\item\verb|(avg '(4 5 6) 3 1)| goes to the
else-clause again, that calls:
\begin{quote}
\verb|(avg (cdr s) (+ (car s) acc) (+ n 1))|
\end{quote}
with \verb|s= (4 5 6)|, \verb|acc= 3| and \verb|n= 1|.
Since:
\begin{quote}
\verb|(cdr s)= (5 6)|,
\verb|(+ (car s) acc)= 7| and
\verb|(+ n 1)= 2|,
\end{quote}
the else-clause expression reduces to
\verb|(avg '(5 6) 7 2)|.
\item \verb|(avg '(5 6) 7 2)| visits 
the else-clause once more:
\begin{quote}
\verb|(avg (cdr s) (+ (car s) acc) (+ n 1))|
\end{quote}
with \verb|s= (5 6)|, \verb|acc= 7| and \verb|n= 2|.
Since:
\begin{quote}
\verb|(cdr s)= (6)|,
\verb|(+ (car s) acc)= 12| and
\verb|(+ n 1)= 3|,
\end{quote}
the else-clause expression reduces to
\verb|(avg '(6) 12 3)|.
\item\verb|(avg '(6) 12 3)| evaluates the
expression
\begin{quote}
\verb|(avg (cdr s) (+ (car s) n) (+ n 1))|
\end{quote} 
for the fourth time, which calls \verb|(avg '() 18 4)|.
\item \verb|(avg '() 18 4)|  maches
the \verb|(null? s)| clause, that calculates the
averaging \verb|(/ acc n)| expression
with \verb|acc= 18| and \verb|n= 4|.
\end{itemize}



\chapter{Shell}
\index{Shell}
Nia, a Greek young woman, has an
account on a well known social network.
She visits her friends' postings on a daily basis,
and when she finds an interesting picture or video,
she presses the {\em Like}-button. However, when
she needs to discuss her upcoming holidays on the Saba Island
with her Argentinian boyfriend, she uses the
live chat box. After all, hitting buttons and
icons offers only a very limited interaction tool,
and does not produce a highly detailed
level of information that permits the answering
of questions and making of statements.


Using a chat service needs to
be very easy and fun, otherwise all those teenage
friends of Nia's would be doing something else.
I am telling you this, because there are
two ways of commanding a computer.
The first is called Graphical User Interface (GUI)
and consists of moving the cursor with a
mouse or other pointing device and clicking
over a menu option or an icon,
such as the {\em Like} button.
As previously mentioned, a Graphical User Interface
often does not generate adequate information
for making a request to the computer. In addition,
finding the right object  to press
can become difficult in a labyrinth of
menu options.

The other method of interacting with
the computer is known as Shell and is similar to
a chat with one's own machine.

In your computer, there is a giant
program, called the operating system, which controls
all peripherals that the machine uses to
stay connected with the external world:
pointing devices,  keyboard,
video terminal, robots, cameras, solid
state drives, pen drives, and other peripherals.

In a Shell interface, Nia issues written instructions
that the operating system answers by fulfilling the
assigned tasks. The language that Nia
uses to chat with the operating
system is called {\em Bourne-again shell}, or
bash for short. This language has
commands to go through folders, browser
files, create new directories, copy
objects from one place to the other,
configure the machine, install
applications, change the permissions
of a file, create groups to organize
users and devices, etc.
When accessing the operating system through
a text-based terminal, a shell language is the main way
of executing programs and doing work on a computer.

The shell interface derives its name from
the fact that it acts like a shell
surrounding all other programs being run,
and controlling everything the machine performs.

To make a long story short,
it is much faster to complete tasks
using a shell than with graphical applications,
icons, menus and mouse. Another benefit of the
shell is that you can gain access to many
more commands and scripts than with
a Graphical User Interface.

In order not to scare off the feeble-minded,
many operating systems hide access
to the text terminal. In some distribution
of Linux, you need to maintain the \keys{Alt} key
down, then press the \keys{F2} key to open a
dialog box, where you must type the
name of the terminal you want to open.
If you are really lucky, you may find
the icon of the terminal  on the
toolbar.

\includegraphics[scale=0.8]{figs/terminal.png}

If the way of opening the text terminal
is not obvious, you should ask for help
from a student majoring in Computer Science.
You can teach her Russian, Samskrit, Javanese
or Ancient Greek, as a compensation
for the time that she will spend explaining
how to start a terminal in 
OS X or Linux. If you are afraid
of paying for a few minutes of tutorial
about the Bourne-again shell
with hundred hours of classes on
Russian, don't worry! The CS
major will give up after barely
starting the section on the alphabet. After all,
Philology is much more difficult
than Computer Engineering.
For details, read the tale ``The man who could speak
Javanese'' by Lima Barreto.

\paragraph{The prompt.}\index{Shell!prompt} 
The shell prompt
is where one types commands. The prompt
has different aspects, depending on the
configuration of the terminal.
In Nia's machine, it looks something like this:
\begin{quote}
\verb|~$ _|
\end{quote}
Files are stored in folders. Typically, the
prompt shows the folder where the user is
currently working.

The main duty of the
operating system is to maintain the contents of
the mass storage devices in a tree structure
of files and folders.
Folders are also called {\em directories},
and like physical folders or cabinets,
they organize files.

A folder can be put inside another folder.
In a given machine, there is a folder 
reserved for duties carried out by the
administrator.
This special folder is called home
or personal directory.

Besides the administrator, a machine can
have other rightful users, each with
a personal folder. For instance, Nia's folder
on her Mac OS X has the \verb|/Users/nia|
path. You will learn a more formal
definition of path later on.


\paragraph{pwd \#}\index{Shell!pwd} 
The \verb|pwd| command informs
the user's position in the file tree.
A folder can be placed
inside another folder.
For example, in a Macintosh, Nia's home
folder is inside the \verb|/Users| directory.

One uses a path to identify
a nest of folders. In a path, a subfolder
is separated from the parent folder
by a slash bar. If one needs to know
the current folder, there is the \verb|pwd|
command. 
\begin{quote}
\verb|~$ pwd         # shows the current folder. |\keys{Enter}\\
\verb|/Users/nia|\\
\end{quote}
When Nia issues a command, she may
add comments to it, so her boyfriend that
does not know Bourne-again shell (bash)
can understand what
is going on and learn something in
the process. Comments are prefixed
with the \verb|#| hash char, as you
can see in the above chat. Therefore,
when the computer sees a \verb|#|
hash char, it ignores everything to
the end of the line.

\paragraph{mkdir wrk \#}\index{Shell!mkdir}
creates a \verb|wrk|
folder inside the current directory,
where \verb|wrk| can be replaced
with any other name.
For instance, if Nia is inside her
home directory, \verb|mkdir wrk| creates
a folder with the \verb|/Users/nia/wrk| path.

\paragraph{cd wrk \#}\index{Shell!change dir} 
One can use the
\verb|cd <folder name>| commands to enter
the named folder.
The \verb|cd ..|  command
takes Nia to the parent of the current
directory.
Thanks to the \verb|cd|
command, one can navigate through the
tree of folders and directories.

\paragraph{Tab.}\index{Shell!tab} If you want to go
to a given directory, type part of the directory
path, and then press \keys{Tab}.
The shell will complete the folder name for you.

\paragraph{Home directory.}\index{Home directory} One
can use a \verb|~| tilde to represent
the home directory. For instance,
\verb|cd ~| will send Nia to her
personal folder. The \verb|cd $HOME| has
the same effect, i.e., it places Nia inside
her personal directory.

\paragraph{echo \#}\index{Shell!echo} One can use the
\verb|echo| command to print something.
Therefore, \verb|echo $HOME| prints
the contents of the \verb|HOME|
environment variable on the terminal.

Environment variables store
the terminal configuration. For instance,
the \verb|HOME| variable contains
the user's personal directory identifier.
One needs to prefix the environment
variable with the \verb|$| char
to access its contents. Therefore,
\verb|echo $HOME| displays the
contents of the \verb|HOME| variable.

The instruction \verb|echo "Work Space" > readme.txt|
creates a \verb|readme.txt| text file and
writes the \verb|"Work Space"| string there.
If the \verb|readme.txt| file exists,
this command supersedes it.

The command \verb|echo "Shell practice" >> readme.txt|
appends a string to a text file. It does
not erase the previous content of
the \verb|readme.txt| file. Of course,
you should replace the string or the
file name, as necessity dictates.


Below you will find
an extended example of a chat between Nia and
the OS X operating system.
\begin{quote}
\verb|~$ mkdir wrk   # creates a work space folder      | \keys{Enter}\\
\verb|~$ cd wrk      # transfers action to the wrk file | \keys{Enter}\\
\verb|~/wrk$ echo "* Work space" > readme.txt | \keys{Enter}\\
\verb|~/wrk$ echo "This folder is used" >> readme.txt |\keys{Enter}\\
\verb|~/wrk$ echo "to practice the bash" >> readme.txt | \keys{Enter}\\
\verb|~/wrk$ echo "commands and queries." >> readme.txt | \keys{Enter}\\
\verb|~/wrk$ ls      # list files in current folder. | \keys{Enter}\\
\verb|readme.txt |\\
\verb|~/wrk$ cat readme.txt  # shows the file contents.| \keys{Enter}
\begin{verbatim}
* Work space
This folder is used
to practice the bash
commands and queries.
\end{verbatim}
\end{quote}

\paragraph{ls \#}\index{Shell!ls} 
By convention, a file name has
two parts, the id and the extension. The id
is separated from the extension by a dot.
The \verb|ls | command lists all files
and subfolders present in the current folder.
The \verb|ls *.txt| prints only files
with the \verb|.txt| extension.

\paragraph{Wild card.}\index{Shell!wild card} The 
\verb|*.txt| pattern
is called wild card.
In a wild card, the \verb|*| asterix matches
any sequence of chars, while the \verb|?|
interrogation mark matches a single char.

\paragraph{ls -lia *.txt \#} prints detailed
information about the \verb|.txt| files,
like date of creation, size, etc.
\begin{quote}
\verb|~/wrk$ ls -la |  \keys{Enter}
\end{quote}
\begin{verbatim}
total 8
drwxr-xr-x    3 edu500ac  staff    102 Sep 18 16:29 .
drwxr-xr-x+ 321 edu500ac  staff  10914 Sep 18 14:40 ..
-rw-r--r--    1 edu500ac  staff     74 Sep 18 16:30 readme.txt
\end{verbatim}

Files starting with a dot are called hidden files,
due to the fact that the \verb|ls| command does not
normally show them. All the same,
the \verb|ls -a| option includes the
hidden files in the listing.

\index{Permissions}
In the preceding examples, the first character
in each list entry is either a dash (-) or the letter d.
A dash (-) indicates that the file is a regular file.
The letter d indicates that the entry is a folder.
A special file type that might appear in a
\verb|ls -la| command is the symlink. It begins
with a lowercase l, and points to another location
in the file system.
Directly after the file classification comes the permissions,
represented by the following letters:
\begin{itemize}
\item r -- read permission.
\item w -- write permission.
\item x -- execute permission.
\end{itemize}

\paragraph{cp readme.txt lire.txt \#}\index{Shell!cp} 
makes a copy
of a file. You can copy a whole directory
with the \verb|-rf| options, as shown below.
\begin{quote}
\begin{verbatim}
~/wrk$ ls
readme.txt
~/wrk$ cp readme.txt lire.fr
~/wrk$ ls
lire.fr  readme.txt
~/wrk$ cd ..
~$ cp -rf wrk wsp
~$ cd wsp/
~/wsp$ ls
lire.fr  readme.txt
\end{verbatim}
\end{quote}

\paragraph{rm lire.txt \#}\index{Shell!rm} 
removes a file.
The \verb|-rf| option 
removes a whole folder.
\begin{quote}
\begin{verbatim}
~/wsp$ ls
lire.frreadme.txt
~/wsp$ rm lire.fr
~/wsp$ ls
readme.txt
~/wsp$ cd ..
~$ ls wrk
lire.frreadme.txt
~$ rm -rf wrk
~$ ls wrk
ls: wrk: No such file or directory
\end{verbatim}
\end{quote}

\paragraph{mv wsp wrp \#}\index{Shell!mv} changes
the name of a file or folder, or
even permits the moving of a file or
folder to another location.
\begin{quote}
\begin{verbatim}
~$ mv wsp wrk
~$ cd wrk
~/wrk$ ls
readme.txt
~/wrk$ mv readme.txt read.me
~/wrk$ ls
read.me
~/wrk$ cp read.me wrk-readme.txt
~/wrk$ ls
read.mewrk-readme.txt
~/wrk$ mv wrk-readme.txt ~/Documents/
~/wrk$ ls
read.me
~/wrk$ cat ~/Documents/wrk-readme.txt
Work space
This folder is used
to practice the bash
commands and queries.
\end{verbatim}
\end{quote}

\paragraph{Copy to pen drive.}\index{Pen drive}
In most Linux distributions, the pen drive is
seen as a folder inside the \verb|/media/nia/|
directory, where you should replace \verb|nia|
with your user name. In the Macintosh, the
pen drive appears at the \verb|/Volume/| folder.
The commands {\bf cp}, {\bf rm} and {\bf ls}
see the pen drive as a normal folder.


\section{Package managers}\index{Package managers}
A package
manager is a tool that works with
core libraries to handle, even though poorly,
the installation and removal of
software. Each operating system has its own
package manager. Even if you stick to a single
operating system, you will have to
deal with many package managers
and different philosophies concerning
software installation.


I will teach you how to use three
installation tools: apt-get,
homebrew and git clone. However,
this tutorial will not
completely cover the many subtleties
involved while you make your machine usable.
You will really need the help of
that girl who is majoring in
Computer Engineering.
Tell her that, if she teaches you
how to configure apt-get install,
you will teach her the ancient
Javanese script.

\section{ncurses}\index{ncurses}
In the jargon of tech-oriented people,
a person who uses computers is called
{\em user}, but engineers
prefer the term {\em looser}, as
the latter is an affectionate way
of calling those individuals who need to work
with a computer, but in fact have no skills. By the way,
looser is a loser who can't spell ``loser''.



Computers need a tool to make communication
with users possible. That tool is
called User Interface, or UI for short.
There are two kinds of User Interface.

In this chapter, you are learning how to use a
text terminal. Therefore, you already know,
what a text based User Interface or UI is.
After all, you are operating the shell,
and the shell is a User Interface.

A graphical user interface
allows people to interact with
computers through graphical icons and
visual indicators, instead of 
typed commands or keyboard shortcuts.
GUIs were introduced when vendors
perceived that non tech-savvy customers have
difficulty in dealing with modern
digital machines, that require a formal
language for accepting commands.

Considering that people frequentely
converse with each other through
the Chat Box, you could type commands
in a text box of a Graphical User
Interface. However, a text terminal
offers sharper and crisp characters
through the use of a specialized
User Interface called ncurses.
You will find ncurses at
the following address:
\begin{quote}
\verb|http://ftp.gnu.org/gnu/ncurses/|
\end{quote}
The distribution package is called
archive, since it contains many
files stored together in a compact way,
that you will need to decompress
and extract.

A popular tool for decompressing an archive
is gunzip that accepts files with the \verb|*.gz|
extension. Extraction is performed by the \verb|tar|
application.\index{Shell!tar xfvz}
\begin{quote}
\begin{verbatim}
~$ tar xfvz ncurses-6.0.tar.gz
\end{verbatim}
\end{quote}
The \verb|z| option calls gunzip to
decompress the
\verb|ncurses-6.0.tar.gz| archive into
an \verb|ncurses-6.0.tar| file. The
\verb|x| option indicates that
you want to extract the component
files of the \verb|ncurses-6.0.tar| intermediate
file and place them into the \verb|ncurses-6.0/|
directory.

The Macintosh differs from Linux machines
in that, when you perform the download of the
\verb|ncurses-6.0.tar.gz| archive, the
Apple operating system decompresses the distribution
automatically, so that you will end up
with the tar file in the \verb|~/Downloads|
folder. Then you can transfer it to your home directory
and perform the extraction without the need for the
\verb|z| option.
\begin{quote}
\begin{verbatim}
~$ cd ~  # makes sure that you are in the home folder
~$ cp ~/Downloads/ncurses-6.0.tar .
~$ tar xfv ncurses-6.0.tar
\end{verbatim}
\end{quote}

The tar tool creates an \verb|ncurses-6.0| folder
containing all files of the program that implement
the ncurses text based User Interface.

The \verb|ncurses-6.0| directory contains
many files in the C  computer language.
In order to become usable, these files
must be compiled into a set of libraries
containing instructions written in a
language that the computer understands.
You do not need any knowledge of C to
perform the translation to machine
language. All instructions in the
batch job for performing the compilation
are written in  \verb|Makefile|. However,
\verb|Makefile| on its on is not
sufficient. For the operation to be
successful, the system needs also to know which
computer you are using. The \verb|configure|
contains the program that analyzes your
handware.
\begin{quote}
\begin{verbatim}
~$ cd ncurses-6.0/
~/ncurses-6.0$ ./configure --enable-widec
~/ncurses-6.0$ make
~/ncurses-6.0$ sudo make install
\end{verbatim}
\end{quote}
The second line of the above listing
configures \verb|ncurses|, i.e.,
discovers details about your machine.
The \verb|--enable-widec| option customizes
the text terminal for chars with
diacritics, so you can write words
like {\em café} and {\em façade}.

The second line of the ncurses installation
listing compiles the User Interface.
The third line performs the very installation.

The installation requires that the
system copy files to the \verb|/usr/local/|
folder. However, you must give special
permission for this operation to be performed,
otherwise the possibility remains open for
a virus to make similar copies
in critical folders.
The \verb|sudo|
command informs the machine that you
are a superuser. To avoid being tricked
by a virus or an unauthorized user,
the machine asks for the password,
and if you type it correctly,
the system installs ncurses.

\section{Linux.} Use apt-get to install the
latest version of \verb|libncursesw5-dev|.
Since repositories are usually old,
download a recent distribution of ncurses,
and build it:
\begin{verbatim}
~$ sudo apt-get install libncursesw5-dev
~$ wget http://ftp.gnu.org/gnu/ncurses/ncurses-6.0.tar.gz
~$ tar xfvz ncurses-6.0.tar.gz
~$ cd ncurses-6.0/
~/ncurses-6.0$ ./configure --enable-widec
~/ncurses-6.0$ make
~/ncurses-6.0$ sudo make install
\end{verbatim}
After installing ncursesw,  you need to
clone the sources for the editor. Here is how
to perform this job:
\begin{quote}
\begin{verbatim}
~$ git clone https://github.com/FemtoEmacs/Femto-Emacs
\end{verbatim}
\end{quote}

After cloning the editor, enter the source directory
and make the files.
\begin{quote}
\begin{verbatim}
~/$ cd ~/Femto-Emacs/ 
~/Femto-Emacs$ make
\end{verbatim}
\end{quote}
Installation is achieved by copying the
compiled files to \verb|/usr/local/bin/| and
the customization files to your home directory.
\begin{verbatim}
~/Femto-Emacs/femto$ sudo cp femto /usr/local/bin/ 
~/Femto-Emacs/femto$ sudo cp femto.boot /usr/local/bin/ 
~/Femto-Emacs/femto$ cp init.lsp $HOME/ 
~/Femto-Emacs/femto$ cp aliases.scm $HOME/
\end{verbatim}

I have to say this again: An installation
task has so many details that, unless you
are an engineer yourself, 
ask for help from a computer expert.

\section{MAC OS-X.}
In order to install programs that depend
on resources present in a text terminal,
you need to install the
\verb|libncursesw.a| library. You can
use your browser to download it.
Immediately after the download is complete, it will be
placed in the \verb|~/Downloads/| folder.

It is advisable to transfer it to your
home directory or, even better, to a
source folder. Let us assume that Nia
has chosen the home directory as her
installation folder.
\begin{quote}
\begin{verbatim}
~$ cp ~/Download\ncurses-6.0.tar.gz .
\end{verbatim}
\end{quote}
Remember that the dot indicates the current
directory. For instance, the \verb|./femto|
command means: execute the \verb|femto| file
present in the current directory.
The fact is that Unix and Unix like systems
are unable to find a command, except when
it is installed in a pre-defined search
path or when the file path is completely
specified.

Unpack and make the distribution archive as shown below:
\begin{quote}
\begin{verbatim}
~$ tar xfvz ncurses-6.0.tar.gz
~$ cd ncurses-6.0/
~/ncurses-6.0$ ./configure --enable-widec
~/ncurses-6.0$ make
~/ncurses-6.0$ sudo make install
\end{verbatim}
\end{quote}
Femto assumes that  \verb|libncursesw.a|
resides in the following folder:
\begin{quote}
\begin{verbatim}
/usr/local/lib/libncursesw.a 
\end{verbatim}
\end{quote}
Therefore, copy the \verb|libncursesw.a| file
to \verb|/usr/local/lib/| as shown below:
\begin{verbatim}
~/$ cd ncurses-6.0 
~/ncurses-6.0$ cd lib 
~/ncurses-6.0/lib$ sudo cp libncursesw.a /usr/local/lib/
\end{verbatim}

After installing libncursesw, enter the folder \verb|Femto-Emacs/|
and build the editor for Macistosh:
\begin{verbatim}
~/$ cd ~/Femto-Emacs/ 
~/Femto-Emacs$ make -f Makefile.macosx
\end{verbatim}


\chapter{The man who knew Javanese}
\index{Javanese}
In a doughnut shop the other day,
I was telling my friend Castro
how I tricked respectable members of the
community not only to make a living,
but also rise to a higher social position.

For instance, while I was living in Manaus,
I had to hide my professional degree to win
over the clients' trust. People, who never would
come to a physician's practice or lawyer firm,
flocked to my wizard and fortune teller's office.
So, I was telling him this story.

My friend listened to me in silence,
enraptured by my words,
appreciating the account of picaresque adventures,
that seemed as though they had been
extracted from the Story of Gil Blas.
During a conversational pause,
after both drying our glasses,
he remarked randomly:

``You've been living an extremely funny life, Castelo!''

``It's the only kind of life worth living\ldots
I could not immagine
myself having a single occupation.
It is extremely boring
to go to work in the morning,
come back in the evening, read the paper
on the sitting room armchair,
and go to bed at eleven fifteen.
Don't you think?
In fact, I can't imagine how I have been
able to stand my job at the Consulate!''


``Yes, the existence in the civil service
must be tedious. But that's not
what amazes me. I wonder how have you been
able to pass through so many adventures here,
in this monotonous and bureaucratic Brazil.''

``You will be surprized, my dear Castro,
to learn that even here, in this country,
one can write quite interesting pages on a
memoir. Believe it or not,
I was even a teacher of Javanese!''

``When was that? Here, after you retired
from your job at the Consulate?''


``No, it was a long time ago.
What's more, I got my job at the
Consulate as a consequence of my
teaching duties.''

``That story I want to hear! In the mean time,
let us have a few more drinks?''

``Yes, I accept another glass of beer.''

We sent for another bottle, filled our glasses
and I continued:

``I had just arrived in Rio and I was literally broke.
My life was consumed fleeing
from one boarding house to
the other on rent day, without
idea of how to earn a living.

Of course, I didn't have money
to pay for breakfast.
Even so, I was in a café, but only to
read through the job openings section
of the newspaper left on a table
for the customers' convenience. Then, I came across
the following advertisement:


``Needed: A JAVANESE TEACHER.  Interviews at, etc.''

So, I told myself: ``This certainly is a position
where you won't find many applicants. If only I
could comprehend a few words of Javanese,
I'd apply.''

I left the coffee shop in a waking dream,
where imagined myself in a brave new world,
as a Javanese teacher,
earning more than just a decent living,
driving my car,
without unhappy meetings with debt collectors.

When I awoke from my daydream,
I found myself in front of the public library.
I went in and gave my cap to a
person that looked like an attendant,
since I knew about the custom of the
upper class to leave their hats at
the hat stand. I did not have
a hat, so I left my cap. Of course,
I never saw my cap again.

I didn't really know what
book I was going to ask for.
In any case, this was irrelevant,
because my name was nationally blacklisted,
since I never returned the books to
the highschool library. Nevertheless,
I climbed the stairs to browse
an Encyclopedia,
volume J and look up the entry on
Java and the Javanese dialect. 
In a few minutes, I knew that Java was a
big island of the Greater Sunda Islands,
at the time a Dutch colony.

%%\index{Brahmic script}
I also learned that Javanese is an agglutinative
language of the Malayo-Polynesian family.\index{Polynesian languages}
It has a noteworthy literature written in
characters derived from the old Hindu alphabet.
The Javanese alphabet is a modern variant
of the Kawi script, a Brahmic script developed
in Java around the ninth century.
In the past, it was widely used in religious literature,
which was written on palm-leaves.
This kind of manuscript came to be known
as  lontar.
The Encyclopedia gave a list of books for further
reading and I had no doubt of what I needed
to do, and consulted one of them.
I made a copy of the alphabet and its phonetic
transcription and left. I wandered the streets
walking aimlessly chewing over the letters as
they were gum.

Hieroglyphs danced in my head. From time to time,
I would look at my notes. Then I would
go into Tijuca park, and wrote
those strange looking characters
with a stick in the sand to keep
them vividly in my memory
and accustom my hands in writing them.

I would enter my building late at night in
an attempt to avoid coming across the
landlord, who could ask for the rent.
Even in my bedroom I kept chewing over
my Malayan A-B-C. My determination was such
that I knew it all by heart with the sunrise.
I convinced myself that Malay was the
easiest language in the world, and that Javanese
was as close to Malay as Portuguese to
Spanish, which simply is not true.
The reality is that Malay is not so
easy, and it is  as
far from Javanese as English from German.

I tried to leave home as early in the morning
as possible to avoid my landlord.
But to my dismay, it was not early enough,
for I couldn't escape meeting the man
in charge of asking for the room rent.

``Mr. Castelo, when are you going to
pay your rent bill?''

I aswered him with the most heart filled hope:

``Soon\ldots Wait just a little longer\ldots
Be patient\ldots I will be appointed as a
Javanese teacher and\ldots''
At that moment, the man cut in into my stuttering
excuses.

``What in hell is that, Mr. Castelo?''

I enjoyed the amusement
and proceeded to invest
in the man's patriotism:

``It's a language from the distant reaches of Timor.
Do you know where it is?''

Oh, simple minded fellow! The man forgot all about
my overdue bill and told me in a strong accent
from Portugal:

``I am not sure, Mr. Castelo. If I remember rightly,
Portugal has or had a colony with that name
close to Macau. But do you
really know such a thing, Mr. Castelo?''

Incentivated by this initial result from
my Javanese studies,
I started to fulfil the requisite of the advertisement.
I decided to offer my services as a teacher of
that transoceanic idiom. I composed the letter of
acceptance, then I went to the newspaper
office to left the document there.
With that, I returned
to the library to resume my Javanese studies.
I didn't make any progress that day. In fact, I
felt that the alphabet was the only knowledge
required from a Javanese teacher. Perhaps,
I was overly indulged with the
bibliography and history of the
language that I was going to teach.

Two days later I received an answer to my correspondence,
in which was stated
that I should go to the residence of
a certain Dr. Manuel Feliciano Soares Albernaz,
Baron of Jacuecanga,
Conde de Bonfim street.
I can't recall the house
number. Remember that  I was extremely focused
on Malayan studies to register the details
for history, as for example the house number.
But don't be fooled into thinking that
my lack of memory for particularities,
such as house numbers or names of historical
figures, renders the story as a figment
of my immagination. More than one scholar
told me that the  name of a certain
Prince Kalunga \index{Prince Kalunga}
is Aji Saka. \index{Aji Saka}
There you are.

Besides the alphabet, I knew the names
of a few authors. I also could say, ``How are
you?'', and knew a few grammar rules.
All this knowledge was supported
on around twenty words.

You can't imagine how hard I tried
to get the money for the bus fare! Javanese
is easier than loaning money,
you can be sure. Failing to raise
the necessary funds for the trip from
one neighborhood to the other, I walked.
Of course, I arrived in a state of dripping sweat.
With a motherly
affection, the old
mango trees standing in front
of the baron's house received, harbored
and cooled me down with the fresh air of shade.
It was the first time in all my life
that I felt sympathy for Nature.

The house was huge, but ill kept.
However, it was that way more from
despondency and weariness of living
than from its owner's poverty.
The walls hadn't been
painted for years, and what was left
of their coats was peeling away.
The eaves around the edges of the
roof were made up of old fashioned tiles,
some of which were missing, creating
as effect of decaying false teeth.
In the garden, the
flatsedge and other weeds had expelled the 
begonias. However, the more resistent crotons
continued to bloom with their purplish leaves.

I knocked. It was awhile before 
an aged African Negro came to the door. His white
beard and hair gave him an appearance of
fatigue and suffering.

In the parlor there was a row of gold framed portraits,
which showed bearded gentlemen and profiles of
sweet ladies holding huge fans and dresses
that looked like balloons ready to ascend in the air.
From among the many items,
to which the dust gave more antiquity and respect,
what impressed me most was a big, beautiful,
porcelain vase from China or India, I never
learned to differentiate their origins.
Anyway, the purity of the material,
its fragility, the naiveté of its contour
and its dim lustre that appeard to be
as the moonlight suggested to me that
the artwork was fashioned by the hands
of a dreaming child for
the enchantment of old men's  disillusioned eyes.

As I described above, I was inspecting the furniture,
while waiting for the master of the house.
He delayed quite a long time. Then, he came.
Full of respect, I watched the elderly man
approach haltingly,
a large handkerchief in his
hand, inhaling an old fashioned peppermint
essence venerably.

Although I wasn't sure he was my pupil to be, I felt
that it would have been wicked to deceive the
aged gentleman, whose ancient aspect made
me think of something august, sacred.
I hesitated for a moment. Should I invent
an excuse and leave? But finally
decided to wait and see.

``I am,'' I said to break the ice,
``The Javanese teacher you asked for.''

``Sit down,'' answered the old gentleman.
``Are you from Rio?''

``No, Sir. I'm from Canavieiras.''

``What?'' He said. ``Speak louder, my hearing is impaired.''

``I am from Canavieiras,'' I repeated putting emphasis
upon each word.

``Where did you go to school?''

``In the city of Salvador, in the great state of Bahia.''

``And where did you learn Javanese?'' he
asked with that dodgedness so common among the elderly.

I was not expecting for such a question,
but I made up a lie about a
Javanese father, who had come to Bahia
on a freighter. Liking what he saw,
my phony father decided to
settle there in Canavieiras as a fisherman.
He married, prospered and taught me Javanese.

``Did he believe you?'' asked my friend
who up to that moment had remained silent.
``And your features?''

``I'm not very different from a Javanese''
I contested. ``With my thick, straight, black hair
and tanned skin, I could very well pass for
a Indonesian halfbreed. You know very well
that among us there are all kinds of nationalities
-- Indians, Malayans, Tahitians, Madagascans,
Guanches\footnote{Guanches were the Berber aboriginal
inhabitants of the Canary Islands.}
and even Goths. Our people are an amalgamation
of races and types to make the whole world envy us.''

``O.K..'' My friend agreed. ``Please, go on.''

``The old gentleman,''  I resumed,
``listened intently and examined my physique
for a long while. Then he concluded that I was
indeed the son of a Malayan, and asked me softly:

``Well, do you really want to teach me Javanese?''

The answer came unwittingly: ``Yes.''

``You must be astounded,'' added the Baron
of Jacuecanga, ``that I, at my age, should
still have a wont for learning.''

``I'm not surprized at all. There have been
noteworthy examples of late learners,
as Socrates, who started flute at seventy.''

``What I really want, Mr.\ldots?''

``Castelo,'' I supplied.

``What I really want, Mr. Castelo,
is to fulfill a family pledge.
I don't know whether you realize that I'm the
grandson of State Secretary Albernaz, the same
man who accompanied Peter,
the first emperor of Brazil,
into exile, after his abdication.
When he came back from London,
the Secretary brought with him a book written in a strange
language, onto which he bestowed great value.

The old volume had been given to my grandfather
by an Indian or a Siamese sailor in
return for what received favor I do not know.

Before he died, my grandfather called
my father to his deathbed and told him
the story that follows.

``Son, do you see this book here, written in Javanese?
Well, the person who
gave it to me believed that it would bring its owner
happiness and deliverance from evil. I don't know
whether you should believe in such a legend or not.
In any case, keep the book, and if
the good omens prophesized by the oriental wiseman
come true, teach your son to read it,
so that our family line should prosper.''

``My father,'' proceeded the old baron, ``didn't take
the story to heart. Nevertheless, he maintained
the book in safe keeping.
When he lay sick and suspected that the end of his
life was near\footnote{Before the Scholar among
my readers accuse me of plagiarism,
I avow that I am fluent in Ancient Greek,
and the first book I read in my life
was the Anabasis.},
he gave it to me repeating the
dying words of his own father.''

In the beginning, I 
paid little attention to the book. I threw it 
in a corner, and got on with life.
I even forgot it existed. Lately,
so many misfortunes have befallen me,
that I remembered the old family heirloom.
I must read and understand the book, if I want to
preserve my last days from witnessing the total
ruin of my posterity. Of course, to read the book,
I need to master the Javanese language.
There you have all of it.''

He became silent. I noticed his eyes glistened
with tears.
He wiped them discreetly and asked me if I
would care to see the book. I gave a yes.
He summoned the maid, passed her the instructions
to find and fetch the book,
while he told me how he had lost all his children,
nephews and nieces. Only one married daughter
remained alive. From her numerous offspring,
only one son survived, a  weak and infirm boy.

The book arrived, an old,
large volume, presented in
quarto bound in leather and printed in huge
letters on yellowed paper.

Since the title page
was missing, I was unable to determine
the date of publication. Fortunately,
the preface was written
in English. There I read that the book
contained the stories of a Prince Kalunga,
a renowened writer.

I explained this entirety to the baron.
Ignorant of the fact that I arrived at 
this deliverance of knowledge
from the English preface, he was
very impressed with my erudition on
Javanese culture. I browsed the pages
with the look of someone familiar
with that language that most people
would not be able to tell apart from
Sanskrit or Hindi.

Before parting company, the baron and I
agreed upon my fees
and the class schedules.
To fulfill my part in the contract,
I should teach my old pupil to read
the book in a year.

A few days later, I gave the gentleman
the first private lesson, but the old man
was not diligent, not even at my level
of interest. At the
end of the class, he could not distinguish
one character of the abugida from the other,
or trace the five first letters of the
hanacaraka sequence.

Traditionally, the Javanese syllabary
is taught through a poem of 4 verses
narrating the myth of Aji Saka.\index{Javanese alphabet}
\begin{quote}
\includegraphics[scale=0.3]{figs/ha.png}
\includegraphics[scale=0.3]{figs/na.png}
\includegraphics[scale=0.3]{figs/ca.png}
\includegraphics[scale=0.3]{figs/ra.png}
\includegraphics[scale=0.3]{figs/ka.png} --
There were two messengers
\end{quote}
\begin{quote}
\includegraphics[scale=0.3]{figs/da.png}
\includegraphics[scale=0.3]{figs/ta.png}
\includegraphics[scale=0.3]{figs/sa.png}
\includegraphics[scale=0.3]{figs/wa.png}
\includegraphics[scale=0.3]{figs/la.png} --
with mutual hatred.
\end{quote}
\begin{quote}
\includegraphics[scale=0.3]{figs/pa.png}
\includegraphics[scale=0.3]{figs/dha.png}
\includegraphics[scale=0.3]{figs/ja.png}
\includegraphics[scale=0.3]{figs/ya.png}
\includegraphics[scale=0.3]{figs/nya.png} --
One was as mighty as the other.
\end{quote}
\begin{quote}
\includegraphics[scale=0.3]{figs/ma.png}
\includegraphics[scale=0.3]{figs/ga.png}
\includegraphics[scale=0.3]{figs/ba.png}
\includegraphics[scale=0.3]{figs/tha.png}
\includegraphics[scale=0.3]{figs/nga.png} --
Here are the corpses.
\end{quote}


In the poem, each syllable is written
with a different letter. After learning
the first verse, the student has learned
five letters.  Five more letters are
presented in each sebsequent verse. 

It took a whole month for the Baron of
Jacuecanga to learn the first and second
verse. What is worse, only one day was
enough for him to forget everything.
So, both teacher and student started a long
cycle of learning and forgetting.

I think that the Baron's daughter and her husband
didn't know anything about the book until they
become curious of my activities in their home.
When I explained the matter to them, they took it
lightly. They laughed about the behavior of their
elderly relative, said that he probably had dementia,
and that learning languages could slow the progress of
the disease. 

You won't believe it, my dear Castro, but the
son-in-law came to admire and respect the teacher
of Javanese. He kept saying: ``It is amazing how
my father-in-law's tutor could grasp a culture
so different from our own! Yet, he is
so young. If I were as knowledgeable as he,
I would be a scholar at Cambridge or at the Sorbonne.

The husband of Mrs. Maria da Gloria,
that was the name of the Baron's daughter,
was a judge, a powerful and well connected man.
Even so, he never tired of showing
his admiration for my knowledge of Javanese.

The Baron also seemed happy with me.
But after two months he gave up learning
the language. Instead of reading the book
himself, he concluded that it would be
enough to understand its contents
in order to fulfill the pledge he made to his
dying father. Certainly, the powerful
spiritual forces behind the book would
not be opposed to the humble request for
the services of a translator.
He would hear my rendition of the story of
Aji Saka, avoiding the effort that his
old brain was not in shape to bear.

You are certainly aware that even today
I don't know Javanese. But as every
learned man in this country, I had heard
the story of King Aji Saka, or Prince Kalunga,
as Brazilians prefer to call the hero.
In my rural village, at night,
in my room illuminated by candles and
kerosene lamps, my mother used to read
a translation of the Indonesian
legend into Latin until I would fall asleep.
Therefore, it was not very difficult to
patch together memories from my childhood,
fill the gaps, and present the result
to the old man as coming directly from the book.
He would hear those myths in ecstasy, as
though an angel were providing the rendition.
And my reputation
increased among the members of the Baron's
family and its circle of acquaintainces.
The Baron raised my salary, and I started
living an easy life.

An unexpected fact contributed to my
prestige. The Baron received an inheritance
from a Portuguese relative that he  didn't
even know existed. Of course, he assigned the
happy event to the Javanese book.
I myself almost believed that this was so.

As time went by, I stopped myself from
feeling remorse and guilty due to my deceiving
the naive man and his family. In any case,
I was terrified at the prospect of coming
across some horrible person that could
speak the Javanese dialect. My terror
increased when the Baron wrote a letter
to the Viscount of Caruru suggesting my
name for an international affairs career.
I advanced every kind of objection to the
idea. ``I am very ugly, uncouth and gaunt.
My knowledge of French
is faulty. I am not elegant.
I don't know the protocols.''

He insisted: ``Physical aspect doesn't matter, young man.
Go ahead! Everybody speaks French, German and English.
But only you know Javanese.''

So, I went to the interview with the Viscount,
who sent me to the Ministry of Foreign Affairs
with more than one recommendation letter.
After all, everybody wanted to have the
honor of giving me a recommendation letter.
I was a huge success when I arrived at
the office of the director
of fucking nothing\footnote{A literal translation
of the Portuguse acronym for ASPONE -- Assessor de
Porra Nenhuma.}.

The director called all the department
heads: ``Look at this! The man
knows Javaness.  What a prodigy!''

The heads of various departments introduced me
to clerks and amanuensis.
One of these lesser officials of the Ministry
gave me a look with more envy and hatred than
admiration. But everybody else kept saying:
``Do you really know Javanese? Is it difficult?
I believe that nobody else speaks that language here.''

The clerk who had looked at me with undeserved
hatred approached the group of admirers and interrupted
the applauses with a cold comment: ``That is true,
nobody knows Malay or Indonesian here. But I speak
Kanak, a language of the New Caledonia. Do you
know Kanak?

I told him I didn't and proceeded
to the Minister's office.

The high authority got up, adjusted the
glasses on his nose, and asked point blank:
``So, do you speak Javanese?''
My answer was a loud {\em yes}.
He wanted to know where I learned the
language. I told him about my Javanese father.
The Minister was sincere and direct.
``You can't go into the Diplomatic Service.
Brazilian Diplomats must be blond with
blue eyes. Of course, there is the affirmative
action for blacks and indians. But although
your skin is dark, you cannot apply,
since you are Javanese, not Indian.
We could send you to a consulate in
Asia or Oceania, but I am afraid
that there is no opening now.
However, if a position appears, you will
get it. Meanwhile, you will be attached directly
to my Ministry. By the way,
I want you to go 
to Basel sometime next year, in order
to represent our country in a congress
of Linguistics. Read the books of
Hove-Iacque, Max Müller, and other
good authors in the field.''

Can you follow me? I didn't know Javanese
and could barely ask for lunch in French
or English, but have a good job, and would
represent my country in a meeting of scholars!

The old Baron came to pass,
and the book went to his son-in-law,
with the intention that it be given
to his grandson when the boy come to age.
The deceased Baron also left me a sum
in his will.

I cannot say that I didn't try to learn
tha Malayo-Polynesian languages, but to
no avail. The effort of learning those
languages is way out of my reach.
Besides this, I had more pressing
business to take care of: Eating well, dressing
elegantly, and reading Comics.

Anyway, even if you don't read much,
it is advisable to have shelves of books
and many volumes of journals in your
office. Therefore, I subscribed to
the Revue Anthropologique et Linguistique,
the Proceeding of the English Oceanic
Association, and the Archivo Glottologico
Italiano. Of course, subscribing to those
scholarly journals without reading
them did add anything to my learning
of languages.


Yet, my reputation did not stop increasing.
People who I met on the street would greet me
with the comment:

``There goes the man who knows Javanese.''

In book stores, grammarians often
would consult me about the position
of pronouns in the dialect spoken
on the island of Sonda.
Scholars sent me letters  from all
over the world and newspapers would write 
articles about me. On an occasion,
I had to refuse a
group of well to do young students
who wanted to learn Javanese at any cost.

Do you remember that commerce paper where
I found the advertisement? The editor
asked me to  write an
article on the classical
and modern Javanese literature.
I obliged.

``How could you, since you avow to be ignorant
of the language, let alone the literature?''
asked  Castro.

``That was not very difficult. I started
with a detailed description of the island
of Java. Dictionaries and
geography textbooks provided me with the necessary
information.
Then, I quoted American, German and French
authors.''

``Did anybody ever put your knowledge in question?'' My friend asked.

``Never, although I was almost caught out on
a particular occasion. The police arrested
an individual, a sailor, a brown fellow who
spoke a strange language. They called a number
of different interpreters, but to no avail.
Finally the police got in touch with me,
the Javanese scholar, with all the respect
my position deserved. I delayed in attending
the request, but in the end I could no longer
escape the compromise. Fortunately, the man
had been released, thanks to the intervention
by the Dutch consul to whom the sailor
could explain his case through the use
of half a dozen or so Dutch words.
The sailor was indeed Javanese.''

The moment finally arrived for my
attending the congress. So, there
I was on my way to Europe.
It was marvelous! I attended to
the opening ceremony and the invited
paper presentations. The organizers
registered me in the Tupi-Guarani
section. After a couple of days at
going from presentation to presentation,
I concluded that the whole thing was
not for me, and left for Paris.
Before taking the train, however,
I was careful enough to convince a
journalist to publish my portrait
and a short article about me. Thus,
I had a way to prove that I was in
Basel, not in Paris.

Eventually, I returned to Basel for
the closing ceremony. The organizers
of the congress assumed that my
abscence was due to their mistake
of assigning me to the Guarani section.
I accepted the apology, but I still
was not able to write that treatise
on Javanese that I promised them.

After the congress, I paid for the publication
of German and Italian translations of the article
from the Basel paper. The readers of these
translations offered a banquet in my honor.
The banquet was presided by Senator Gorot.
My contribution cost me all the money
the Baron left me in his will.

The money was well spent. After all,
I became a celebrity, and after six
months I was appointed Consul in
Havana, where I lived for many years,
in order to perfect my proficiency
of the Polinesian languages.

``It is fantastic,'' observed Castro, holding
tightly to his glass of beer.

``Look! Do you know what I would like to
be right now?''

``What?''

``A famous genetic or computer engineer. Let us
go for it?''

``I am in.''


\chapter{Arithmetic operations}
The femto editor is designed for writing programs.
Therefore, Nia decided
to learn how to use it through its own scripting language,
that is femtolisp.

Nia entered the editor and pressed \verb|C-x C-f| 
to create the \verb|celsius.scm| buffer. 
She typed the  program below into the buffer. 
\begin{verbatim}
; File: celsius.scm
; Comments are prefixed with semicolon
;; Some people use two semicolons to
;; make comments more visible.

(define (c2f x)
(- (/ (* (+ x 40) 9) 5.0) 40)
);;end define

(define (f2c x)
(- (/ (* (+ x 40) 5.0) 9) 40)
);;end define
\end{verbatim}
Function c2f converts Celsius readings to Fahrenheit.
The \verb|define| macro, which defines a function, 
has four components, the function id, a parameter list,
an optional documentation, and a body that contains
expressions and commands to carry out the desired
calculation. Comments are prefixed with a semicolon.
In the case of \verb|c2f|, the id is \verb|c2f|,
the parameter list is \verb|(x)|, and the body 
is \verb|(- (/ (* (+ x 40) 9) 5.0) 40)|.

Lisp programmers prefer the prefix notation:
open parentheses, operation, arguments, close parentheses.
Therefore, in  \verb|c2f|,  \verb|(+ x 40)|
adds \verb|x| to 40, and \verb|(* (+ x 40) 9)| multiplies $x+40$ by 9.

In order to perform a few tests, Nia must initially save
the program with \verb|C-x C-s|. Then she 
presses \verb|C-x 2| to create a window for interacting
with Lisp. After this action, there are two
windows on the screen, both 
showing the \verb|celsius.scm| buffer. The \verb|C-x o| command
makes the cursor jump from one window to the other.
From the bottom window, Nia presses \verb|C-x C-f| to
create the \verb|repl.scm| interaction file. 

On the \verb|repl.scm| buffer, 
Nia can load the \verb|celsius.scm| program
and  call any application that she has defined
herself, or which comes with Lisp.
The \verb|Esc ;| command reads an operation
from the  minibuffer and executes it.
The first operation is loading
the \verb|celsius.scm| file,
as you can see in figure~\ref{fig:repl}.
Be sure that you
are on the \verb|repl.scm| 
interaction window when you perform
the loading, otherwise you will introduce
the \verb|#<function>| extraneous 
text into the source file.

\begin{figure}[!b]
\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
; File: celsius.scm

(define (c2f x)
(- (/ (* (+ x 40) 9) 5.0) 40)
);;end define

(define (f2c x)
(- (/ (* (+ x 40) 5.0) 9) 40)
);;end define
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\begin{verbatim}

#<function>

(c2f 100)
212.0

\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\verb|> (load "celsius.scm")|
\end{fmpage}
\caption{Source file and Interation Buffer}
\label{fig:repl}
\end{figure}

Let us recall what happened until now.
Nia pressed \verb|C-x 2| to split 
the buffer window, as shown in figure~\ref{fig:repl}.
Thus she has two buffers in front of her,
each with its own window. One of the buffers has
a Lisp source file, while the other contains a Lisp 
interaction. In order to  switch
from one buffer to the other,
Nia press the \verb|C-x o| command.

The command \verb|C-x C-s| saves the Lisp source 
file. 

The \verb|Esc ;| command followed
by \verb|(load "celsius.scm")| on the minibuffer
loads the  source file.

One can also load the source file
by typing \verb|(load "celsius.scm")|
on the interaction buffer, 
then press the \verb|Esc ]| command.
After loading the source file either
with \verb|Esc ;| or with the \verb|Esc ]| method,
Nia types \verb|(c2f 100)| on the interaction
buffer. Then she presses \verb|Esc ]| to
insert the calculation of the Fahrenheit reading
into the interaction buffer.

Nia often works with a single window. 
In this case, after typing and saving
the source file with \verb|C-x C-s|,
she does not split the window
before opening the interaction buffer with the
\verb|C-x C-f| command. In this case,
only one buffer is visible. Nia switches 
between the interaction buffer and
the source file by pressing the  \verb|C-x n|
command. 

Text editing is one of these things that
are easier to do than to explain. Therefore,
the reader is advised to learn femtoemacs
by experimenting with the commands.

\section{let-binding}\index{let-binding}
The let-form introduces\index{Local variables} 
local variables\index{Local variables!let-binding}
through a list of \verb|(id value)| 
pairs.\index{let-binding!basic let-binding}
In the basic let-binding, a variable cannot 
depend on previous values that appear
in the local list. In the\index{let-binding!let-star binding}
\verb|let*| (let star) binding,
one can use previous bindings to calculate
the value of a variable, as one can see in
figure~\ref{fig:date-calculation}.
When using a let binding, the programmer must
bear in mind that it needs parentheses for
grouping together the set of \verb|(id value)| pairs,
and also parentheses for each pair. Therefore,
one must open two parentheses in front of the
first pair, one for the list of pairs and the
other for the first pair.


\begin{figure}[!b]
\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
(define (winter m)
(quotient (- 14 m) 12))

(define (roman-order m)
(+ m (* (winter m) 12) -2))

(define (zr y m day)
(let* ( (roman-month (roman-order m))
      (roman-year (- y (winter m)))
      (century (quotient roman-year 100))
      (decade (remainder roman-year 100)) )
 (mod (+ day
         (quotient (- (* 13 roman-month) 1) 5)
         decade
         (quotient decade 4)
         (quotient century 4)
         (* century -2)) 7)) )
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\linewidth}
\verb|> (load "zeller.scm")|\\
\verb|#<function>|\\
\verb|> (zr 2016 8 31)|\\
3
\end{fmpage}
\caption{Source file and Interation Buffer}
\label{fig:date-calculation}
\end{figure}

You certainly know that the word `December' means
the tenth month; it comes from the Latin word for
ten, as attested in words such as:
\begin{itemize}
\item {\em decimal} -- base ten.
\item {\em decimeter} -- tenth part of a meter.
\item {\em decimate} -- the killing of every tenth
Roman soldier that performed badly in battle.
\end{itemize}

October is named after the Latin numeral for {\em eighth}.
In fact, the radical {\sc Oct-} can be translated
as {\em eight}, like in
{\em octave}, {\em octal}, and {\em octagon}.
One could continue with this analysis,
placing September in the seventh,
and November in the nineth position
in the sequence of months.
But everybody and
his brother know that December is the
twelfth, and that
October is the tenth month of the
year. Why did the Romans give misleading
names to these months?

Rome was purportedly founded by Romulus,
who designed a calendar.
March was the first month of the year
in the Romulus calendar. Therefore, if Nia
wants the order for a given month in
this mythical calendar, she must
subtract 2 from the order
in the Gregorian calendar.
In doing so, September becomes the
seventh month; October, the eigth;
November, the nineth and
December, therefore, the tenth month.

Farming and plunder were the main
occupations of the Romans, and since winter
is not the ideal season for
either of these activities,
the Romans did not care much for
January and February. However,
Sosigenes of Alexandria,
at the request of Cleopatra and
Julius C\ae sar, designed the
Julian calendar, where January
and February, the two deep winter
months, appear in  positions
1 and 2 respectively.
Therefore, a need for a formula
that converts from the modern
month numbering to the
old sequence has arisen.
\begin{quote}
\begin{verbatim}
(define (roman-order m)
(+ m (* (winter m) 12) -2))
\end{verbatim}
\end{quote}
The above formula will work if \verb|(winter m)|
returns 1 for months 1 and 2, and
0 for months from 3 to 12. The definition
below satisfies these requisites.
\begin{quote}
\begin{verbatim}
(define (winter m)
(quotient (- 14 m) 12))
\end{verbatim}
\end{quote}
For months from 3 to 12,
\verb|(- 14 m)| produces a number
less than 12, and \verb|(quotient (- 14 m) 12)|
is equal to 0. Therefore,
\verb|(* (winter m) 12)| is equal to
0 for all months from March through December,
and the conversion formula reduces
to \verb|(+ m -2)|, which means that
March will become the Roman month 1, and December
will become the Roman month 10.
However, since January is month 1,
and February is month 2 in the Gregorian
calendar, \verb|(winter m)| is
equal to 1 for these two months.
In the case of month 1,
the Roman order is given by
\verb|(+ 1 (* 1 12) -2)|, that is
equal to 11. For month 2, one has that
\verb|(+ 2 (* (winter 2) 12) -2)|
is equal to 12.

The program of figure~\ref{fig:date-calculation}
calculates the day of the week
through Zeller's congruence. In the definition
of \verb|(zr y m day)|, the let-star 
binds values to the local variables \verb|roman-month|,
\verb|roman-year|, \verb|century| and \verb|decade|.

Figure~\ref{fig:date-calculation} shows that
the let binding avoids recalculating values that
appear more than once in a program. This
is the case of \verb|roman-year|, that
appears four times in the \verb|zr| procedure.
Besides this, by identifying important
subexpressions with meaningful names, the
program becomes clearer and cleaner.
After loading the program of
figure~\ref{fig:date-calculation},
expressions
such as
\verb|(zr 2016 8 31)| return
a number between 0 and 6, corresponding to
Sunday, Monday, Tuesday, Wednesday,
Thursday, Friday and Saturday.

\section{True or False}\index{Conditional execution!True and False}
So far, the only tool that Nia has used
for programming is combination of functions.
However, this is not enough to write
programs that reach a decision or
make a choice. Scheme has expressions
to say ``if this is true, do one thing,
else do another thing''. Nia 
could have used one of these decision
making expressions to calculate the roman
order:
\begin{quote}
\begin{verbatim}
(if (< m 3) (+ m 10) (- m 2))
\end{verbatim}
\end{quote}\index{Conditional execution!if-else}
The if-else expression says: if the
Julian numbering \verb|m| is greater
than 2, then subtract 2 from \verb|m|,
else add 10 to \verb|m|. The \verb|if-else|
expression is much simpler to understand
than all that confusing talk about deep
winter months.

Besides correcting the month, the \verb|(winter m)|
expression was used to correct the year. If
the month \verb|m| is 1 or 2, one must subtract
1 from the Gregorian year in order to obtain
the Roman year.

\begin{figure}[!b]
\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
(define (zr y m day)
(let* ( (roman-month (if (< m 3) (+ m 10) (- m 2)))
      (roman-year (if (< m 3) (- y 1) y))
      (century (quotient roman-year 100))
      (decade (remainder roman-year 100)) )
 (mod (+ day
         (quotient (- (* 13 roman-month) 1) 5)
         decade
         (quotient decade 4)
         (quotient century 4)
         (* century -2)) 7)) )
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
> (load "zeller.scm")
#<function>
> (zr 2016 8 31)
3
\end{verbatim}
\end{fmpage}
\caption{Making decisions}
\label{fig:zeller}
\end{figure}

You probably know, in all computer
languages, {\em Boolean} is a data type
that can have just two values: \verb|#t|
for ``true'' and \verb|#f| for ``false''.
The procedure \verb|(< m 3)| returns
\verb|#t| if \verb|m| is less than 3,
and \verb|#f| otherwise. On the other
hand, \verb|(if (< m 3) (+ m 10) (- m 2))|
calculates the expression \verb|(+ m 10)|
if and only if \verb|(< m 3)| produces
the value \verb|#t|. Otherwise, the
\verb|if| form calculates the \verb|(- m 2)|
expression.

Now, let us analyze the terms of the Zeller's
congruence. A
normal year has 365 days and 52 weeks.
Since 365 is equal to \verb|(+ (* 7 52) 1)|,
each normal year advances the day of the
week by 1. Therefore, the formula has a
\verb|decade| component.
Every four years
February has an extra day,
so it is necessary to add
\verb|(quotient decade 4)|
to the formula.

A century contains 100 years.
Therefore, one would expect  25
leap years in a century. But since
turn of the century years, such as 1900, are
not leap years, the number of leap
years in a century reduces to 24.
So, in a century the day of the
week advances by 124. But
\verb|(remainder 124 7)| produces
5, that is equal to \verb|(- 7 2)|.
Then one needs to subtract 2 for
each century. This is done through
the term \verb|(* century -2)|.

But every fourth century year is
a leap year. Therefore, Zeller needed to 
add the term \verb|(quotient century 4)|
to the formula.

Starting from March, each month
has 2 or 3 days beyond 28, that is
the approximate duration of a lunar
month: 3, 2,
3, 2, 3, 3, 2, 3, 2, 3, 3, 0.
Nia noticed that definition
\begin{quote}
\verb|(define (acc i) (- (quotient (- (* 13 i) 1) 5) 2))|
\end{quote}
returns the accumulated month contribution
to the week day.
However, the day chosen to start
the week cycle is irrelevant. Therefore,
there is no need to subtract 2 from the
accumulator.

\chapter{Sets}
A set is a collection of things. You certainly know that
collections do not have repeated items. I mean, if a guy or gall has
a collection of stickers, s/he does not want to have two
copies of the same sticker in his/her collection. If s/he has a
repeated item, s/he will trade it for another item that s/he lacks
in his/her collection.


It is possible that if your father has a collection of Greek
coins, he will willingly accept another drachma in his set.
However, the two drachmas are not exactly equal; one of them may be older
than the other.

\section{Sets of numbers}
Mathematicians collect other things, besides
coins, stamps, and slide rules. They collect numbers, for instance;
therefore you are supposed to learn a lot about sets of numbers.
\begin{description}
\item[$\mathbb{N}$ is the set of natural integers.] Here is how mathematicians  write the
elements of $\mathbb{N}$: $\{0,1,2,3,4\ldots\}$.
\item[$\mathbb{Z}$ is the set of integers, i.e.,] $\mathbb{Z}=\{\ldots-3, -2, -1, 0, 1, 2, 3, 4\ldots\}$.
\end{description}

%%\begin{wrapfigure}[10]{i}{4cm}
%%\includegraphics[scale=0.4]{figs/cantor.png}
%%\caption{Cantor}
%%\end{wrapfigure}

Why is the set of integers represented by the letter $\mathbb{Z}$? I do not know,
but I can make an educated guess. The set theory was discovered by Georg Ferdinand
Ludwig Philipp Cantor, a Russian whose parents were Danish, but who  wrote
his {\em Mengenlehre} in German! In German, integers may have some strange name like {\em Zahlen}.


You may think that set theory is boring; however, many people think that it is quite interesting. For instance, there is an Argentinean that scholars consider to be the greatest writer that lived after the fall of Greek civilization. In few words, only the Greeks could put forward a better author. You probably heard Chileans saying  that Argentineans are somewhat conceited. {\em You know what is the best possible deal? It is to pay a fair price for Argentineans, and resell them at what they think is their worth}. However, notwithstanding the opinion of the Chileans, Jorge Luiz Borges is the greatest writer who wrote in a language different from Greek.
Do you know what was his favorite subject? It was the Set Theory, or {\em Der Mengenlehre}, as he liked to call it.

When a mathematician wants to say that an element is a member of a set, he writes something like
$$3  \in \mathbb{Z}$$
If he wants to say that something is not an element of a set, for instance, if he wants to state that $-3$ is not an element of $\mathbb{N}$, he writes:
$$-3  \notin  \mathbb{N}$$
Let us summarize the notation that Algebra teachers use, when they explain set theory to their students.
\begin{description}
\item[Vertical bar.] The weird notation $\{x^2 | x \in \mathbb{N}\}$
represents the set of
$x^2$, {\em such that} $x$ is a member of $\mathbb{N}$, or else,
$\{0, 1, 4, 9, 16, 25\ldots\}$
\item[Conjunction.] In Mathematics, you can use a symbol $\wedge$
to say {\bf\small and}; therefore $x>2 \wedge x<5$ means 
\verb|(and (> x 2) (< x 5))| in Lisp notation.
\item[Disjunction.] The expression
$(x<2) \vee (x>5)$
means \verb|(or (< x 2) (> x 5))| in Lisp notation
\end{description}
Using the above notation, you can define the set of rational numbers:
$$\mathbb{Q}=\{\frac{p}{q} | p \in \mathbb{Z} \wedge q \in \mathbb{Z} 
\wedge q \neq 0\}$$
In informal English, this expression means that a rational number is a fraction $$\frac{p}{q}$$ such that $p$ is a member of $\mathbb{Z}$ and $q$ is also a member of $\mathbb{Z}$, submitted to the condition that $q$ is not equal to $0$.

In femtolisp, one can represent a rational number
as a Cartesian pair of integers. The expression \verb|(cons p q)|,
where \verb|p| and \verb|q| are integers, builds such a pair.
For instance, \verb|(cons 5 3)| produces the
\verb|'(5 . 3)| pair. N.B. there
are spaces before and after the dot.\label{page:cartesian-pair}

In the dotted pair notation of a rational number,
the \verb|(car '(5 . 3))| operation retrieves
the first element of the pair, i.e., 5.
On the other hand, the 
\verb|(cdr '(5 . 3))| operation
returns the second element, which is 3.

\begin{figure}[!h]
\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
(define f (cons 2 3))

(define g (cons 4 5))

(define (add x y)
(let ( (numerator (+ (* (car x) (cdr y))
                   (* (car y) (cdr x)) ))
     (denominator  (* (cdr x) (cdr y)) ))
(cons numerator
     denominator))) 
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\linewidth}
\verb|> (load "cartesian.scm")|\\
\verb|#<function>|\\
\verb|> (add f g)|\\
\verb|(22 . 5)|
\verb|(add '(3 . 7) '(2 . 5))|\\
\verb|(29 . 35)|
\end{fmpage}
\caption{Cartesian pairs}
\label{fig:cartesian-pairs}
\end{figure}

Let us assume that Nia wants to add two 
rational numbers. From elementary arithmetic,
Nia knows that the addition of two rational numbers
$P$ and $Q$ is given by the following expression:
\begin{equation}
\frac{X_a}{X_d}+\frac{Y_a}{Y_d}=
\frac{X_a\times Y_d + Y_a\times X_d}{X_d\times Y_d}
\label{eq:addratnums}
\end{equation}
In the dotted pair notation, one has $X_a$= \verb|(car X)|,
$X_d=\verb|(cdr X)|$, $Y_a$= \verb|(car Y)| and
$Y_d$= \verb|(cdr Y)|. By replacing these values
in equation~\ref{eq:addratnums}, one arrives at the
following expressions for the numerator 
and the denominator of the addition:
\begin{quote}
\begin{verbatim}
(+ (* (car x) (cdr y))    ;; numerator
(* (car y) (cdr x)))   

(* (cdr x) (cdr y))       ;; denominator
\end{verbatim}
\end{quote}
Nia used the above expressions for 
calculating the numerator
and denominator of $X+Y$ in 
listing~\ref{fig:cartesian-pairs}.


\section{Irrational Numbers}
At Pythagora's time, the Greeks claimed that
any pair of line segments is commensurable, i.e.,
you can always find a meter,
such that the lengths of any two segments
are given by integers.  The following
example will
show how the Greek theory of commensurable lengths at work.
Consider the square that the Greek in the figure
at the bottom of this page is evaluating.


If the Greeks were right, I would be able to find a meter, possibly a very small one,
that produces an integer measure for the diagonal of the square,
and another integer measure for the side. Suppose that $p$ is the
result of measuring the side of the square, and $q$ is the result of measuring the diagonal.
The Pythagorean theorem states that
$\overline{AC}^2+\overline{CB}^2= \overline{AB}^2$, i.e.,
\begin{equation}
p^2+p^2= q^2\therefore 2p^2=q^2\label{Pytagoras1}
\end{equation}

\begin{wrapfigure}[10]{i}{4cm}
\includegraphics{fig-sets/apolob.png}
\end{wrapfigure}
You can also choose the meter so that $p$ and  $q$ have no common factors. For instance,
if both $p$ and $q$ were divisible by 2, you could double the length of the meter, getting
values no longer divisible by 2. E.g. if $p=20$ and $q=18$, and you double the length of
the meter, you get $p=10$, and $q=9$. Thus let us assume that one has chosen a meter so
that $p$ and $q$ are not simultaneously even. But from equation~\ref{Pytagoras1}, one
has that $q^2$ is even. But if $q^2$ is even, $q$ is even too. You can check that
the square of an odd number is always an odd number. Since $q$ is even, you can
substitute $2\times n$ for it in equation~\ref{Pytagoras1}.
\begin{equation}
2\times p^2= q^2= (2\times n)^2= 4\times n^2 \therefore 2\times p^2= 4\times q^2
\therefore p^2= 2\times n^2
\label{peven}
\end{equation}

\begin{wrapfigure}[11]{o}{5.5cm}
\begin{center}
\includegraphics[scale=0.5]{fig-sets/apoloa.png}
\end{center}
\end{wrapfigure}
Equation~\ref{Pytagoras1} shows that $q$ is even;
equation~\ref{peven} proves that $p$ is even too. But this is against our
assumption that $p$ and $q$ are not both even. Therefore, $p$ and $q$ cannot be
integers in equation~\ref{Pytagoras1}, which you can rewrite as
$$\frac{p}{q}=\sqrt{2}$$



The number $\sqrt 2$, that gives the ratio
between the side and the diagonal of any square, is not an element of $\mathbb{Q}$,
or else, $\sqrt 2 \notin  \mathbb{Q}$. It was Hypasus of Metapontum, a Greek philosopher,
who proved this. The Greeks were a people of wise men and women. Nevertheless they
had the strange habit of consulting with an illiterate peasant girl at Delphi,
before doing anything useful. Keeping with this tradition, Hyppasus  asked
the Delphian priestess--- the illiterate girl--- what he should do to please Apollo.
She told him to measure  the side and the diagonal of the god's square
altar using the same meter. By proving
that the problem was impossible, Hypasus discovered a type of number that can not be
written as a fraction. This kind of number is called irrational.

An irrational number
is not a crazy, or a stupid number; it is simply a number that you cannot represent
as {\em ratione} (fraction, in Latin).

The set of all numbers, integer, 
irrational, and rational is called $\mathbb{R}$, or
the set of real numbers. 

Computers are not able to deal
with sets that hold a transfinite number of
elements. Therefore, femtolisp and
all other programming languages
replace sets with the concept of type.
In femtolisp, $\mathbb{Z}$ is 
called {\bf integer}, although
the {\bf integer} type does not cover all integers, 
but enough of them to satisfy
your needs. Likewise, a floating point
number belongs to the {\bf number} type, 
which is a subset of $\mathbb{R}$.


If $x\in{\bf Int}$, Lisp programmers\index{Type} say 
that $x$ has 
type\label{type:definition} \index{Type!Int} {\bf integer}. 
They also say that $r$ has 
type {\bf number} if $r\in {\bf Real}$.

In femtolisp, rational and irrational numbers
are inexact data types. Here are a few functions
that produce inexact results:
\begin{quote}
$\verb|(+ |x_1\;x_2\;\ldots x_n\verb|)|$ -- addition\\
$\verb|(* |x_1\;x_2\;\ldots x_n\verb|)|$ -- multiplication\\
$\verb|(- |x_1\;x_2\;\ldots x_n\verb|)|$ -- subtraction\\
$\verb|(/ |x_1\;x_2\;\ldots x_n\verb|)|$ -- division\\
$\verb|(pow |x\;y\verb|)|$ -- $x^y$\\
$\verb|(sin | x \verb|)|$ -- $\sin(x)$\\
$\verb|(asin | x \verb|)|$ -- $\arcsin(x)$\\
$\verb|(cos | x \verb|)|$ -- $\cos(x)$\\
$\verb|(acos | x \verb|)|$ -- $\arcsin(x)$\\ 
$\verb|(tan | x \verb|)|$ -- $\tan(x)$\\
$\verb|(atan | x \verb|)|$ -- $\arctan(x)$\\
$\verb|(log | x \verb|)|$ -- natural logarithm\\
$\verb|(log2 | x \verb|)|$ -- logarithm in base 2\\
$\verb|(log10 | x \verb|)|$ -- logarithm in base 10
\end{quote}\index{Predicates!integer?}
Integers are distinguished from inexact numbers
by the \verb|(integer? x)| predicate. Two important
integer functions are \verb|(quotient x y)| and
\verb|(mod x y)|. The first function
produces the integer division of \verb|x|
by \verb|y|, while the other returns
the remainder of the division. You should remember
having used
these two functions earlier to calculate the Zeller's
congruence.

\section{Data types}
There are other types
besides {\bf integer}, and {\bf number}. 
Here is a  list of primitive types:
\begin{description}
\item[integer ---] Integer numbers between $-2147483648$ and $2147483647$. \index{Predicates!exact?}
The \verb|(exact? x)| function returns \verb|#t| if \verb|x|
is an integer, and \verb|#f| otherwise.
\item[inexact ---] the inexact type represents both
rational and irrational numbers, albeit approximately.
The \verb|(inexact? x)| function returns \verb|#t| for
inexact numbers.\index{Predicates!inexact?}
\item[number ---] A number can be either exact or inexact.
The \verb|(number? x)| function returns \verb|#t| for numbers,
and \verb|#f| for any other type of object.\index{Predicates!number?}
\item[String ---] A quoted\index{String} string \index{Type!String}
of characters: \verb|"3.12"|, \verb|"Hippasus"|, \verb|"pen"|, etc.
The \verb|(string? x)| function answers \verb|#t| 
if \verb|x| is a string, 
and \verb|#f| otherwise.\index{Predicates!string?}
A few important functions that operate on strings are:
\begin{itemize}
\item \verb|(string-length s)| returns the number
of chars of the \verb|s| string.
\item\verb|(substring "Hello, World" 2 5)| operation
returns the \verb| "llo"| substring.
\verb|(substring "Hello, World" 0 4)| returns the
\verb|"Hell"| substring. And so on.
\end{itemize}
\item[Char ---] Chars have the \verb|#\|
  prefix: \index{Type!Char}
\verb|#\A|,
\verb|#\b|, \verb|#\3|, \verb|#\space|,
\verb|#\newline|, etc.
The \verb|(char? x)| function returns \verb|#t|
when \verb|x| is a char.\index{Predicates!char?}
Let \verb|s| be
a string such as \verb|"Hello"|. Then,
\verb|(string-ref "Hello" 0)|
returns the first char of \verb|s|,
\verb|(string-ref "Hello" 1)| returns
the second char, and so on. One can compare
chars with the following functions:
\begin{quote}
\verb|(char=? x #\g)| -- \verb|#t| if \verb|x= #\g|\\
\verb|(char>? x #\g)| -- \verb|#t| if \verb|x| comes
after the \verb|#\g| char.\\
\verb|(char<? x #\g)| -- \verb|#t| if \verb|x| comes
before the \verb|#\g| char.\\
\verb|(char>=? x #\g)| -- \verb|#t| if \verb|x| is
equal to \verb|#\g| or comes after it.\\
\verb|(char<=? x #\g)| -- \verb|#t| if \verb|x| is
equal to \verb|#\g| or comes before it.\\
\end{quote}
\item[Pair ---] One can use a pair data type
both to represent Cartesian pairs and lists.
The \verb|(pair? x)| returns \verb|#t| if
\verb|x| is a pair,\index{Predicates!pair?}
otherwise it returns \verb|#f|.
The \verb|'()| empty list is a very important
object that one can use as the second element
of a pair. The \verb|(null? x)| returns \verb|#t|
when \verb|x| is the \verb|'()| empty list.
\end{description}


\section{Functions}
A function is a relationship between an argument and a unique value.
Let the argument be $x\in B$, where $B$ is a set; then $B$ is called
domain of the function. Let the value be $f(x)\in C$, where $C$ is
also a set; then $C$ is the range of the function.
Functions can be represented by tables, or clauses. Let us examine
each one of these representations in turn.

\subsection*{Tables}
Let us consider a function that associates \verb|#t| ({\em true})
or \verb|#f| ({\em False}) to the
letters of the Roman alphabet. If a letter is a vowel,
then the value will be \verb|#t|; otherwise, 
it will be \verb|#f|. The range of such a function
is \verb|{#t, #f}|, and the domain is
$\{a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z\}$.\\

\verb||\\
{\footnotesize
\begin{tabular}{|p{1.2cm} p{1.2cm} | p{1.2cm} p{1.2cm} |p{1.2cm} p{1.2cm} | p{1.2cm} p{1.2cm} |}
Domain & Range & Domain & Range & Domain & Range & Domain & Range\\
a & \verb|#t| & g &\verb|#f| & m &\verb|#f| & t & \verb|#f| \\
b & \verb|#f| & h &\verb|#f| & n & \verb|#f| & u & \verb|#t| \\
c & \verb|#f| &  i &\verb|#t| &o &\verb|#t| & v & \verb|#f|\\
d &\verb|#f| &  j & \verb|#f| & p & \verb|#f| & w & \verb|#f| \\
e &\verb|#t| & k & \verb|#f| & q & \verb|#f| & x & \verb|#f| \\
f &\verb|#f| &  l &\verb|#f| & r & \verb|#f| & y & \verb|#f| \\
&            &                 &  & s & \verb|#f| & z & \verb|#f|\\
\end{tabular}}

\subsection{Clauses}
From what you have seen in the last section, you certainly notice that it is pretty tough to represent a
function using a table. You must list every case. There are also functions,
like $\sin\;x$, whose domain has an infinite number of values, which makes
it impossible to list all entries. 
Even if you were to try to insert only a finite
subset of the domain into the table, it wouldn't be easy. 
Notwithstanding, in the past,
people used to build tables. In fact, tables were the only way to calculate many
useful functions, like $(\sin\;x)$, 
$(\log\;x)$, $(\cos\;x)$, etc. In 1814 Barlow
published his Tables which give factors, squares, cubes, square roots, reciprocals
and hyperbolic logs of all numbers from 1 to 10000. In 1631 Briggs published
tables of sin functions to 15 places and tan and sec functions to 10 places.
I heard the story of a mathematician who published a table of sinus, and made
a mistake. Troubled by the fact that around a hundred sailors lost their way due to his
mistake, that mathematician committed suicide. This story shows that the use
of tables may be hazardous to your health.

In order to understand how to represent a function with clauses, let us revisit the vowel table.
Using clauses, that table becomes
\begin{quote}\small
\begin{verbatim}
(define (vowel x)
(cond ( (or (char=? x #\a)(char=? x #\e)(char=? x #\i) 
          (char=? x #\o)(char=? x #\u)) #t)
    (else #f)))
\end{verbatim}
\end{quote}
Expressions like $(\verb|or | p_1\;p_2\ldots p_n)$ has the same 
meaning as $p_1 \vee p_2\ldots \vee p_n$.

Functions have a parameter, also called variable, that represents an element of the domain.
Thus, the vowel function has a parameter \verb|x|, that represents an element of the set
\verb|{'a','b','c','d','e','f',...}|.
Below the name of the function, and its variable, one finds a set of clauses.
Each clause has a condition followed by an expression, that gives the value,
if that clause applies. Consider the first clause. The expression:
\begin{quote}
\begin{verbatim}
(or (char=? #\a)(char=? #\e)(char=? #\i)
(char=? #\o)(char=? #\u))
\end{verbatim}
\end{quote}
asks the question: {\em Is \verb|x= #\a|,
\verb|x= #\a|, \verb|x= #\a|, \verb|x= #\a| or
\verb|x= #\a|?} If the answear is yes,
the  clause  value is \verb|#t|; in proper functions,
the clause
value is given by the second clause expression. 

Now, let us consider the Fibonacci function,
that has such an important role in the
book ``The Da Vinci Code''.
Here is its table for the first 6 entries:\\
\begin{quote}\label{page:Fibonacci}
\begin{tabular}{p{2cm}p{3cm} | p{2cm}p{3cm}}
0 & 1 & 3 & 3 \\
1 & 1 & 4 & 5  \\
2 & 2 & 5 & 8
\end{tabular}
\end{quote}
Notice that a given functional value is equal
to the sum of the two precedent values,
i.e.,  $f_{n+1}= (+\;f_n\;f_{n-1})$. Assume that $n=5$. 
Then,  $f_6= (+\;f_5\;f_4)$.

Of course, the expression
$f_{n+1}= (+\;f_n\;f_{n-1})$
is true only for $n>0$,
since there are not two precedent
values for $n+1=0$, or $n+1=1$. 
The below programa shows how  you can state that a rule
is valid only under certain conditions.\\

\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
(define (fib n fn fn-1)
(cond ((< n 2) fn)
    (else  (fib (- n 1) (+ fn fn-1) fn)) ))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\linewidth}
\verb|> (load "fibonacci.scm")|\\
\verb|#<function>|\\
\verb|> (fib 5 1 1)|\\
\verb|8|
\end{fmpage}



\paragraph{Predicates.} A predicate
is a function that gives
true and false for output. In Scheme,
the only false value is \verb|#f|, but
any value that is different from \verb|#f|
is considered true. A predicate can be used to discover
whether a property is true for a given value.
For instance, a sequence of elements
such as \verb|'(S P Q R)| is called
list. There is also an empty list,
that has no elements at all, and
is represented by \verb|'()|. Let
\verb|xs| be a list. Then, the predicate
\verb|(null? xs)| returns \verb|#t|
if \verb|xs| is the empty list.

There are predicates designed for
performing comparisons. For instance,
\verb|(> m 2)| returns \verb|#t| for
\verb|m| greater than 2, and \verb|#f|
otherwise. Here is a more or less complete
list of comparison predicates:
\begin{itemize}
\item\verb|(> m n)| -- \verb|#t| for
\verb|m| greater than \verb|n|.
\item\verb|(< m n)| -- \verb|#t| for
\verb|m| less than \verb|n|.
\item\verb|(>= m n)| -- \verb|#t| for
\verb|m| greater or equal to \verb|n|.
\item\verb|(<= m n)| -- \verb|#t| for
\verb|m| less or equal to \verb|n|.
\item\verb|(= m n)| -- \verb|#t| if
\verb|m| is a number equal to \verb|n|.
\end{itemize}
The inputs \verb|m| and \verb|n| must
be both numbers, if you want
the above predicates to work.


A string is a sequence of characters
represented between double quotation
marks. For instance, \verb|"Sunday"|
is a string. Below, there is a short
list of string predicates.
\begin{itemize}
\item\verb|(string=? s z)| -- \verb|#t|
if \verb|s| and \verb|z| are equal.
\item\verb|(string>? s z)| -- \verb|#t|
if \verb|s|  comes
after \verb|z| in the alphabetical order.
\item\verb|(string<? s z)| -- \verb|#t|
if \verb|s| comes before \verb|z|
in the alphabetical order.
\item\verb|(string<=? s z)| -- \verb|#t| if
\verb|s| precedes or is equal to \verb|z|.
\item\verb|(string>=? s z)| -- \verb|#t| if
\verb|s| follows or is equal to \verb|z|.
\end{itemize}

The prefix \verb|#\| identifies isolated
characters. Let us assume the following
definition:
\begin{quote}
\begin{verbatim}
(define s "Nia Vardalos")
\end{verbatim}
\end{quote}
Then, the characters
\verb|#\N| \verb|#\i| 
\verb|#\a| and \verb|#\space|
were retrieved from
\verb|s| by the
expressions \verb|(string-ref s 0)|,
\verb|(string-ref s 1)|,
\verb|(string-ref s 2)| and
\verb|(string-ref s 3)|,
\verb|| respectively.

The blank space character,  control
characters, non-graphic characteres
and all other non-printable characters
can be represented by
identifiers, such as \verb|#\space|,
\verb|#\tab| and \verb|#\newline|.

Character have their own set of
predicates, as one should expect.
\begin{itemize}
\item\verb|(char=? #\A #\a)| -- is \verb|#f|
since \verb|#\A| and \verb|#\a| are not equal.
\item\verb|(char>? #\z #\a)| -- is \verb|#t|
since \verb|#\z|  comes
after \verb|#\a| in the alphabetical order.
\item\verb|(char<? #\a #\z)| -- is \verb|#t|
since \verb|#\a| comes before \verb|#\z|
in the alphabetical order.
\item\verb|(char<=? #\a #\c)| -- is \verb|#t| since
the order of \verb|#\a| is less or equal to
the order of \verb|#\c|.
\item\verb|(char>=? #\a #\c)| -- \verb|#f| since
the order of \verb|#\a| greater or equal to the
order of \verb|#\c|.
\end{itemize}

Besides predicates, Scheme uses special forms
to make decisions. The $(\textrm{and}\; p_1\;
p_2\ldots p_n)$ form
evaluates the sequence $p_1$, $p_2$\ldots $p_n$
until it reaches $p_n$ or one of the previous
$p_i$ returns \verb|#f|. In fewer words,
the and-form stops at the first
$p_i$ that returns \verb|#f| and, if no
argument is false, it stops at $p_n$.
The form returns the value of the last
$p_i$ that it evaluates. The and-form
returns a value different from \verb|#f|
if and only if all $p_i$ predicates produce
values different from \verb|#f| (false).

Like the and-form, the or-form also stops
as soon as it can. In the case of the or-form,
this means returning true as soon as any
of the arguments is true. Remember that
true is anything different from \verb|#f|.
The  $(\textrm{or}\; p_1\;
p_2\ldots p_n)$ form returns the value
of the first true $p_i$ predicate.

The \verb|(not P)| form returns \verb|#t|
if \verb|P| produces \verb|#f|, and
evaluates to \verb|#f| if \verb|P| is true,
i.e., anything different from \verb|#f|.

With the and, or and not forms, Nia can
combine primitive functions to define
many interesting predicates. For instance,
the predicate \verb|(digit? d)| determines
wether \verb|d| is a digit.
\begin{quote}
\begin{verbatim}
(define (digit? d)
(and (char>=? d #\0)
   (char<=? d #\9)))
\end{verbatim}
\end{quote}
The predicate \verb|deep-winter?| checks if
\verb|m| is 1 or 2:
\begin{quote}
\begin{verbatim}
(define (deep-winter? m)
(or (= m 1) (= m 2)))
\end{verbatim}
\end{quote}


\section{The cond-form}\label{page:cond-form}
Now that Nia knows how to find
an integer between 0 and 6 for the 
day of the week, she needs a function
that produces the corresponding name.


\begin{figure}[!h]
\begin{fmpage}{\linewidth}
\begin{verbatim}
(define (week-day n)
(cond ( (= n 0) 'Sunday)
     ( (= n 1) 'Monday)
     ( (= n 2) 'Tuesday)
     ( (= n 3) 'Wednesday)
     ( (= n 4) 'Thursday)
     ( (= n 5) 'Friday)
     ( else 'Saturday)))

(define (zeller y m day)
(let* ( (roman-month (if (< m 3) (+ m 10) (- m 2)))
      (roman-year (if (< m 3) (- y 1) y))
      (century (quotient roman-year 100))
      (decade (remainder roman-year 100)) )
 (week-day (mod (+ day
                   (quotient (- (* 13 roman-month) 1) 5)
                   decade
                   (quotient decade 4)
                   (quotient century 4)
             (* century -2)) 7)) )

\end{verbatim}
\end{fmpage}

\begin{fmpage}{\linewidth}
\verb|> (load "zeller.scm")|\\
\verb|#<function>|\\
\verb|> (zeller 2018 8 31)|\\
\verb|Friday|
\end{fmpage}
\caption{Day of the week}
\label{fig:day-of-the-week}
\end{figure}

\index{Conditional execution!cond}
\index{cond!clauses}
The cond-form controls conditional
execution, based on a set of clauses.
Each clause has a condition followed by
a sequence of actions.  Lisp starts with the
top clause, and proceeds in decending order.
It executes the first clause whose 
condition produces a value different from \verb|#f|.
For instance, the first clause condition is
the \verb|(= n 0)| predicate.
If the predicate \verb|(= n 0)| 
returns \verb|#t| for the Sunday index,
the function \verb|week-day| returns \verb|'Sunday|.
If \verb|n= 1|, the second condition holds,
and the function produces the symbol \verb|'Monday|.
And so on.


\section{Lists}
In Lisp, there is a data structure called list,
that uses parentheses to represent nested
sequences of objects. One can use lists to
represent structured data.
For instance, in the snippet below,
\verb|xor-structure| shows
the structure of a combinatorial circuit
through nested lists.

\begin{verbatim}
(define *x* 42)

(define xor
(lambda(A B)
 (or (and A (not B))
     (and (not A) B)) ))

(define xor-structure
'(or (and A  
        (not B))
   (and (not A) 
        B)))
\end{verbatim}

Although Nia does not know what a combinatorial 
circuit is, she noticed that the structure
defined as \verb|xor-structure| is prefixed by a
single quotation mark, that in Lisp parlance is
known as quote. Since Scheme uses the
same notation for programs and structured
data, the computer needs a tag to set
data apart from code. Therefore, 
quote was chosen to indicate that
an object is a list, not a procedure that
needs to be executed by the computer.

The \verb|define| form creates global
variables. In the above source code,
the variable \verb|*x*| is an id for the
number 42,
while \verb|xor| is the id for a program
that calculates the output of a two
input exclusive or gate. Of course, Nia
could define the \verb|xor| gate as shown below:
\begin{verbatim}
(define *x* 42)

(define (xor A B)
 (or (and A (not B))
     (and (not A) B)) )

(define xor-structure
'(or (and A 
        (not B))
   (and (not A) 
        B)))
\end{verbatim}

From the examples, Nia discovered that there
are two ways of defining the \verb|xor| gate
as a combination of \verb|A| input, \verb|B| input,
\verb|and| gate, \verb|or| gate
and \verb|not| gate. In the first and
most popular style, one uses the
\verb|(xor A B)| format that is a mirror of
the gate application. The advantage of
this method is that it spares one
nesting level, and shows clearly how to use
the definition. 

In the second style of defining functions and
gates, the id of the abstraction 
appears immediately after the \verb|define|
keyword. The  arguments and the body of
the definition are introduced by a lambda form:
\label{page:lambda1}\index{lambda}

\begin{verbatim}
(define xor
(lambda(A B)
 (or (and A (not B))
     (and (not A) B)) ))
\end{verbatim}

This second style is quite remarkable because
the abstraction that defines the operation
is treated exactly like any other
data type existent in the language.
In fact, there is no formal difference
between the definition of \verb|*x*|
as an integer constant, and \verb|xor|
as a functional abstraction.

\begin{figure}[!h]
\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
; File: lists.scm

(define xor-structure
'(or (and A (not B))
    (and (not A) B)))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\verb|(load "lists.scm")|\keys{Esc}\keys{~]~}\\
\verb|(or (and A (not B)) (and (not A) B))||\\
\verb||\\
\verb|(car xor-structure)| \keys{Esc}\keys{~]~} \\
\verb|or|\\
\verb|(cdr xor-structure)|\keys{Esc}\keys{~]~}\\
\verb|((and A (not B))|\\
\verb| (and (not A) B))|\\
\verb|(car (cdr xor-structure))|\keys{Esc}\keys{~]~}\\
\verb|(and A (not B))|\\
\verb|(car (cdr (car (cdr xor-structure)) ))|\keys{Esc}\keys{~]~}\\
\verb|A|\\
\verb|(car (cdr (cdr (car (cdr xor-structure)) )))|\keys{Esc}\keys{~]~}\\
\verb|(not B)|
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\verb||
\end{fmpage}
\caption{List selectors}
\label{fig:selectors}
\end{figure}


Although Scheme represents programs and
data in the same way, it does not use
the same methods to deal with source
code and lists. In the case of source
code, the compiler translates it into
a virtual machine language that the
computer can easily and efficiently
process.

Data structures, such as lists, have
an internal representation with parts. 
In particular, a list is implemented
as a chain of pairs 
(vide page~\pageref{page:cartesian-pair}),
each pair containing
a pointer to a list element,
and another pointer to the next pair. 
Let us assume that
\verb|xs| points to the list
\verb|'(S P Q R)|.
This list corresponds to the following
chain of pairs:
\begin{quote}
\begin{verbatim}
[*|*]--->[*|*]--->[*|*]--->[*|*]--->()
|        |        |        |        
S        P        Q        R       
\end{verbatim}
\end{quote}
The first pair has a pointer to \verb|S|,
and another pointer to the second pair.
The second pair contains pointers to 
\verb|P| and to the third pair. 
The third pair points to \verb|Q| and
to the fourth pair. Finally, the fourth
pair points to \verb|R| and to 
the \verb|()| empty list.

\begin{quote}
\begin{verbatim}
[*|*]---> next pair
|        
S      
\end{verbatim}
\end{quote}
The operation \verb|(car xs)| produces
the first pointer of the \verb|xs| 
chain of pairs. In the case of
the \verb|'(S P Q R)| list, \verb|(car xs)|
returns \verb|S|. On the other hand,
\verb|(cdr xs)| yields the pair
after the one pointed out by \verb|xs|,
i.e., \verb|'(P Q R)|. A sequence
of \verb|cdr| applications permits the user to
go through the pairs of a list. \\

\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
(define spqr
'(S P Q R))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\verb|(load "spqr.scm")|\keys{Esc}\keys{~]~}\\
\verb|(S P Q R)|\\
\verb||\\
\verb|(cdr spqr)|\\
\verb|(P Q R)|\\
\verb||\\
\verb|(cdr (cdr spqr))|\\
\verb|(Q R)|\\
\verb||\\
\verb|(cdr (cdr (cdr spqr)))|\\
\verb|(R)|
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\verb||
\end{fmpage}


If all one needs is to represent
sequences, then contiguous memory
elements could be more
practical than pairs. However, as one
can see in figure~\ref{fig:selectors},
a list element can be a nested sublist.
In this case, 
the \verb|car| part of a pair can point down to
a sublist branch. The diagram below shows
that one can reach any part of a nested
list following a chain of \verb|car| and \verb|cdr|.
In such a chain, the \verb|cdr| operation
advances one pair along the list, and
the \verb|car| operation goes down into a sublist.
The \verb|cdr| operation is equivalent to a
right $\rightarrow$  arrow, while the \verb|car|
operation is acts like a down $\downarrow$ arrow.
\begin{quote}
\verb"     "$\rightarrow$\verb"       "$\rightarrow$\\
\verb"[*|*]cdr-[*|*]cdr---[*|*]--()"\\
\verb" |        |         car"$\downarrow$\\
\verb" |        |          |  " $\rightarrow$\\
\verb" |        |         [*|*]cdr-[*|*]---[*|*]---()"\\
\verb" |        |          |       car"$\downarrow$\verb"     |"\\
\verb" |        |          |        |       |"\\
\verb" |        |          |        |       B"\\
\verb" |        |          |        |  "\\
\verb" |        |         and      [*|*]---[*|*]---()"\\
\verb" |        |                   |       |"\\
\verb" |        |                   |       |"\\
\verb" |        |                  not      A"\\
\verb" |        |"\\
\verb" or      [*|*]---[*|*]---[*|*]---()"\\          
\verb"          |       |       |"\\                     
\verb"         and      A      [*|*]---[*|*]---()"\\  
\verb"                          |       |"\\                     
\verb"                         not      B"                    
\end{quote}
The above example shows the chains and subchains of
pairs that one uses to represent the logic
circuit below:
\begin{quote}
\begin{verbatim}
(define xs
'(or 
     (and  A  
           (not B))
                    (and (not A)
                         B)))
\end{verbatim}
\end{quote}

Let us assume that Nia wants to retrieve the
\verb|(NOT A)| part of the circuit. Considering
that each right $\rightarrow$ arrow is equivalent
to a \verb|cdr| operation, and each down $\downarrow$
arrow can be interpreted as a \verb|car| operation,
she must perform \verb|(car (cdr (car (cdr (cdr xs)) )))|
to reach the goal.


\section{Processing text from the editor}
Let us learn how to retrieve a selection such as
\verb|"(2016 8 31)"| from femtoemacs,
transform it into the \verb|'(2016 8 31)|
list, and calculate the corresponding
day of the week.

To select the string, press \verb|C-Spc|
at the first character, and
move the cursor onto the last character.

The problem is that the clipboard
contains a string like \verb|"(2016 8 31)"|, and
the \verb|zeller| function defined in needs a list.
Therefore, Nia needs a procedure to
read a list from a string of characters.

\begin{quote}
\begin{verbatim}
(load (home "aliases.scm"))

(define (read-string str)
(let ( (port (open-input-string str)))
  (begin0 (read port)
    (close-input-port port)) ))
\end{verbatim}
\end{quote}

All languages open ports for reading things
from files. Lisp is no exception, but for
the fact that one can open objects like
strings, and read complex objects such
as a whole list. These powerful features
can be seen in the above definition.
The \verb|begin0| form evaluates a sequence
of expressions, and returns the first
one as the result of the whole sequence.
The \verb|begin0| was necessary in the 
definition of \verb|read-string| because
Nia needs the result of \verb|(read port)|,
and cannot close the port before finishing
the reading. The solution for this problem
is to execute \verb|(read port)|, 
the \verb|(close-input-port port)|, and
finally return the produce of \verb|(read port)|.

The \verb|week-day| function transform
a number \verb|n| between 0 and 6 into
strings corresponding to the seven
days of the week:
\begin{quote}
\begin{verbatim}
(define (week-day n)
(symbol->string
(cond ( (= n 0) "Sunday")
      ( (= n 1) "Monday")
      ( (= n 2) "Tuesday")
      ( (= n 3) "Wednesday")
      ( (= n 4) "Thursday")
      ( (= n 5) "Friday")
      ( (= n 6) "Saturday")
      (else "This should not happen")) ))
\end{verbatim}
\end{quote}

\paragraph{Calculating the day of the week.}
Zeller congruence, as given in
figure~\ref{fig:day-of-the-week}
and repeated below 
for ready reference,
can be used to calculate the
day of the week.
\begin{verbatim}
(define (zeller y m day)
(let* ( (roman-month (if (< m 3) (+ m 10) (- m 2)))
      (roman-year (if (< m 3) (- y 1) y))
      (century (quotient roman-year 100))
      (decade (remainder roman-year 100)) )
 (week-day (mod (+ (quotient (- (* 13 roman-month) 1) 5)
                   decade
                   (quotient decade 4)
                   (quotient century 4)
                   (* century -2)
                   day) 7)) ))
\end{verbatim}

The last step is to program a command
that calculates the day of the week
into the editor. Here Nia uses the
cond-form again, to select one of 
many commands that the user may press.

The keys \verb|C-c a|, \verb|C-c b|,
until \verb|C-c z| are reserved for
customization, which means that you
can hook any Lisp program onto them.
For instance, if Nia wants to wrap
the clipboard contents with the
html-tags \verb|<p>| and \verb|</p>|,
besides calculating the day of 
the week, she may define the
following keyboard:
\begin{quote}
\begin{verbatim}
(define (keyboard key) 
(cond
( (equal? key "C-c z")
  (let ( (date (read-string (cutregion)) ))
    (insert (apply zeller date)) ))
  ( (equal? key "C-c p") 
    (insert "<p> </p>")
    (backward-char 5))
  ( (equal? key "C-c c")
    (end-of-line)
    (insert "<p>-")
    (insert (clipboard))
    (insert "-</p>"))
  (else (insert key)) ))
\end{verbatim}
\end{quote}
The \verb|(apply zeller date)| operation
applies \verb|zeller| 
to the three elements of the  \verb|date| list,
which contains the year, month and day of interest.

\paragraph{;;Syntax highlight.}

\begin{verbatim}
;; define syntax highlighting for scheme files
(newlanguage ".scm" ";" "#|" "|#")
(keyword "define")
(keyword "cond")
(keyword "else")

;; define syntax hughlighting for C code
(newlanguage ".c" "//" "/*" "*/")
(keyword "auto")
(keyword "break")
(keyword "case")
(keyword "char")
(keyword "continue")
(keyword "default")
(keyword "do")
(keyword "double")
(keyword "else")
(keyword "enum")
(keyword "extern")
(keyword "float")
(keyword "for")
(keyword "goto")
(keyword "if")
(keyword "int")
(keyword "long")
(keyword "register")
(keyword "return")
(keyword "short")
(keyword "signed")
(keyword "sizeof")
(keyword "static")
(keyword "struct")
(keyword "switch")
(keyword "typedef")
(keyword "union")
(keyword "unsigned")
(keyword "void")
(keyword "volatile")
(keyword "while")
\end{verbatim}

\section{The list constructor}\index{List!cons}
Since the \verb|car| and \verb|cdr| operations
select the two parts of a pair, they are called
{\em selectors}.
Besides the two selectors, lists have a
constructor: The operation \verb|(cons x xs)| builds a pair
whose first element is \verb|x|, and the 
remaining elements are grouped in \verb|xs|.

\begin{quote}
\verb|(cons 'and '(A B))|\keys{Esc}\keys{~]~}\\
(and A B)
\end{quote}

One has learned previously that lists must be
prefixed by the special quote operator,
in order to differentiate them from programs.
To make a long story short, quote  prevents
the evaluation of a list or symbol.

When you first heard about pairs on
page~\pageref{page:cartesian-pair},
it was stated that the first element
of a pair is separated from the 
second by a dot. However, the dot
can be omitted if the second element
is itself a cartesian pair or
the empty list. Then,
the  much neater 
\verb|'(3 4)| list syntax is equivalent 
to the dotted Cartesian \verb|'(3 . (4 . ()))| pair.

A backquote, not to be confused with quote, also prevents
evaluation, but the backquote transforms the list 
into a template.\index{List!backquote}
When there appears a comma in the 
template, Lisp evaluates the expression following
the comma\index{List!comma}
and replaces it with the result. 
If a comma is combined with \verb|@| to produce
the \verb|,@| at-sign,\index{List!at-sign}
then the expression following the at-sign 
is evaluated to create a list. This list is
spliced into place in the template. 
Templates are specially useful for creating
macros, as you will learn below.

Macros are programs that brings a more convenient
notation to a standard Lisp form. The syntax of Lisp,
that unifies data and programs, makes it possible to
create powerful macros that implement Domain Specific
Languages (DSLs), speed up coding or create new software
paradigms. In fact, the macro system is one of the
two features that places Lisp asunder from other
languages, the other being its Mathematical Foundations.
For learning macros in depth, the reader is referred to
Dough Hoyte's book on the subject\cite{Hoyte}.
The example below can be placed into the
\verb|init.lsp| file or into the \verb|aliases.scm|
file. Remember that these two configuration
files must be copyed to your home directory.

\begin{verbatim}
(define-macro (while-do  c r . bdy)
`(do () ((not ,c) ,r) ,@bdy))
\end{verbatim}

In the above macro definition,
the  \verb|bdy| variable, which
comes after a dot, groups all
remaining macro parameters.
The syntax of Lisp requires that
a blank space is inserted before
and after the dot.

Nia creates a \verb|repl.scm| buffer
and tests the \verb|while-do| macro,
as you can see in the following example:\\

\begin{fmpage}{0.8\linewidth}
\verb|(let ( (s '())|\\
\verb|       (i 0))|\\
\verb|   (while-do (< i 5) n|\\
\verb|       (set! s (cons i s))|\\
\verb|       (set! i (+ i 1)) ))| \keys{Esc}\keys{~]~}\\
\verb|(4 3 2 1 0)|\\
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\verb||
\end{fmpage}

\vspace{0.5cm}
The \verb|(set! i (+ i 1))| operation
destructively updates the value
of the local variable \verb|i|.
For instance, if \verb|i| is
equal to 3, the value of \verb|i|
is replaced with \verb|(+ i 1)|,
what makes \verb|i| equal to 4.
On the same token, \verb|(set! s (cons i s))|
replaces the value of \verb|s| with
\verb|(cons i s)|. Then, if \verb|s= (2 1 0)|
and \verb|i= 3|,
\verb|(set! s (cons i s))| updates \verb|s|
to \verb|(cons 3 '(2 1 0))= '(3 2 1 0)|.

Destructive updates are not
considered good programming practice.
In fact, the \verb|set!| operation has
an exclamation mark to remember you
that it should not be used lightly.
By the way, \verb|set!|
is pronounced as {\em set bang}.

The \verb|while-do| macro is not very useful,
since Scheme programmers adopt the functional
style, which abhor the use of set bang.
A much more interesting macro is the
Curry operator, that comes pre-defined thus:
\begin{quote}\label{page:lambda2}\index{lambda}
\begin{verbatim}
(define-macro (curry fn x)
(let ( (g (gensym)))
`(lambda(,g) (,fn ,g ,x)) ))
\end{verbatim}
\end{quote}
In order to understand this macro, you
must learn the concept of lambda abstraction.
You have learned how to define functions
that have names. However,
Lisp alows the creation of
an anonymous functions.
Suppose that you want to filter the
elements of a list, leaving only those
that are greater than a given number.
You can use the following expression:
\begin{quote}
\begin{verbatim}
(filter (lambda(x) (> x 4)) '(3 2 4 1 6 9 8))
(6 9 8)
\end{verbatim}
\end{quote}
Of course, you could have defined a 
\verb|g4| function and use it as shown below.
\begin{quote}
\begin{verbatim}
(define (g4 x) (> 4 x))

(filter g4 '(3 2 4 1 6 9 8))
(6 9 8)
\end{verbatim}
\end{quote}
This solution has a flaw: It requires a
definition for every number that you
want to filter, which is simply impossible.
Fortunately, the lambda abstraction comes
to your rescue, since it 
creates a predicate on the fly for every
number that you want to filter. The Curry
macro is a handier method to define a lambda
abstraction:
\begin{quote}
\begin{verbatim}
(filter (curry > 4) '(3 2 4 1 6 9 8))
(6 9 8)
\end{verbatim}
\end{quote}

Perhaps you are not convinced of the
necessity of defining the curry macro.
After all, who  needs to filter a list
for elements greater than a given number?
I will try to give an answer to this
question.

Let us assume that you have a list
of words and needs to sort it
to build a spell checker. The sorting
program is given below.



\begin{figure}[!h]
\begin{fmpage}{\linewidth}
\begin{verbatim}
(define (quick-sort s)
(cond ((null? s) s)
     ((null? (cdr s)) s)
     (else 
      (append 
         (quick-sort (filter (curry string>? (car s)) 
                             (cdr s)))
         (list (car s))
         (quick-sort (filter (curry string<=? (car s))
                             (cdr s))) ) )))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{\linewidth}
\verb|> (load "quick.scm")|\\
\verb|#<function>|\\
\verb|> (quick-sort '("Caecilia" "Anna" "Priscilla"))|\\
\verb|(Anna Caecilia Priscilla)|
\end{fmpage}
\caption{The filter function}
\label{fig:filter}
\end{figure}

In listing~\ref{fig:filter}, the deffinition of
\verb|quick-sort| calls \verb|quick-sort| itself.
When such a thing happens, computer scientists
say that the function is recursive.

It is possible to understand how a recursive
function works by following its execution
step by step. In fact, this has been done
for the \verb|avg| function, in section~\ref{sec:average},
page~\pageref{sec:average}. However, a much
better approach is to study the function logically.

The \verb|append| function appends its
arguments, that are supposed to be lists.
Let us assume that the the \verb|quick-sort|
function was called by the following expression:
\begin{quote}
\verb|> (quick-sort '("g" "a" "c"  "h" "n" "b"))|
\end{quote}
The \verb|(filter (curry string>? (car s)) (cdr s))|
expression will filter all strings that comes before
\verb|"g"| and return the \verb|("a" "c" "b")|.
A recursive call to \verb|quick-sort| will
sort this list, producing the first argument
of \verb|append|, to wit, \verb|("a" "b" "c")|.

The second argument of \verb|append| is
given by the \verb|(list (car s))| expression.
Since \verb|s= '("g" "a" "c"  "h" "n" "b")|,
and the \verb|list| function builds a list
from its arguments, one
has \verb|(list (car s))= '("g")|.

The third argument of \verb|append| will
be the sorted list of all strings in \verb|s|
that are greater or equal to \verb|"g"|,
i.e., \verb|("h" "n")|.

The value of the \verb|(append '("a" "b" "c") '("g") '("h" "n"))|
expression produces the final result, that is
\verb|("a" "b" "c" "g" "h" "n")|.

\chapter{Recursion}\label{chapter:Recursion}
\index{Recursion}
The mathematician Peano invented a very interesting axiomatic theory for
natural numbers. I cannot remember the details, but the idea was
something live the following:
\begin{enumerate}\index{Recursion!Peano's axioms}
\item Zero is a natural number.
\item Every natural number has a successor: The successor of 0 is 1, the
successor of 1 is 2, the successor of 2 is 3, and so on.
\item If a property is true for zero and, after assuming that it is true for n,
you prove that it is true for n+1, then it is true for any natural number.
\end{enumerate}
Did you get the idea? For this very idea can be applied to many other
situations. When they asked Myamoto Musashi, the famous Japanese
Zen assassin, how he managed to kill a twelve year old boy protected by his
mother's 37 samurais\footnote{The boy's father had been killed by Musashi. His uncle met the the same fate. His
mother \index{Recursion!According to Musashi} hired her late husband's students to protect the child against Musashi.}, he answered:
\begin{quote} \em
I defeated one of them, then I defeated
the remaining 36. To defeat 36, I defeated one of them, then I defeated
the remaining 35. To defeat 35, I defeated one of them, then I defeated the
remaining 34\ldots \\
\ldots~~~~~~~\ldots~~~~~~~\ldots\\
To defeat 2, I defeated one of them, then I defeated the other.
\end{quote}
A close look will show that 
the function \index{Recursion!Append!Definition}
Append of Listing~\ref{rec/app} acts like
Musashi. The first
clause of \verb|(App xs s)| states that
appending a \verb|(null? xs)| list to
\verb|s| produces \verb|s|. The second 
clause of \verb|(App xs s)|  states: To
append a \verb|xs| list to an \verb|s| list,
rewrite the calling 
\verb|(App xs s)| expression
as \verb|(cons (car x) (App (cdr xs) s))|.
Let us pick a more concrete instance of the problem.

Nia evaluated \verb|(App '(1 2 3) '(4 5))|.
This calling pattern was matched to
\verb|(App xs s)|
with \verb|xs= '(1 2 3)| and \verb|s= '(4 5)|.
Since \verb|(null? xs)| is false, the second
clause rewrite the calling pattern as:
\begin{quote}
\verb|(cons (car xs) (App (cdr xs) s))|
\end{quote}
which the inference engine reduces to 
\begin{equation}
\verb|(cons 1 (App '(2 3) '(4 5)))|
\label{app:1}
\end{equation}
The \verb|(App '(2 3) '(4 5))| subpattern
matches once again with \verb|(App xs s)|,
this time making \verb|xs= '(2 3)|
and \verb|s= '(4 5)|. Since \verb|(null? xs)|
is false, the second clause holds, and the
\verb|(App '(2 3) '(4 5))| is rewritten as
\begin{quote}
\verb|(cons 2 (App '(3) '(4 5)))|.
\end{quote}
Therefore, equation~\ref{app:1} becomes:
\begin{equation}
\verb|(cons 1 (cons 2 (App '(3) '(4 5))))|
\label{app:2}
\end{equation}

The calling pattern \verb|(App '(3) '(4 5))|
matches to \verb|(App xs s)| with
\verb|xs= '(3)| and \verb|s= '(4 5)|.
For the last time, the second clause is
chosen, and expression~\ref{app:2} becomes:
\begin{equation}
\verb|(cons 1 (cons 2 (cons 3 (App '() '(4 5)))))|
\label{app:3}
\end{equation}
The pattern \verb|(App '() '(4 5))| matches
to \verb|(App xs s)| with \verb|xs= '()|
and \verb|s= '(4 5)|. This 
time, \verb|(null? xs)| is true,
and the calling pattern reduces to \verb|s|,
which is equal to \verb|'(4 5)|, and
expression~\ref{app:3} can be rewritten as:
\begin{quote}
\verb|(cons 1 (cons 2 (cons 3  '(4 5))))= '(1 2 3 4 5)|
\end{quote}


\begin{figure}[!b]
\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
(define (App xs s)
(cond ( (null? xs) s)
    (else (cons (car xs) (App (cdr xs) s)) )))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
> (App '(1 2 3) '(4 5))
(1 2 3 4 5)
\end{verbatim}
\end{fmpage}
\caption{Append}
\label{rec/app}
\end{figure}


\section{Classifying rewrite rules}\index{Recursion!Classifying rules}
Typically a recursive definition has two kinds of clauses:
\begin{enumerate}
\item Trivial cases, which can be \index{Recursion!Trivial case} 
resolved using primitive operations.
\item General cases, which can be \index{Recursion!General case} 
broken down into simpler cases.
\end{enumerate}
Let us classify the two clauses of \verb|(App xs s)|:\\

\verb||\\
\begin{tabular}{p{5cm}p{7cm}}
\verb|( (null? xs) s)| & The first clause is certainly trivial\\
\\
\verb|(else |

\verb|  (cons (car xs)|

\verb|    (App (cdr xs) s)))|
& The second equation can be
broken down into simpler
operations: Appending two
lists with one element
removed from the first,
and then inserting the element
left out into the result.\\
\end{tabular}


\section{Quick Sort}
Although Hoare's Quick Sort algorithm is
of little practical use in these days of BTree everywhere, it gives a good illustration
of recursion. The problem that Hoare solved consists of sorting a list.

The \verb|(smaller xs p)| function returns
all elements of \verb|s| that are smaller
than the \verb|p| pivot. 
The \verb|(greater xs p)| produces the
list of the \verb|s| elements that are
greater or equal to \verb|p|. Therefore the
\verb|(quick xs)| function partitions 
\verb|xs| into three lists, then sorts
and appends these lists:
\begin{itemize}
\item \verb|(smaller (cdr s) (car s))|--
numbers smaller than \verb|(car s)|
\item \verb|(list (car s))| 
\item \verb|(greater (cdr s) (car s))|--
numbers greater or equal to \verb|(car s)|.
\end{itemize}
If you sort, then concatenate these three lists,
you will end up sorting the original list.
A concrete case will make this fact clear.
Let \verb|s| be the list \verb|'(4 3 1 5 2 8 7)|.
The expression
\verb|(quick (smaller (cdr s) (car s)))|
returns \verb|'(1 2 3)|.
The expression
\verb|(quick (greater (cdr s) (car s)))|
generates \verb|'(5 7 8)|. Finally, 
the 
\verb|(append '(1 2 3) '(4) '(5 7 8))|
application
returns \verb|'(1 2 3 4 5 7 8)|.

In the quicksort algorithm,
there are two trivial cases,
the empty \verb|'()| list
and lists with a single element,
either of which
do not require sorting.

Lists with two or more elements
are sorted by breaking them into
smaller sublists. Since they are
closer to the trivial cases,
one can assume that the smaller sublists
are easier to sort.

Figure~\ref{quicksort} shows a complete
implementation of the quicksort algorithm
for a list of numbers.

\begin{figure}[!h]
\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
;; File: quicksort.scm


;; Output: elements of xs that are smaller than p

(define (smaller xs p)
(cond ( (null? xs) xs)
    ( (< (car xs) p)
      (cons (car xs)
            (smaller (cdr xs) p)))
    (else (smaller (cdr xs) p)) ))


;; Output: elements of xs greater or equal to p

(define (greater xs p)
(cond ( (null? xs) xs)
    ( (>= (car xs) p)
      (cons (car xs)
            (greater (cdr xs) p)))
    (else (greater (cdr xs) p)) ) 

(define (quick s)
(cond ( (null? s) s)
    ( (null? (cdr s)) s)
    (else (append 
            (quick (smaller (cdr s) (car s)))
                  (list (car s))
                  (quick (greater (cdr s)
                                  (car s))) )) ))

\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
> (quick '(4 3 1 5 2 8 7))
(1 2 3 4 5 7 8)
\end{verbatim}
\end{fmpage}
\caption{The quicksort algorithm}
\label{quicksort}
\end{figure}

\section{Named-let}

Even before learning recursivity,
Nia studied the Fibonacci
function on page~\pageref{page:Fibonacci}.
The Fibonacci function has the
undesirable characteristic of
requiring two auxiliary arguments.
Nia cannot forget to initialize
these dummy arguments, otherwise
she will get an error message,
instead of a result. 

The named-let\index{Named-let}\index{Loop!named-let}
permit the creation of functions
with initialized arguments, avoiding
the definition of anomalous functions
that require manual initialization.

\begin{figure}[!h]
\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
(define (fibo i)
(let fn+1 ( (n i) (fn 1) (fn-1 1) )
  (if (< n 2) fn
      (fn+1 (- n 1) (+ fn fn-1) fn)) ))

\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
> (load "Fibonacci.scm")
#<function>
> (fibo 5)
8
\end{verbatim}
\end{fmpage}
\caption{One argument Fibonacci function}
\label{oneargfib}
\end{figure}

The named-let binding is used mainly
to loop. In this sense, it is not
different from looping facilities
that one can find in languages like C
or Python. However, the named-let
binding has an important advantage
over other loop facilities: One can
give a meaningful 
name\index{Named-let!meaningful name for loop}
to scheme loops.
For instance, since the loop of
figure~\ref{oneargfib} is used 
to calculate the \verb|fn+1| iteration,
Nia put the \verb|fn+1| tag on it.

There is another way to get rid of
auxiliary 
parameters:\index{Local variables!auxiliary parameters}
One can initialize the parameters
of a definition with
default values,\index{Local variables!default values}
as shown
in figure~\ref{accumulators}.


\begin{figure}[!h]
\begin{fmpage}{\linewidth}
\begin{verbatim}
(define (avg s (sum 0) (n 0))
(cond ( (and (null? s) (= n 0)) 0)
    ( (null? s) (/ sum n) )
    (else (avg (cdr s) (+ (car s) sum) (+ n 1.0)) )))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{\linewidth}
\begin{verbatim}
> (load "defaults.scm")
#<function>
> (avg '(3 4 5 6))
4.5
\end{verbatim}
\end{fmpage}
\caption{Accumulator parameters}
\label{accumulators}
\end{figure}

\section{Reading data from files}

Figure \ref{rdFile} reads the contents
of a file line by line and insert
the corresponding
strings into the buffer. However, before
sending a string to the buffer,
\verb|(port->lines p)| prefixes it
with a commented line number.

\begin{figure}[!h]
%%\renewcommand\figurename{Fig.}
\begin{fmpage}{\linewidth}
\begin{verbatim}
;; File: insFile.scm
;; The procedure (rdLines <filename>) reads
;; a Lisp file, and inserts its contents
;; into the current buffer.

(define (port->lines p)
(let next-line ( (i 1) (x (read-line p)) )
(cond ( (eof-object? x) #t)
      (else 
        (insert "#") (insert "| ")
        (insert (number->string i))
        (cond ( (< i 10)  (insert "    |# "))
              ( (< i 100) (insert "   |# "))
              (else       (insert "  |# ")))
        (insert x) (insert "\n")
        (next-line (+ i 1) (read-line p))) )))

(define (rdLines filename)
(call-with-input-file filename port->lines))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{\linewidth}
\begin{verbatim}
> (load "insFile.scm")
#<function>
> (rdLines "test.scm")
\end{verbatim}
\end{fmpage}
\caption{Lines from file}
\label{rdFile}
\end{figure}

Lisp has a cleverly designed input system.
The \index{call-with-input-file} \index{Input from file}
\verb|call-with-input-file| \label{page:call-with-input-file}
procedure has two arguments. The first
argument is the file name. 
The second argument is
a single parameter function such
as \verb|port->lines|. In the example
of figure~\ref{rdFile}, Lisp 
opens a file, and pass the file descriptor
to the \verb|port->lines| procedure.

The definition of \verb|(port->lines p)|
assigns a line that it reads 
from port \verb|p|
to the variable \verb|x|. Then \verb|x|
is inserted in the buffer, and \verb|loop|
proceeds to read the next line.
The iteration stops when 
end of file is reached.

\section{Writing data to files}
Let us assume tha Nia needs 
a femtolisp program that translates
markdown to html. She wants to
use the program to publish poems
in the internet. Here an example
of markdown:
\begin{quote}
\begin{verbatim}
# To Helen
## By Edgard Alan Poe

Helen, thy beauty is to me
Like those Necéan barks of yore,
That gently, o'er a perfumed sea,
The weary, way-worn wanderer bore
To his own native shore.

On desperate seas long wont to roam,
Thy hyacinth hair, thy classic face,
Thy Naiad airs have brought me home
To the glory that was Greece,
And the grandeur that was Rome.

Lo! in yon brilliant window-niche 
How statue-like I see thee stand, 
The agate lamp within thy hand! 
Ah, Psyche, from the regions which 
Are Holy-Land! 
\end{verbatim}
\end{quote}

The program of listing~\ref{wrtFile}
reads a markdown file line by line.
If the line starts with the \verb|##| prefix,
it will be wrapped in the \verb<h1>...</h1>|
html tag. If its first char is the \verb|#\#|
prefix, but the second char is different
from \verb|#\#|, it will be wrapped in
the \verb|<h2>...</h2>| html tag.

The simplified version of the html
generator of listing~{wrtFile} treats
only titles, line breaks and paragraphs.
However, the interested reader will
be able to add other html elements.

You have already learned how the
procedure \verb|call-with-input-file| works.
If you don't remember, take a look at
page~\pageref{page:call-with-input-file}.

The procedure\index{call-with-output-file}
\verb|call-with-output-file|\index{Output to file}
can be\index{Output to file!call-with-output-file}
applied to a file name and a function
with an output port as argument. One could
define the output port function, but
usually people use a lambda abstraction
to perform the magic. Read again the
explanation about the lambda abstraction
on pages~\pageref{page:lambda1}
and~\pageref{page:lambda2}. File input/output
must be mastered to perfection.

\begin{figure}[!h]
\begin{fmpage}{\linewidth}
\begin{verbatim}
(define (tag i <h> x </h> )
(let ( (Len (string-length x)))
(string-append <h>
  (substring x i (- Len 1)) </h> "\n")))

(define (subtitle? x)
(and (> (string-length x) 4)
    (char=? (string-ref x 0) #\#)
    (char=? (string-ref x 1) #\#)))

(define (title? x)
(and (> (string-length x) 3)
   (char=? (string-ref x 0) #\#)))

(define (convert in out)
(let loop ( (x (read-line in)) )
 (cond ( (eof-object? x) #t)
       ( (subtitle? x)
         (display (tag 2 "<h2>" x "</h2>") out)
         (loop (read-line in)))
       ( (title? x)
         (display (tag 1 "<h1>" x "</h1>") out)
         (loop (read-line in)))
       ( (> (string-length x) 1)
         (display x out)
         (display "<br/>\n" out)
         (loop (read-line in)))
       (else (display "<p/>\n" out)
             (loop (read-line in)))  )))

(define (copyFile inFile outFile)
(call-with-output-file outFile
 (lambda(out) (call-with-input-file inFile
                 (lambda(in) (convert in out))) )))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{\linewidth}
\begin{verbatim}
> (load "toHtml.scm")
#<function>
> (copyFile "toHelen.txt" "helen.html")
#t
\end{verbatim}
\end{fmpage}
\caption{Writing data to a file}
\label{wrtFile}
\end{figure}

\chapter{Cloud computing}\label{cloud-computing}
A compiler is a program that reads
source code into a language that
human beings can handle easily
and translates the aforementioned
code to an object language that
computers can interpret.
For instance, Nia writes source code
in   Scheme.
The library \verb|r5rs.scm| translates
it into femtolisp.
Then a compiler translates femtolisp
into instructions that the
computer can carry out efficiently.

\includegraphics[scale=0.8]{figs/source.png}


The problem is that the
compiler installed on
Nia's machine deals with a language
called femtolisp, while Nia 
works with  Scheme. Nia can work in a
language different from the compiler
only because the library \verb|r5rs.scm| provides
a bridge between Scheme and the
femtolisp compiler.


In this chapter, you will learn how
to write a web application in pure
femtolisp. Thus, you can leap frog
the translation from Scheme to femtolisp.
But firstly,
let us learn what cloud computing is.

Cloud computing is an Internet based
computer that provides shared
processing  on demand for those people
connected to a service provider.
When a  company adheres to cloud computing,
it avoids infrastructure costs,
such as purchasing servers, and keeping
them in working order.

The \verb|https://www.cloudorado.com|
site shows that provider fees
can be pretty steep.
However, one can hire a normal
hosting service and use it for
creating pages that are able to
run quite interesting applications.

When you hire a hosting service,
you will receive a user name and
will be requested to
buy a domain name. Let us
assume that Nia owns the
\verb|medicina.tips| domain,
where {\sc medicina} means
health care in Latin. The domain
may be any sequence of chars,
but it is a good idea to choose
names that raise interest in
Web users. Since doctors usually
know some Latin, if one wants to offer
expert medical consultancy, \verb|medicina.tips|
is a good name.
Now that Nia has a user name and a
domain, she must install femtolisp
in her cloud machine. Here is how
she enters the shell:
\begin{quote}
\begin{verbatim}
~$ ssh -p2222 nia@medicina.tips
nia@medicina.tips's password: ***
\end{verbatim}
\end{quote}
The 2222 port is used in the secure shell protocol
that connects Nia to the cloud computer.
She needs a password to complete the connection.
\begin{Verbatim}[fontsize=\small,
frame=single,
framerule=0.5mm]
Last login: Sun Sep 25 18:03:00 2016 from 179.155.71.6
~$ cd public_html
~/public_html$ mkdir lsp
~/public_html$ cd lsp
~/public_html/lsp$ echo "Addhandler cgi-script .lsp" > .htaccess
\end{Verbatim}
The \verb|.htaccess| file specifies 
an extension for running lisp scripts on the web.

The cloud terminal  is called
jailshell. The jailshell does not allow Nia
to access the \verb|/usr/local| folder.
Therefore, she needs to send the \verb|flisp| compiler and
\verb|flisp.boot| to her cloud home directory.
\begin{Verbatim}[fontsize=\small,
frame=single,
framerule=0.5mm]
~/Femto-Emacs/femtolisp$ scp -P2222 flisp nia@medicina.tips:~
nia@medicina.tips's password: ***
~/Femto-Emacs/femtolisp$ scp -P2222 flisp.boot nia@medicina.tips:~
nia@medicina.tips's password: ***
\end{Verbatim}
An important note: The scp command sends files to
the cloud. In the example, Nia sends the \verb|flisp|
compiler and the \verb|flisp.boot| file
to her  \verb|nia@medicina.tips| home folder.
N.B. The \verb|scp| command takes the -P2222
port directive with uppercase P,
but the \verb|ssh| command requires lowercase p.

Again, all the above procedures are easier to perform
than to explain. The best approach is to hire a private
tutor who is  majoring in Computer Science.
Usually, two or three classes are enough to
learn jailshell, ssh and scp.
If you do not want to spend money with
a tutor,  you can ask for
technical support from your hosting service. 
If you are a really lucky, the attendant
answering your call is sufficiently well
informed to help you.

\section{HTML page}
Hypertext Markup Language, or html for short, is the most
common language used to format documents
for presentation on the World Wide Web.
Html uses hundreds of different directives to define
a layout for web pages. Each directive requires an
opening \verb|<tag>| and a closing \verb|</tag>|.

\index{princ}

\begin{figure}[!h]
\begin{verbatim}
<html>
<head>
<title>femtolisp tutorial</title>
  <meta http-equiv= 'Content-Type'
     content= 'text/html; charset=utf-8' />
</head>
<body>
<form name='form' method='get'>
  <input type='text' name='temp'>
  <input type='submit' name='btn' value='send'>
</form>
<p>La réponse est  
> (let ( (str (os.getenv "QUERY_STRING")))
>    (if str (princ str) (princ "vide"))
>       (newline))
</p>
</body>
</html>
\end{verbatim}
\caption{qstring.script}
\label{lst:qstring.script}
\end{figure}

In listing~\ref{lst:qstring.script}, one can see
that an html document may contain lisp
snippets for performing calculations. Let us
indicate the lisp code with the \verb|>| prefix
as the first char of the line.

As you already know, online shops
present forms that their clients need to fill out
for placing an order. The form of
listing~\ref{lst:qstring.script}
has two input widgets, a text field and
a button. The \verb|<input type='text' name='temp'>|
widget is the \verb|temp| text field.
Its value is whatever the client types into the field.

The \verb|<input type='submit' name='btn' value='send'>|
widget is a button with a fixed value equal to \verb|send|.

\includegraphics[scale=0.5]{figs/form.png}

\section{Script}
A program that generates
web pages is called a script.
Usually, an html page formats the text
and presents it on your browser.
A dynamic page can use lisp to add
calculation to the document.

The result of applying 
\verb|(copyFile "qstring.script" "qstring.lsp")|
to  listing~\ref{lst:qstring.script}
is the script given on listing~\ref{lst:qstring.lsp}.

\begin{figure}[!h]
\begin{verbatim}
#! /home/strue028/flisp
(princ "Content-type: text/html")(newline)(newline)
(princ "<html>\n")
(princ "  <head>\n")
(princ "    <title>femtolisp tutorial</title>\n")
(princ "      <meta http-equiv= 'Content-Type'\n")
(princ "         content= 'text/html; charset=utf-8' />\n")
(princ "   </head>\n")
(princ " <body>\n")
(princ "   <form name='form' method='get'>\n")
(princ "      <input type='text' name='temp'>\n")
(princ "      <input type='submit' name='btn' value='send'>\n")
(princ "  </form>\n")
(princ "  <p>La réponse est  \n")
(let ( (str (os.getenv "QUERY_STRING")))
(if str (princ str) (princ "vide"))
   (newline))
(princ "  </p>\n")
(princ "</body>\n")
(princ "</html>\n")
(princ "\n")
\end{verbatim}
\caption{qstring.lsp}
\label{lst:qstring.lsp}
\end{figure}

Listing~\ref{lst:qstring.lsp} shows
the structure of the lisp script.
The first line calls the femtolisp
compiler. The prefix \verb|#!|
is known as shebang and indicates
the full path of the compiler.

The script must print the
\verb|Content-type: text/html| header
followed by two newline chars.

\section{Script generator}
\index{Output to file!with-output-to}
\index{Output to file!(file outFile :write :create)}

The function \verb|(copyFile "qstring.script" "qstring.lsp")|
defined in the \verb|webscript.scm| file reads the
\verb|qstring.script| line by line.

\index{String!string.count}
\index{String!string.sub}

\begin{figure}[!h]
\begin{verbatim}
(define (lisp? x)
(and (> (string.count x) 3)
   (= (aref x 0) (aref ">" 0)) ))

(define (readLn) (io.readline *input-stream*))

(define (convert)
(let loop ( (x (readLn)) )
 (cond ( (eof-object? x) #t)
       ( (lisp? x)
         (princ (string.sub x 1 (string.count x))) 
         (newline)
         (loop (readLn))) 
       (else (newline)
             (princ "(princ ")
             (write x)
             (princ ")") (newline)
             (loop (readLn)) )) ))

(define (copyFile inFile outFile)
(let ( (in (file inFile :read))
     (out (file outFile :write :create)) )
(with-output-to out
  (with-input-from in   
     (princ "#! /home/strue028/flisp") (newline)
     (princ "(princ \"Content-type: text/html\")")
     (princ "(newline)")
     (princ "(newline)")
     (newline) (convert) (newline)))
(io.close in)
(io.close out)))
\end{verbatim}
\caption{webscript.scm -- Script generator}
\label{lst:webscript.scm}
\end{figure}



If the line
starts with the \verb|>| prefix, it is a lisp
program, and is copied to \verb|qstring.lsp| as is,
i.e., with all its legal disclaimer.

If the line is an html directive, \verb|copyFile|
generates the lisp operation to print it. For instance,
if \verb|(rdLine)| reads the line below:
\begin{quote}
\begin{verbatim}
<html>
\end{verbatim}
\end{quote}
it generates the following command in the
\verb|qstring.lsp| file:
\begin{quote}
\begin{verbatim}
(princ "<html>\n")
\end{verbatim}
\end{quote}


When the femtolisp interpreter executes
the above line, it prints \verb|<html>|
as it should. The page of the example
reads the form content from the browser,
and passes it to
the lisp \verb|(os.getenv "QUERY_STRING")|
function. For instance, if the user
types {\em Nia Vardalos} in the text field
and presses the \menu{send} button,
the  \verb|(os.getenv "QUERY_STRING")| command
assigns:
\begin{quote}
\verb|temp=Nia+Vardalos&btn=send|
\end{quote}
to the \verb|str| variable.


If you enter the \verb|~/Femto-Emacs/femtolisp/|
folder, you will find a \verb|flisp|
interpreter that can be run independently
from the editor. This is the very same
femtolisp compiler that was sent to
the cloud service provider.

Let us assume that Nia has placed the
\verb|webscript.scm| generator of
listing~\ref{lst:webscript.scm}
as well as the pattern of
listing~\ref{lst:qstring.script}
into the \verb|~/femtodocs/samples/| folder.
Then she can start femtolisp thus:
\begin{verbatim}
~/femtodocs/samples$ ~/Femto-Emacs/femtolisp/flisp
\end{verbatim}

\paragraph{Lisp REPL.} Traditionally, the lisp
interaction with the user is called Read Eval
Print Loop or REPL for short. The reason is that
Lisp reads an expression, evals it, prints the
result, and loops back for the next expression.

\begin{Verbatim}[fontsize=\small,
frame=single,
framerule=0.5mm]
~/femtodocs/samples$ rlwrap ~/Femto-Emacs/femtolisp/flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|------------------------

> (load ``webscript.scm'')

> (copyFile ``qstring.script'' ``qstring.lsp'')
#t

> (exit)
~/femtodocs/samples$ scp -P2222 qstring.lsp nia@medicina.tips:~/
\end{Verbatim}

\section{Installing a script}
Most servers and cloud services run on Linux.
Therefore, you cannot compile femtolisp in
your Macintosh or Windows machine and expect it
to work in the cloud. Therefore, find a local
Linux machine to build the \verb|flisp| executable.
After taking care to avoid these compatibility
problems, Nia entered her cloud machine to
configure the script.\index{Shell!chmod a+x}
\begin{Verbatim}[fontsize=\small,
frame=single,
framerule=0.5mm]
~/femtodocs/samples$ ssh -p2222 strue028@medicina.tips
strue028@medicina.tips's password:
Last login: Sun Sep 25 22:38:25 2016 from 179.155.71.6
[~]# cd public_html
[~/public_html]# cd lsp
[~/public_html/lsp]# cp ~/qstring.lsp .
[~/public_html/lsp]# chmod a+x qstring.lsp
\end{Verbatim}

By the way, the example is in French to show
that femtolisp deals with chars used in
weird languages.

\section{The GNU Readline Library}
Using flisp from the command line can be frustrating.
When you type something, and spot a mistake at the
beginning of the line, you cannot use the
\keys{$\leftarrow$} left arrow key to move
the cursor to the place where you want to
insert the correction. 


The bottom line is this, you could
run the \verb|flisp| compiler directly
from the shell, but since it does not
have an editor, it is very unconfortable.
Therefore, it is advisable to install
a wrap around the GNU Readline Library.
The most popular of such wraps
is the \verb|rlwrap| line editor.


\begin{Verbatim}[fontsize=\small,
frame=single,
framerule=0.5mm]
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|------------------------

> (load ``webscript.scm'')

> (copyFile ``qstring.script'' ``qstring.lsp'')
#t

> (exit)
~/femtodocs/samples$ scp -P2222 qstring.lsp nia@medicina.tips:~/
\end{Verbatim}


To install the \verb|rlwrap| editor
on the Macintosh, you can use the
homebrew package manager.
\begin{quote}
\begin{verbatim}
~/Femto-Emacs/femtolisp$ brew reinstall rlwrap
\end{verbatim}
\end{quote}
On Linux, launch the \verb|apt-get|
manager to install the line editor.
\begin{quote}
\begin{verbatim}
~/Femto-Emacs/femtolisp$ apt-get install rlwrap
\end{verbatim}
\end{quote}


\chapter{Bugs}
\index{Bugs}
It is possible to divide computer errors into three groups:
\begin{enumerate}
\item Syntax errors. Code or data
do not obey the grammar rules of the language
chosen for writing the program.
\item Type errors. The arguments of a function
are not of the right type.
\item Specification errors. The code works,
but fails to carry out its original specification.
The client does not get what he paid for.
\end{enumerate}

In Lisp, forgetting to close parentheses is
about the only way to commit a syntax error.
After all, the Cambridge prefix notation
can be resumed in nested lists.
An example will help you to understand what
a type error is. The factorial of  \verb|n|
is the product of all integers between \verb|1| and \verb|n|.
For instance, the factorial of 5 is given
by $1\times 2\times 3\times 4\times 5$.
Let us build a table for the first eight
entries of the factorial function.\\

\noindent
\begin{tabular}{p{1.5cm} p{3cm} | p{1.5cm} p{3cm} | p{1.5cm} p{3cm}}
0 & 1 & 2 & 2 & 4 & 24\\
1 & 1 & 3 & 6 & 5 & 120\\
\end{tabular}

\verb||\\
If you take a careful look at this table,
you will note that it has an interesting
property: The factorial of $n$ is equal
to $n\times \textrm{factorial}(n-1)$. Then,
the factorial of 5 is equal
to $5\times \textrm{factorial}(4)$. This property is
used in the definition
of the factorial function given in listing~\ref{funcs/fact}.
\begin{figure}[!h]
\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
(define (fac n (i 1) (f 1) (next-f (* i f)))
(if (>= i n) next-f
 (fac n (+ i 1) next-f) ))
\end{verbatim}
\end{fmpage}
\caption{Factorial function}
\label{funcs/fact}
\end{figure}

\verb||\\
\verb||\\
The domain of the \verb|factorial| function is $\mathbb{Z}$.
In femtolisp, the $\mathbb{Z}$ set is approximated
by the \verb|integer| type, for which the elements
must lie in the interval from \verb|-9223372036854775808|
to \verb|9223372036854775807|.

If the result of \verb|(fac n)| is greater
than  \verb|9223372036854775807|,
femtolisp will produce garbage.
For instance, \verb|(fac 20)| produces the
correct result: \verb|2432902008176640000|.
However \verb|(fac 21)| returns a meaningless
sequence of digits.
An interesting question is: How to know
whether \verb|(fac 20)| produces a correct
result? Well, you must design clever tests.
For instance, the expression
\verb|(quotient (fib n) (fib (- n 1))|
must return \verb|n|. If it does not,
the computer is generating garbage.

Since the
expression \verb|(= (quotient (fib n) (fib (- n 1))) n)|
is true for all values of the \verb|n| variable,
it is called {\em invariant} by people
who investigate methods for the writing of correct
programs.

\begin{figure}[!h]
\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
(define (fact n (i 1) (f 1) (next-f (* i f)))
(assert (= (quotient next-f f) i))
(if (>= i n) next-f
 (fact n (+ i 1) next-f) ))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\linewidth}
\begin{verbatim}
> (load "factorial.scm")
#<function>
> (fact 15)
1307674368000
> (fact 21)
(assert-failed (= (quotient next-f f) i))
\end{verbatim}
\end{fmpage}
\caption{Factorial function}
\label{loop-invariant/fact}
\end{figure}

In order to avoid specification errors,
it is necessary to use logical statements
to write a contract between the computer
engineer and the client. The contract has
three assertions:
\begin{enumerate}
\item A precondition that must be true
of the parameters for calling the contracted function.
\item A postcondition that is true after running
the evaluator. The result returned by the
contracted function must be what the client desires.
\item An invariant that is
true before and after the execution of the code.  
The \verb|(assert (= (quotient next-f f) i))|
expression interrupts the computation if
the invariant ever becomes false, which
means that there is an error in the program.
\end{enumerate}


\section{Bugs}
%The term bug  means an error or flaw in a program.
\begin{wrapfigure}[10]{i}{7cm}
\includegraphics[scale=0.5]{fig-sets/bugcerto.png}
\end{wrapfigure}
The first computer was\index{Konrad Zuse!Ursula Walk} 
constructed\index{Konrad Zuse!first computer}
by Konrad Zuse,\index{Zuse}\index{Konrad Zuse}
a German civil engineer, and his assistant,
Ms. Ursula Walk,\index{Ursula Hebekeuser} née Hebekeuser.
The first computers, like those of Zuse and Walk,
were based on relays.\index{Konrad Zuse!relays}
These are
bulky electrical devices, typically incorporating
an electromagnet, which is activated by a current
in one circuit to turn on or off another circuit.
Computers made of such a contrivance were enormous,
slow, and unreliable. Therefore, on September 9th, 1945,
a moth flew into one of the relays of the Harvard  Mark II
computer and jammed it. From that time on,   {\em bug}
became the standard word to indicate
an error that prevents a computer from working as intended.

Due to bugs, compilers of languages like Clean
and Haskell frequently return error messages,
instead of generating code and running the
corresponding programs. The Steel Bank Common Lisp language
does not interrupt code generation when the
compiler spots a bug, all the same
it does issue warnings
that help find the problem before the embarassment
of failure being manifest on the client's terminal.
Femtolisp does not possess such a kind of oracular
compiler. It report errors only when you execute
the code.


\section{Missing parenthesis}\index{Bugs!missing parenthesis}
There is only one kind of bug that femtolisp
reports at compile
time: missing parenthesis.
This bug  is annoying, because the compiler
does not  report its position accurately.
For example, try to compile the code of Listing~\ref{missing-semiColon}.
The compiler issues the
following error message:
\begin{quote}
(load-error fvalue.scm (parse-error read: unexpected end of input))
\end{quote}
The error is on line 4, where a right parenthesis is missing.
Nevertheless, the compiler does not give the smallest
hint on where the problem is. Furthermore, the
error message is misleading,
as it does not mention the parenthesis.
It simply complains about an unexpected end of input.

Whenever you receive a message
of `unexpected end of input', my advice is to
look for a missing parenthesis.
However, checking parentheses by hand over a large file is
time consuming and boring. Is it possible
to write a new loader with error messages
that are more helpful? The answer to this
question is yes! In fact, it is very easy
to customize Lisp.

\begin{figure}[!h]\index{define}
\begin{fmpage}{0.8\textwidth}
\begin{verbatim}
;; File: fvalue.scm

(define  (future-value pv i n)
(* (expt (+ (/ i 100.0 1) n) 
   pv))
);;end define

(define (fat n)
(if (< n 1) 1
 (* (fat (- n 1)) n)))

(define (fn+1 n fn fn-1)
(if (< n 2) fn
 (fn+1 (- n 1
       (+ fn fn-1) fn)))

(define (quick xs)
(if (null? xs) xs
(append
    (quick (filter (lambda(x) (< x (car xs)))
                   (cdr xs)))
    (list (car xs))
    (quick (filter (lambda(x) (>= x (car xs)))
                   (cdr xs))) )))

#|This loader fails at definition 3|#
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.8\textwidth}
\verb|(load "manydefs.scm")|\keys{Enter}\\
\verb|(load-error manydefs.scm |\\
\verb|   (parse-error read: unexpected end of input))|\\
\end{fmpage}
\caption{Future Value Program}
\label{missing-semiColon}
\end{figure}

Listing~\ref{error-position} shows a loader
that informs which expression has an unmatched
parenthesis. Besides this, if you add postcondition
expressions to the source file, the program
will also report specification errors.
For example, in listing~\ref{debug-ready-source},
if the postcondition
\verb|(assert (= (fn+1 5) 8))| fails,
the \verb|load-definition| command will
inform which assertion did not meet
the specifications. Here one has an
example of a specification error. 
For the definition
$f= \lambda(n) (n<2) ? 1 : f(n-1)+f(n-2)$,
one has that $f(5)= 5$. On  the other hand, 
$f=\lambda(n) (n<2) ? 1 : f(n-1)+f(n-2)$
produces $f(5)= 8$.
Both alternatives are correct, but the postcondition
shows that the client wants the second.
Now that you know the
effects, let us see how to perform the magic.

\begin{figure}[!h]\index{Error!Position}
\begin{fmpage}{0.9\textwidth}
\begin{verbatim}
;; File: loader.scm

(define (rd i out)
(trycatch (read out) 
  (lambda(x) (insert "#") (insert "|")
     (insert "This loader failed at definition ")
     (insert (number->string i)) (insert "|#\n")) ))

(define (try-to-eval i sexpr)
(trycatch (eval sexpr)
   (lambda(x) (insert "#") (insert "|")
      (insert "Error in expression ")
      (insert (number->string i))
      (insert "|#\n")) ))

(define (eval-them out)
(let loop ( (i 1) (sexpr (rd 1 out)))
   (cond ( (eof-object? sexpr) #t)
         ( else (try-to-eval i sexpr)
                (loop (+ i 1) (rd (+ i 1) out))) )))

(define (load-definitions source)
(call-with-input-file source eval-them))
\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\textwidth}
\verb|(load "loader.scm")|\keys{Enter}\\
\verb|#<function>|\\
\end{fmpage}
\caption{Reporting error position}
\label{error-position}
\end{figure}

In listing~\ref{error-position},
a \verb|(trycatch sexpr (lambda(x) ...))|
tries to evaluate a Lisp \verb|sexpr|.
If the evaluation
ends with success, \verb|trycatch|
returns the value of the \verb|sexpr|.
Otherwise,\index{trycatch}
\verb|trycatch| executes its second
argument, which reports the error.

In listing~\ref{error-position},
the \verb|trycatch| form is used on
two occasions. In the \verb|(rd i out)|
definition, \verb|trycatch| reports
unmatched parentheses.

In \verb|(try-to-eval i sexpr)|,
\verb|trycatch| will report runtime
errors. Since femtolisp defers
error reporting to runtime, it is
advisable to add \verb|(assert P)|
postconditions to the code, in
order to detect specification
errors.

The \verb|(eval sexpr)|\index{eval} function-call
evaluates a Lisp expression. Therefore,
if one executes the \verb|(eval '(* 2 21))|,
s/he  will get 42.

\begin{figure}[!h]\index{define}
\begin{fmpage}{0.9\textwidth}
\begin{verbatim}
;; File: fvalue.scm

(define  (future-value pv i n)
(* (expt (+ (/ i 100.0 1) n) 
   pv))
);;end define

(define (fat n)
(if (< n 1) 1
 (* (fat (- n 1)) n)))

(define (fn+1 n (fn 1) (fn-1 1))
(if (< n 2) fn
 (fn+1 (- n 1)
       (+ fn fn-1) fn ) ))

(assert (= (fn+1 5) 8))

(define (quick xs)
(if (null? xs) xs
 (append (quick (filter (lambda(x) (< x (car xs))) 
                (cdr xs)))
         (list (car xs))
         (quick (filter (lambda(x) (>= x (car xs)))
                (cdr xs))) )))


\end{verbatim}
\end{fmpage}

\begin{fmpage}{0.9\textwidth}
\verb|(load-definitions "manydefs.scm")|\keys{Enter}\\
\verb|#<function>|
\end{fmpage}
\caption{Checking for specification errors}
\label{debug-ready-source}
\end{figure}



\chapter{Finite Automaton}
\index{Finite automata}\label{chap:finite-automaton}
A deterministic finite automaton
is a finite state machine that accepts or rejects
finite strings of chars and only produces
a unique computation  for each input string.
Figure~\ref{fig:automaton} below illustrates a deterministic
finite automaton using a state diagram.
The aforementioned automaton recognizes words
and puctuation marks from a text using
the Roman alphabet, which is the same
as in English. Therefore,
this automaton can  accept a
stream of words and punctuation from an English text.

\begin{figure}[!h]
\renewcommand\figurename{Fig.}
\begin{tikzpicture}[>=stealth',shorten >=1pt,on grid,
                   auto,node distance=3cm]
\node[initial,state,accepting] (S)      {$S$};
\node[state]         (q0) [right of=S]  {$skp$};
\node[state]         (q1) [right of=q0]  {$q_1$};
\node[state]         (q3) [right of=q1] {$q_2$};
\node[state]         (r0) [below of= S] {$\rightarrow n$};
\node[state]         (q2) [below of=q1] {$\rightarrow n$};

\path[->] (S)  edge  (q0)
(q0) edge [->] node {\small else} (q1)
(q1) edge [bend right] node {.,:?!} (q2)
(q0) edge [loop above] node {blank} (q0)
(q3) edge [bend left=60] node {\small else} (q2)
(q1) edge [->,bend left] node {else} (q3)
(q1) edge [] node {""} (r0);
\path[->]
(q3) edge [loop right] node {a-z} (q3);
\end{tikzpicture}
\caption{Finite automaton that recognizes English words}
\label{fig:automaton}
\end{figure}

In the automaton of figure~\ref{fig:automaton}, there
are three states: $skp$, $q_1$ and $q_2$.
The automaton remains in the state $skp$ as long as
the stream produces blank chars, i. e., \verb|#\space|,
\verb|#\newline| or \verb|#\tab|. If the computation
reaches the end of the string, the automaton  stops.
If a punctuation mark appears
in the stream, the automaton accepts it, and 
returns $\rightarrow n$. If the  $q_1$ state
receives an alphabetical letter, the automaton
goes to state $q_2$ and remains there 
as long as the reader keeps feeding letters.
\index{String!string.find}
\index{String!strings-ref}
\index{String!string-length}
\index{String!string}


\begin{figure}[!h]
\begin{fmpage}{0.9\linewidth}
\begin{verbatim}
(define (end? s n) (<= (string-length s) n))

(define (pct? s n) (string.find ".,?" (string-ref s n)))

(define (blk? s n) (string.find " \n" (string-ref s n)))

(define (letter? s n)
  (and (not (pct? s n)) (not (blk? s n)) ))

(define (skp n s)
   (if (or (end? s n) (not (blk? s n))) n
      (skp (+ n 1) s)))

(define (q1 n s)
   (cond ( (end? s n) n)
         ( (pct? s n) (+ n 1) )
         (else (q3 n s)) ))

(define (q3 n s )
   (cond ( (end? s n) n)
         ( (letter?  s n) (q3 (+ n 1) s))
         (else  n)))

(define (tkz s (n 0) (i (skp n s)) (j (q1 i s)))
  (cond ( (end? s i) '())
          ( (end? s j) (list (substring s i j)))
          (else (cons (substring s i j) (tkz s j)) ) ))
\end{verbatim}
\end{fmpage}
\caption{Finite Automaton in Scheme}
\label{FA-in-Scheme}
\end{figure}

\begin{verbatim}
~/Femto-Emacs/femtolisp$ rlwrap ./flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|--------------------------

> (begin (load "aliases.scm") (load "auto-one.scm")
     (tkz "She walks in beauty, like the night."))
("She" "walks" "in" "beauty" "," "like" "the" "night" ".")
\end{verbatim}


\appendix

\chapter{Femtolisp cheat sheet}

\paragraph{Equality predicates.}
All lisp dialects provide a plethora
of predicates for testing the  equality
between two objects. Let us perform a few tests
to discover the difference between these
many predicates.\index{Predicates!eqv?}

\begin{Verbatim}[fontsize=\small,
frame=single]
~/Femto-Emacs/femtolisp$ rlwrap ./flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|----------------

> (eq? 4.5 (/ 9.0 2))
#f
> (eqv? 4.5 (/ 9.0 2))
#t
> (eq? 'Carmen 'Carmen)
#t
> (eq? 'Carmen (car '(Carmen Micaela)))
#t
> (equal? 4.5 (/ 9.0 2))
#t
> (= 4.5 (/ 9.0 2))
#t
> (= 'Carmen (car '(Carmen Micaela)))
type error: =: expected number, got Carmen
\end{Verbatim}
As a general rule, the \verb|(equal? x y)| 
is true when both \verb|x| and \verb|y|
objects have the same printed
representation. The predicate \verb|(= x y)| seems to work
for numbers only. The predicate \verb|(eq? x y)|
checks whether \verb|x| is the same object as \verb|y|.
Finally, \verb|(eqv? x y)| returns \verb|#t| when
\verb|x| is equivalent to \verb|y|, whatever this
may mean.

\paragraph{Comparing things.}
Predicates such as \verb|(> x y)|,
\verb|(>= x y)|, \verb|(< x y)| and \verb|(<= x y)|
work for objects of any type.

\begin{Verbatim}[fontsize=\small,
frame=single]
~/Femto-Emacs/femtolisp$ rlwrap ./flisp
> (> 4 3)
#t
> (> "zebra"  "horse")
#t
> (>= "abc"  "abc")
#t
> (<  "abc"  "abc")
#f
> (<= "abc" "abc")
#t
\end{Verbatim}

\paragraph{Arithmetic operations.} The numerical functions
shown below can have any number of arguments.
\begin{itemize}
\item Multiplication -- $\verb|(* |\;x_1\; x_2\; x_3\ldots x_n\verb|)|$
\item Addition -- $\verb|(+ |\;x_1\; x_2\; x_3\ldots x_n\verb|)|$
\item Subtraction -- $\verb|(- |\;x_1\; x_2\; x_3\ldots x_n\verb|)|$
\item Division -- $\verb|(/ |\;x_1\; x_2\; x_3\ldots x_n\verb|)|$
\end{itemize}
Operations such as \verb|(div0 53 5)| and \verb|(mod0 53 5)|
calculate the quotient and remainder of the integer
division respectively. 

Arithmetic operations can
be nested as necessary, i.e., one
 can be placed inside the other.
In order to get a better understanding
of this idea, study the examples below.
\begin{Verbatim}[fontsize=\small,
frame=single]
> (div0 53 5)
10
> (mod0 53 5)
3
> (+ (* 3 4 5) (/ 3.1416 8))
60.3927
> (define (c2f x) (- (/ (* (+ x 40) 9) 5.0) 40))
#fn(``7000r1|bXwb9T2c0U2bXx;'' [5.0] c2f)
> (c2f 100)
212.0
\end{Verbatim}

\paragraph{File operations.}
You have already learned the very basic
file operations in chapter~\ref{cloud-computing},
page~\pageref{cloud-computing}.\\

\index{princ}

\begin{figure}[!h]
\begin{fmpage}{0.95\textwidth}
\begin{verbatim}
~/femtodocs/samples$ rlwrap ~/Femto-Emacs/femtolisp/flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|---------------
> (let ( (s (file "f.txt" :write :create)))
     (with-output-to s
        (princ '(She walks in beauty))
        (io.close s)))
#t
> (let ( (s (file "f.txt" :read)))
     (with-input-from s
        (prog1 (read)
            (io.close s)) ))
(She walks in beauty)
> (let ( (s (file "f.txt" :read)))
      (with-input-from s
          (read)
          (io.close s)))
#t
> (let* ( (s (file "f.txt" :read))
      (expression (read s)) )
      (io.close s) expression)
(She walks in beauty)
\end{verbatim}
\end{fmpage}
\caption{Basic IO}
\label{basicio}
\end{figure}

\verb||\\
In the above example, all reading
operations retrieve data from the \verb|s1| stream.
The {\small \verb|(prog1 (read) (io.close s1)|}
sequence reads an expression from the \verb|s1|
stream, and closes the stream. The return
value of the \verb|prog1| sequence is given by its
first expression, i.e., \verb|(read)|.

In order to better understand the
necessity of the prog1 sequencer,
the last expression of listing~\ref{basicio}
shows what happens if one simply reads
an expression and closes the stream:
The result would be \verb|#t|, which
would report that the stream was closed 
successfully, but is not what you want.
Of course, \verb|let*| can produce
the same effect as the \verb|prog1| sequencer.

The \verb|copyFile| procedure copies
the \verb|inF| file into the \verb|outF| file.
It calls \verb|(rdprt)| that reads
each \verb|x| line from the \verb|in| stream
and prints it into the \verb|out| stream
until the \verb|(eof-object? x)| predicate
becomes true. When the file descriptor
reaches the end of a file, any reading
operation returns an end-of-file object,
which makes the \verb|(eof-object? x)| predicate
return true.\index{Output to file!(file fname :write :append)} 
\index{Input from file!(file inF :read)}
\index{Input from file!with-input-from}
\index{Output to file!(io.putc *output-stream* x)}
\index{princ}
\index{Predicates!eof-object?}
\begin{figure}[!h]
\begin{fmpage}{0.95\textwidth}
\begin{verbatim}
(define (opn fname)
  (trycatch (file fname :write :append)
       (lambda(x) (file fname :write create)) ))

(define (into fname expr (s (opn fname)))
  (with-output-to s  (write expr) (newline) (io.close s)))

(define (readLn) (io.readline *input-stream*))

(define (rdprt)
  (let loop ( (x (readLn)))
    (cond ( (eof-object? x) #t)
          (else (princ x)
                (loop (readLn)) )) ))

(define (copyFile inF outF)
  (let ( (in (file inF :read))
       (out (file outF :write :create)) )
    (with-output-to out
       (with-input-from in  (rdprt)))
         (io.close in)
         (io.close out)))

(define (prtFile nm (in (file nm :read)))
   (let loop ( (x (io.getc in)))
      (when (not (eof-object? x))
          (io.putc *output-stream* x) (loop (io.getc in)) ))
      (io.close in))
\end{verbatim}
\end{fmpage}
\caption{fileio.scm -- File Input/Output}
\label{cpyFile}
\end{figure}


Let us test  listing \ref{cpyFile},
which is stored in the \verb|fileio.scm| file.
The \verb|(opn fname)| operation tries to
open a file for appending text. If the file
does not exist, \verb|(opn fname)| creates it.

The \verb|(rdprt)| procedure reads 
lines from a file and prints them into another file.
File descriptors are generated from file
names by the procedure: 
\begin{quote}
\verb|(copyFile inF outF)|
\end{quote}
When a file is read beyond
the last char, the result is an
end-of-file object, that is detected
by the \verb|(eof-object? x)| and
stops the read-print-loop in the
\verb|(rdprt)| procedure.
The \verb|(into fname expr)| procedure
inserts the \verb|expr| lisp expression
into the \verb|fname| file as 
one line of text.

\begin{verbatim}
~/femtodocs/samples$ rlwrap ~/Femto-Emacs/femtolisp/flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|---------------------

> (load "fileio.scm")
> (into "byron.txt" '(She walks in pretty))
#t

> (into "byron.txt" '(like the night))
#t

> (prtFile "byron.txt")
(She walks in pretty)
(like the night)
#f

> (copyFile "byron.txt" "byron2.txt")
#t

> (prtFile "byron2.txt")
(She walks in pretty)
(like the night)
#f
\end{verbatim}
The \verb|(prtFile nm)| procedure prints
a file char by char. In the named-let,
every time that the \verb|(io.getc in)|
procedure is called, the loop reads 
one char from the \verb|in|
stream. The \verb|(io.putc *output-stream* x)|
prints the \verb|x| char on the screen.
The  $\verb|(when | c\; x_1\;x_2\ldots x_n\verb|)|$ form
executes the $x_1$, $x_2$\ldots $x_n$ 
expressions,\index{Conditional execution!when}
when and only when the $c$ condition holds.
In the case of the \verb|(prtFile fname)|
procedure, the \verb|when|-form puts
the \verb|x| char into the \verb|*output-stream*|
and loops back to read and print the next char.

\paragraph{Random access.}
The \verb|wrtVector| procedure writes a datum
into the \verb|nm| file at a
random position given by the \verb|(* i sz)|
expression.

The \verb|rdVector| procedure reads
an expression from a \verb|(* i sz)|
random position of the \verb|nm| file.
The \verb|(clear nm i sz)| operation
completely fills the span of 
a node at \verb|(* i sz)| with
blank chars.\index{print}\index{read}
\index{Output to file!newline}

\begin{figure}[!h]
\begin{fmpage}{0.95\textwidth}
\begin{verbatim}
(define (opn fname)
   (trycatch (file fname :write :append)
       (lambda(err) (file fname :write :create)) ))

(define (clear nm i sz (out (opn nm)))
   (io.seek out (* i sz))
   (let sweep ((j sz))
       (when (> j 0)
           (io.putc out #\space)
           (sweep (- j 1)) ))
           (io.close out))

(define (wrtVector nm datum i (sz 100))
   (clear nm i sz)
   (let ((out (trycatch (file nm :write :append)
                 (lambda(err) (file nm :write :create)) ) ))
      (with-output-to out
         (io.seek out (* i sz))
         (princ datum))
         (io.close out)))

(define (rdVector nm i (sz 100))
   (let ( (in (file nm :read)))
      (with-input-from in
          (io.seek in (* i sz))
          (print (read)))
      (io.close in)))
\end{verbatim}
\end{fmpage}
\caption{randomAccess.scm}
\label{randomAccess}
\end{figure}

The file is organized as a sequence
of nodes, where each node has a fixed
number of chars. In the examples,
there are 100 chars in a given node.
Node \verb|i| starts at the 
\verb|(* i sz)| position. For instance,
node 2 starts at the \verb|(* 2 100)|
position and ends at the \verb|(* 3 100)|
position.

To clean a node, the \verb|(io.seek out (* i sz))|
places the file descriptor at the first char
of the node, and sweeps across the node span.



Below, Nia tests   
listing~\ref{randomAccess}. 
Firstly, she loads the 
program. Then she inserts
snippets from one of Byron's
poems into nodes 0, 1, 2, 3 and 4.
Finally, she uses the \verb|rdVector|
procedure to retrieve the contents
of the nodes.


\begin{verbatim}
~/femtodocs/samples$ rlwrap ~/Femto-Emacs/femtolisp/flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|-----------------------------
> (load "randomAccess.scm")
#<function>
> (wrtVector "gordon.txt" '(She walks) 0)
#t
> (wrtVector "gordon.txt" '(in beauty) 1)
#t
> (wrtVector "gordon.txt" '(like the night) 2)
#t
> (wrtVector "gordon.txt" '(of cloudless climes) 3)
#t
> (rdVector "gordon.txt" 0)
(She walks)#t
> (rdVector "gordon.txt" 1)
(in beauty)#t
> (rdVector "gordon.txt" 2)
(like the night)#t
> (rdVector "gordon.txt" 3)
(of cloudless climes)#t
\end{verbatim}

\paragraph{Examples of execution.}
From this point on, the examples of
program execution will no longer
show how to start-up femtolisp, nor
the femtolisp header. The reader 
will know that s/he is dealing
with an example through the presence
of the \verb|>| prompt for the Read Eval Print Loop.
\begin{verbatim}
> (load "randomAccess.scm")
#fn(...)
> (wrtVector "gordon.txt" '(and starry skies) 4)
#t
> (rdVector "gordon.txt" 4)
(and starry skies)#t
\end{verbatim}

\paragraph{A file automaton.}
In listing~\ref{wordsFromFile},
the \verb|rdword| procedure reads the
contents of a file as a list of words. 
It is implemented as an
automaton. To learn what an automaton is,
reread chapter~\ref{chap:finite-automaton},
page~\pageref{chap:finite-automaton}.

To test listing~\ref{wordsFromFile}, let
us create a file with the first and
second line of one of the most
popular of Byron's poems:
\begin{quote}
She walks in beauty, like the night\\ 
Of cloudless climes and starry skies.
\end{quote}
Now, let us start-up femtolisp, load
the program, and read the words and
punctuation marks from the poem.
As soon a word is read, it is consed
onto the front of a list, and the automaton proceeds
to read the rest of the text.
\begin{verbatim}
~/femtodocs/samples $rlwrap ~/femtolisp/flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|-----------------

> (load "wordsFromFile.scm")
#<function>
> (rdList "words.txt")
("She" "walks" "in" "beauty" "," "like" 
"the" "night" "Of" "cloudless" "climes"
"and" "starry" "skies" ".")
\end{verbatim}

\index{Input from file!io.peekc}
\index{Input from file!io.getc}
The automaton of listing~\ref{wordsFromFile} 
is based on two procedures, \verb|(io.getc s)| and
\verb|(io.peekc s)|. The \verb|(io.getc s)|
reads a char from the \verb|s| stream,
and advances the file descriptor to the
next char. The \verb|(io.peekc s)| procedure
peeks at a char, but does not advance the
file descriptor.

Consider the third clause of
cond-form that appears in
the \verb|(word c s xs)| definition.
The clause peeks at the next
char in the stream, but does not 
advance the file descriptor. If the
char is the end-of-file object,
the automaton has finished working on the
file. Therefore, the clause reverses
the \verb|xs| accumulator and 
casts it into a string.

Why is it not possible to use \verb|io.getc|
to check the next character for
the end of file in the third clause? 
The short answer
is that in the case of clause 
failure, the char would not be 
available for next clause.
The long answer is that one
could use the \verb|io.getc|
procedure. However, 
the last clause should 
call the \verb|(begin (io.ungetc s) (io.getc s))|
sequence,
instead of the \verb|(io.getc s)| procedure.
This is necessary, in order
to restore the file descriptor 
that the \verb|(io.getc s)|
procedure advanced in the third clause.

The implementation of automata through
\verb|io.getc| and \verb|io.peekc| is
particularly useful in compiler construction.
I believe that the designer of femtolisp
has provided such a complete set of
char reading functions, because he
intended to use femtolisp in the
implementation of the Julia language.
%% By the way, if your job is numerical
%% calculations, I suggest serious 
%% consideration of the Julia language
%% relative merits over other solutions.

I hope that the above given
information will be sufficient for you to 
figure out how the automaton works.

\begin{figure}[!b]
\begin{verbatim}
(define (punctuation-mark? c)
    (not (not (string.find ".;:,?!()" c)) ))

(define (ignore-blank c s)
   (cond ( (eof-object? c) '())
         ( (or (eqv? c #\space) (eqv? c #\newline)) 
           (ignore-blank (io.getc s) s))
         ( (punctuation-mark? c)
           (cons (string c) 
                 (ignore-blank (io.getc s) s)))
         (else (word c s '()) ) )) 

(define (word c s xs)
   (cond ( (eof-object? c)
           (list (apply string (reverse xs))))
         ( (eqv? c #\space)
           (cons (apply string (reverse xs))
                 (ignore-blank (io.getc s) s)))
         ( (eof-object? (io.peekc s))
           (list (apply string (reverse (cons c xs)) ) ))
         ( (punctuation-mark? (io.peekc s))
           (cons (apply string (reverse (cons c xs)))
                 (ignore-blank (io.getc s) s)))
         ( (io.eof? s)
           (list (apply string (reverse xs))))
         (else (word (io.getc s) s (cons c xs)) ) ))

(define (rdList fname)
   (let ( (in (file fname :read)))
          (ignore-blank (io.getc in) in)))
\end{verbatim}
\caption{Reading words from a file}
\label{wordsFromFile}
\end{figure}


\paragraph{List processing.} As all
lisp dialects, femtolisp has a
plethora of list processing
functions. Below, the interested
reader will find a demonstration
of this kind of function.

\begin{verbatim}
~/femtodocs/samples$ rlwrap ~/Femto-Emacs/femtolisp/flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|--------------------------

> (member 4 '(3 5 4 8))
(4 8)
> (assoc "ed" '( ("paul" 42) ("ed" 12) ("ann" 5)))
("ed" 12)
> (list-tail '(a b c d e f) 2)
(c d e f)
> (list-head '(a b c d e f) 2)
(a b)
> (list-ref '(a b c d e f) 2)
c
> (length= '(a b c d e f) 6)
#t
> (length> '(a b c d e f) 3)
(d e f)
> (last-pair '(a b c d e f))
(f)
> (lastcdr '(a b c d e f))
()
> (map  (lambda(x) (* x x)) '(3 4 5))
(9 16 25)
> (filter (lambda(x) (> x 2)) '(3 4 5 6 2 1))
(3 4 5 6
> (separate (lambda(x) (> x 2)) '(3 4 5 6 2 1))
((*values*) (3 4 5 6) (2 1))
> (count (lambda(x) (> x 2)) '(3 4 5 6 2 1))
4
> (list 2 3 (* 5 8) 4 5)
(2 3 40 4 5)
> (list (random 6) (random 6) (random 6))
(0 5 1)
\end{verbatim}

\paragraph{String processing.} Let us
reimplement the finite automaton
of listing~\ref{FA-in-Scheme}, which
is written in the Scheme programming
language. However, this time let us
work with  femtolisp.
\index{String!string.char}
\index{String!string.sub}
\index{String!string.find}
\index{String!string.count}


\begin{figure}[!h]
\begin{fmpage}{0.9\textwidth}
\begin{verbatim}
(define (end-of-string? s n)
      (<= (string.count s) n))

(define (punctuation-mark? c)
    (not (not (string.find ".;:,?!()=&" c))))

(define (char-whitespace? c)
   (not (not (string.find "\n " c))))

(define (ignore-blank n s)
   (cond ( (end-of-string? s n) '()) 
         ( (char-whitespace? (string.char s n))
           (ignore-blank (+ n 1) s))
         ( (punctuation-mark?  (string.char s n) )
           (cons (string.sub s n (+ n 1))
                 (ignore-blank (+ n 1) s)))
         (else (word n (+ n 1) s)) ))

(define (word i j s)
   (cond ( (end-of-string? s j)
           (list (string.sub s i j)))
         ( (char-whitespace? (string.char s j))
           (cons (string.sub s i j)
           (ignore-blank j s)))
         ( (punctuation-mark? (string.char s j))
           (cons (string.sub s i j)
                 (ignore-blank j s)))
         (else (word i (+ j 1) s)) ))
\end{verbatim}
\end{fmpage}
\caption{Deterministic Finite Automaton}
\label{DFA}
\end{figure}

There are many advantages to working
with femtolisp, instead of Scheme.
Since femtolisp is of recent design,
it does not need to maintain backward
compatibility, and is slightly more
expressive. Besides this, the
femtolisp compiler  needs
to load the \verb|r5rs.scm| library
that translates Scheme instructions
to femtolisp. This kind of translation
is never perfect, and the code may not
be as efficient as pure femtolisp.

On the other hand,  Scheme has a important
leverage point -- The best computer language
books are written with Scheme in mind: 
The Structure and Interpretation of Programs, 
The Little Schemer,
Practical Scheme,
The Scheme Programming Language,  etc.
As for femtolisp, this tutorial that you
are reading is about the only documentation
available.

\index{String!string.reverse}
\index{String!string.number}
\index{String!string to number}
\index{Char!char.upcase}
\index{Char!char.downcase}


\begin{verbatim}
~/Femto-Emacs/femtolisp$ rlwrap ./flisp
;  _
; |_ _ _ |_ _ |  . _ _
; | (-||||_(_)|__|_)|_)
;-------------------|----------------

> (load "webmaton.lsp")
#<function>
> (ignore-blank 0 "She walks in beauty, like the night.")
("She" "walks" "in" "beauty" "," "like" "the" "night" ".")
> (string 65 66 67)
"656667"
> (string #\a #\b #\c)
"abc"
> (apply string '(#\a #\b #\c))
"abc"
> (string.count "She walks in beauty")
19
> (string.find ",;.?&" #\?)
3
> (string.char "abcd" 2)
#\c
> (string.reverse "abc")
"cba"
> (string->number "42.0")
42.0
> (number->string  42.0)
"42"
> (char.upcase #\é)
#\É
> (char.downcase #\B)
#\b
> (aref (string #\a) 0)
97
\end{verbatim}

\paragraph{Higher order functions.}
A higher-order function, also known as
functional form, is an operation that
exhibits one of the following features:
\begin{itemize}
  \item can take a function as argument or
  \item returns a function as the result.
\end{itemize}

\index{List!foldl, foldr}
The \verb|foldl| functional form applies
a two argument operation between the
elements of a list. For instance,
\verb|(foldl * 1 '(2 3 4 5))| performs
the calculation \verb|2*3*4*5*1|.
The name \verb|foldl| is short for
{\em fold left}, and comes from the
fact that this functional form applies
the folding function from left to right.
There is also a \verb|foldr| functional
form, that accumulates results from
 right to left.\\
 
\begin{fmpage}{0.9\textwidth}
\begin{verbatim}
;; average.lsp

(define (avg xs)
  (/  (foldl + 0.0 xs)
      (foldl (lambda(x y) (+ 1 x)) 0.0 xs)))
\end{verbatim}
\end{fmpage}
\begin{verbatim}
> (load "average.lsp")
#fn(...)
> (foldl * 1 '(2 3 4 5))
120
> (foldr * 1 '(2 3 4 5))
120
\end{verbatim}

\paragraph{Hash table.}
A hash table is a data structure that can map keys to values. 
It uses a hash function to compute an index 
into an array of buckets, from which the desired
value can be found.
\begin{verbatim}

> (define tbl (table))
#table()
> (put! tbl 'nero 'germanicus@rome.gov)
#table(nero germanicus@rome.gov)
> (put! tbl 'napoleon 'emperor@france.gov)
#table(nero germanicus@rome.gov  napoleon emperor@france.gov)
> (get tbl 'nero)
germanicus@rome.gov
\end{verbatim}

\paragraph{List map functions.} A map operation can
apply a function to the elements of one or more lists.
The examples below show how it works.
\index{List!map}


\begin{verbatim}
> (map (lambda(x y) (* x y)) '(2 3 4) '(5 6 7))
(10 18 28)
> (map (lambda(x) (* x x)) '(2 3 4))
(4 9 16)
\end{verbatim}

\paragraph{Memory streams.} The easiest way to build a
string from scratch is to apply print functions 
to a buffer, then cast this buffer to the desired
string.\index{Output to buffer}
\index{Output to buffer!(buffer)}
\index{Output to buffer!io.tostring!}

\begin{verbatim}
(define (prefix? p s i (cnt (string.count p)))
  (if (< (string.count s) (+ cnt i)) #f 
     (let loop ( (k 0) )
       (cond ( (>= k cnt) #t)
             ( (= (aref p k) (aref s (+ i k)) )
               (loop (+ k 1)))
             (else #f)) ) ))
            
(define (fixdiacritics s (n (string.count s)))
  (let loop ((b (buffer)) (i 0))
    (cond ( (>= i n) (io.tostring! b))
          ( (prefix? "%C3%BA" s i)
             (io.putc b #\ú) (loop b (+ i 6)))
          ( (prefix? "%C3%A9" s i)
            (io.putc b #\é) (loop b (+ i 6)))
          (else (io.putc b (string.char s i))
                (loop b (+ i 1))  ))  ))
\end{verbatim}
Web protocol substitutes code snippets for
diacritical letters. The above program
restores the diacritics.

\begin{verbatim}
> (load "diac.lsp")
#<function>
> (fixdiacritics "J%C3%BAlia")
"Júlia"
\end{verbatim}
\begin{thebibliography}{99}


\bibitem{Abelson} Harold Abelson, Gerald Jay Sussman and
Julie Sussman. Structure and Interpretation of
Computer Programs. The MIT Press, Second Edition, 1996.

\bibitem{Felleisen} Matthias Felleisen,
Robert Bruce Findler, Matthew Flatt, Shriram Krishnamurthi.
How to Design Programs.
Available from \verb|http://www.htdp.org|

\bibitem{Sitaram} Dorai Sitaram. Teach yourself Scheme
in Fixnum Days. Available
from \verb|http://ds26gte.github.io/tyscheme/|

\bibitem{Hoyte} Doug Hoyte. Let Over Lambda. Hoytech, 2008. ISBN: 978-1-4357-1275-1

\bibitem{Church1932} A. Church, A set of postulates for the foundation of logic, Annals of Mathematics, Series 2, 33:346–366 (1932).

\bibitem{Church} Alonzo Church. The Calculi of Lambda Conversion. Princepton University Press, 1986.

\bibitem{Dybvig} R. Kent Dybvig. The Scheme Programming Language.
Available from \verb|http://www.scheme.com/tspl4/|

\end{thebibliography}

\printindex

\end{document}

